<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Introduction to Data Science</title>
  <meta name="description" content="This book introduces concepts and skills that can help you tackle real-world data analysis challenges. It covers concepts from probability, statistical inference, linear regression and machine learning and helps you develop skills such as R programming, data wrangling with dplyr, data visualization with ggplot2, file organization with UNIX/Linux shell, version control with GitHub, and reproducible document preparation with R markdown.">
  <meta name="generator" content="bookdown 0.5 and GitBook 2.6.7">

  <meta property="og:title" content="Introduction to Data Science" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="This book introduces concepts and skills that can help you tackle real-world data analysis challenges. It covers concepts from probability, statistical inference, linear regression and machine learning and helps you develop skills such as R programming, data wrangling with dplyr, data visualization with ggplot2, file organization with UNIX/Linux shell, version control with GitHub, and reproducible document preparation with R markdown." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Introduction to Data Science" />
  
  <meta name="twitter:description" content="This book introduces concepts and skills that can help you tackle real-world data analysis challenges. It covers concepts from probability, statistical inference, linear regression and machine learning and helps you develop skills such as R programming, data wrangling with dplyr, data visualization with ggplot2, file organization with UNIX/Linux shell, version control with GitHub, and reproducible document preparation with R markdown." />
  

<meta name="author" content="Rafael A. Irizarry">


<meta name="date" content="2017-11-05">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="r-basics.html">

<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />









<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Introduction to Data Science</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Introduction</a><ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#case-studies"><i class="fa fa-check"></i>Case Studies</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#who-will-find-this-book-useful"><i class="fa fa-check"></i>Who Will Find This Book Useful?</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#what-does-this-book-cover"><i class="fa fa-check"></i>What Does This Book Cover?</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#what-is-not-covered-by-this-book"><i class="fa fa-check"></i>What is Not Covered by This Book?</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="r-basics.html"><a href="r-basics.html"><i class="fa fa-check"></i><b>1</b> R Basics</a><ul>
<li class="chapter" data-level="1.1" data-path="r-basics.html"><a href="r-basics.html#motivating-case-study"><i class="fa fa-check"></i><b>1.1</b> Motivating Case Study</a></li>
<li class="chapter" data-level="1.2" data-path="r-basics.html"><a href="r-basics.html#why-r"><i class="fa fa-check"></i><b>1.2</b> Why R?</a></li>
<li class="chapter" data-level="1.3" data-path="r-basics.html"><a href="r-basics.html#getting-started"><i class="fa fa-check"></i><b>1.3</b> Getting Started</a><ul>
<li class="chapter" data-level="1.3.1" data-path="r-basics.html"><a href="r-basics.html#installing-r"><i class="fa fa-check"></i><b>1.3.1</b> Installing R</a></li>
<li class="chapter" data-level="1.3.2" data-path="r-basics.html"><a href="r-basics.html#the-r-console"><i class="fa fa-check"></i><b>1.3.2</b> The R console</a></li>
<li class="chapter" data-level="1.3.3" data-path="r-basics.html"><a href="r-basics.html#scripts"><i class="fa fa-check"></i><b>1.3.3</b> Scripts</a></li>
<li class="chapter" data-level="1.3.4" data-path="r-basics.html"><a href="r-basics.html#installing-rstudio"><i class="fa fa-check"></i><b>1.3.4</b> Installing RStudio</a></li>
</ul></li>
<li class="chapter" data-level="1.4" data-path="r-basics.html"><a href="r-basics.html#the-r-ecosystem"><i class="fa fa-check"></i><b>1.4</b> The R ecosystem</a></li>
<li class="chapter" data-level="1.5" data-path="r-basics.html"><a href="r-basics.html#the-very-basics"><i class="fa fa-check"></i><b>1.5</b> The Very Basics</a><ul>
<li class="chapter" data-level="1.5.1" data-path="r-basics.html"><a href="r-basics.html#objects"><i class="fa fa-check"></i><b>1.5.1</b> Objects</a></li>
<li class="chapter" data-level="1.5.2" data-path="r-basics.html"><a href="r-basics.html#the-workspace"><i class="fa fa-check"></i><b>1.5.2</b> The Workspace</a></li>
<li class="chapter" data-level="1.5.3" data-path="r-basics.html"><a href="r-basics.html#functions"><i class="fa fa-check"></i><b>1.5.3</b> Functions</a></li>
<li class="chapter" data-level="1.5.4" data-path="r-basics.html"><a href="r-basics.html#other-prebuilt-objects"><i class="fa fa-check"></i><b>1.5.4</b> Other prebuilt objects</a></li>
<li class="chapter" data-level="1.5.5" data-path="r-basics.html"><a href="r-basics.html#variable-names"><i class="fa fa-check"></i><b>1.5.5</b> Variable names</a></li>
<li class="chapter" data-level="1.5.6" data-path="r-basics.html"><a href="r-basics.html#saving-your-workspace"><i class="fa fa-check"></i><b>1.5.6</b> Saving your workspace</a></li>
<li class="chapter" data-level="1.5.7" data-path="r-basics.html"><a href="r-basics.html#scripts-1"><i class="fa fa-check"></i><b>1.5.7</b> Scripts</a></li>
<li class="chapter" data-level="1.5.8" data-path="r-basics.html"><a href="r-basics.html#comments"><i class="fa fa-check"></i><b>1.5.8</b> Comments</a></li>
<li class="chapter" data-level="" data-path="r-basics.html"><a href="r-basics.html#exercises"><i class="fa fa-check"></i>Exercises</a></li>
</ul></li>
<li class="chapter" data-level="1.6" data-path="r-basics.html"><a href="r-basics.html#data-types"><i class="fa fa-check"></i><b>1.6</b> Data types</a><ul>
<li class="chapter" data-level="1.6.1" data-path="r-basics.html"><a href="r-basics.html#data-frames"><i class="fa fa-check"></i><b>1.6.1</b> Data frames</a></li>
<li class="chapter" data-level="1.6.2" data-path="r-basics.html"><a href="r-basics.html#examining-an-object"><i class="fa fa-check"></i><b>1.6.2</b> Examining an object</a></li>
<li class="chapter" data-level="1.6.3" data-path="r-basics.html"><a href="r-basics.html#the-accessor"><i class="fa fa-check"></i><b>1.6.3</b> The accessor</a></li>
<li class="chapter" data-level="1.6.4" data-path="r-basics.html"><a href="r-basics.html#vectors-numerics-characters-and-logical"><i class="fa fa-check"></i><b>1.6.4</b> Vectors: numerics, characters, and logical</a></li>
<li class="chapter" data-level="1.6.5" data-path="r-basics.html"><a href="r-basics.html#factors"><i class="fa fa-check"></i><b>1.6.5</b> Factors</a></li>
<li class="chapter" data-level="1.6.6" data-path="r-basics.html"><a href="r-basics.html#lists"><i class="fa fa-check"></i><b>1.6.6</b> Lists</a></li>
<li class="chapter" data-level="" data-path="r-basics.html"><a href="r-basics.html#exercises-1"><i class="fa fa-check"></i>Exercises</a></li>
</ul></li>
<li class="chapter" data-level="1.7" data-path="r-basics.html"><a href="r-basics.html#vectors"><i class="fa fa-check"></i><b>1.7</b> Vectors</a><ul>
<li class="chapter" data-level="1.7.1" data-path="r-basics.html"><a href="r-basics.html#creating-vectors"><i class="fa fa-check"></i><b>1.7.1</b> Creating vectors</a></li>
<li class="chapter" data-level="1.7.2" data-path="r-basics.html"><a href="r-basics.html#names"><i class="fa fa-check"></i><b>1.7.2</b> Names</a></li>
<li class="chapter" data-level="1.7.3" data-path="r-basics.html"><a href="r-basics.html#sequences"><i class="fa fa-check"></i><b>1.7.3</b> Sequences</a></li>
<li class="chapter" data-level="1.7.4" data-path="r-basics.html"><a href="r-basics.html#subsetting"><i class="fa fa-check"></i><b>1.7.4</b> Subsetting</a></li>
<li class="chapter" data-level="1.7.5" data-path="r-basics.html"><a href="r-basics.html#coercion"><i class="fa fa-check"></i><b>1.7.5</b> Coercion</a></li>
<li class="chapter" data-level="1.7.6" data-path="r-basics.html"><a href="r-basics.html#not-availables-na"><i class="fa fa-check"></i><b>1.7.6</b> Not Availables (NA)</a></li>
<li class="chapter" data-level="" data-path="r-basics.html"><a href="r-basics.html#exercises-2"><i class="fa fa-check"></i>Exercises</a></li>
</ul></li>
<li class="chapter" data-level="1.8" data-path="r-basics.html"><a href="r-basics.html#sorting"><i class="fa fa-check"></i><b>1.8</b> Sorting</a><ul>
<li class="chapter" data-level="1.8.1" data-path="r-basics.html"><a href="r-basics.html#sort"><i class="fa fa-check"></i><b>1.8.1</b> <code>sort</code></a></li>
<li class="chapter" data-level="1.8.2" data-path="r-basics.html"><a href="r-basics.html#order"><i class="fa fa-check"></i><b>1.8.2</b> <code>order</code></a></li>
<li class="chapter" data-level="1.8.3" data-path="r-basics.html"><a href="r-basics.html#max-and-which.max"><i class="fa fa-check"></i><b>1.8.3</b> <code>max</code> and <code>which.max</code></a></li>
<li class="chapter" data-level="1.8.4" data-path="r-basics.html"><a href="r-basics.html#rank"><i class="fa fa-check"></i><b>1.8.4</b> <code>rank</code></a></li>
<li class="chapter" data-level="1.8.5" data-path="r-basics.html"><a href="r-basics.html#beware-of-recycling"><i class="fa fa-check"></i><b>1.8.5</b> Beware of recycling</a></li>
<li class="chapter" data-level="" data-path="r-basics.html"><a href="r-basics.html#exercise"><i class="fa fa-check"></i>Exercise</a></li>
</ul></li>
<li class="chapter" data-level="1.9" data-path="r-basics.html"><a href="r-basics.html#vector-arithmetics"><i class="fa fa-check"></i><b>1.9</b> Vector arithmetics</a><ul>
<li class="chapter" data-level="1.9.1" data-path="r-basics.html"><a href="r-basics.html#rescaling"><i class="fa fa-check"></i><b>1.9.1</b> Rescaling</a></li>
<li class="chapter" data-level="1.9.2" data-path="r-basics.html"><a href="r-basics.html#two-vectors"><i class="fa fa-check"></i><b>1.9.2</b> Two vectors</a></li>
<li class="chapter" data-level="" data-path="r-basics.html"><a href="r-basics.html#exercises-3"><i class="fa fa-check"></i>Exercises</a></li>
</ul></li>
<li class="chapter" data-level="1.10" data-path="r-basics.html"><a href="r-basics.html#indexing"><i class="fa fa-check"></i><b>1.10</b> Indexing</a><ul>
<li class="chapter" data-level="1.10.1" data-path="r-basics.html"><a href="r-basics.html#subsetting-with-logicals"><i class="fa fa-check"></i><b>1.10.1</b> Subsetting with logicals</a></li>
<li class="chapter" data-level="1.10.2" data-path="r-basics.html"><a href="r-basics.html#logical-operators"><i class="fa fa-check"></i><b>1.10.2</b> Logical operators</a></li>
<li class="chapter" data-level="1.10.3" data-path="r-basics.html"><a href="r-basics.html#which"><i class="fa fa-check"></i><b>1.10.3</b> <code>which</code></a></li>
<li class="chapter" data-level="1.10.4" data-path="r-basics.html"><a href="r-basics.html#match"><i class="fa fa-check"></i><b>1.10.4</b> <code>match</code></a></li>
<li class="chapter" data-level="1.10.5" data-path="r-basics.html"><a href="r-basics.html#in"><i class="fa fa-check"></i><b>1.10.5</b> <code>%in%</code></a></li>
<li class="chapter" data-level="" data-path="r-basics.html"><a href="r-basics.html#exercises-4"><i class="fa fa-check"></i>Exercises</a></li>
</ul></li>
<li class="chapter" data-level="1.11" data-path="r-basics.html"><a href="r-basics.html#basic-data-wrangling"><i class="fa fa-check"></i><b>1.11</b> Basic Data Wrangling</a><ul>
<li class="chapter" data-level="1.11.1" data-path="r-basics.html"><a href="r-basics.html#adding-a-column-with-mutate"><i class="fa fa-check"></i><b>1.11.1</b> Adding a column with <code>mutate</code></a></li>
<li class="chapter" data-level="1.11.2" data-path="r-basics.html"><a href="r-basics.html#subsetting-with-filter"><i class="fa fa-check"></i><b>1.11.2</b> Subsetting with <code>filter</code></a></li>
<li class="chapter" data-level="1.11.3" data-path="r-basics.html"><a href="r-basics.html#selecting-columns-with-select"><i class="fa fa-check"></i><b>1.11.3</b> Selecting columns with <code>select</code></a></li>
<li class="chapter" data-level="1.11.4" data-path="r-basics.html"><a href="r-basics.html#the-pipe"><i class="fa fa-check"></i><b>1.11.4</b> The pipe: <code>%&gt;%</code></a></li>
<li class="chapter" data-level="1.11.5" data-path="r-basics.html"><a href="r-basics.html#creating-a-data-frame"><i class="fa fa-check"></i><b>1.11.5</b> Creating a data frame</a></li>
<li class="chapter" data-level="" data-path="r-basics.html"><a href="r-basics.html#exercises-5"><i class="fa fa-check"></i>Exercises</a></li>
</ul></li>
<li class="chapter" data-level="1.12" data-path="r-basics.html"><a href="r-basics.html#basic-plots"><i class="fa fa-check"></i><b>1.12</b> Basic plots</a><ul>
<li class="chapter" data-level="1.12.1" data-path="r-basics.html"><a href="r-basics.html#scatter-plots"><i class="fa fa-check"></i><b>1.12.1</b> Scatter plots</a></li>
<li class="chapter" data-level="1.12.2" data-path="r-basics.html"><a href="r-basics.html#histograms"><i class="fa fa-check"></i><b>1.12.2</b> Histograms</a></li>
<li class="chapter" data-level="1.12.3" data-path="r-basics.html"><a href="r-basics.html#boxplot"><i class="fa fa-check"></i><b>1.12.3</b> Boxplot</a></li>
<li class="chapter" data-level="" data-path="r-basics.html"><a href="r-basics.html#exercises-6"><i class="fa fa-check"></i>Exercises</a></li>
</ul></li>
<li class="chapter" data-level="1.13" data-path="r-basics.html"><a href="r-basics.html#importing-data"><i class="fa fa-check"></i><b>1.13</b> Importing Data</a><ul>
<li class="chapter" data-level="1.13.1" data-path="r-basics.html"><a href="r-basics.html#read.csv"><i class="fa fa-check"></i><b>1.13.1</b> <code>read.csv</code></a></li>
</ul></li>
<li class="chapter" data-level="1.14" data-path="r-basics.html"><a href="r-basics.html#programming-basics"><i class="fa fa-check"></i><b>1.14</b> Programming basics</a><ul>
<li class="chapter" data-level="1.14.1" data-path="r-basics.html"><a href="r-basics.html#conditionals-expressions"><i class="fa fa-check"></i><b>1.14.1</b> Conditionals expressions</a></li>
<li class="chapter" data-level="1.14.2" data-path="r-basics.html"><a href="r-basics.html#defining-functions"><i class="fa fa-check"></i><b>1.14.2</b> Defining functions</a></li>
<li class="chapter" data-level="1.14.3" data-path="r-basics.html"><a href="r-basics.html#for-loops"><i class="fa fa-check"></i><b>1.14.3</b> For loops</a></li>
<li class="chapter" data-level="1.14.4" data-path="r-basics.html"><a href="r-basics.html#vectorization-and-functionals"><i class="fa fa-check"></i><b>1.14.4</b> Vectorization and Functionals</a></li>
<li class="chapter" data-level="1.14.5" data-path="r-basics.html"><a href="r-basics.html#map"><i class="fa fa-check"></i><b>1.14.5</b> map</a></li>
<li class="chapter" data-level="1.14.6" data-path="r-basics.html"><a href="r-basics.html#other-functions"><i class="fa fa-check"></i><b>1.14.6</b> Other functions</a></li>
<li class="chapter" data-level="" data-path="r-basics.html"><a href="r-basics.html#exercises-7"><i class="fa fa-check"></i>Exercises</a></li>
</ul></li>
<li class="chapter" data-level="1.15" data-path="r-basics.html"><a href="r-basics.html#matrices"><i class="fa fa-check"></i><b>1.15</b> Matrices</a><ul>
<li class="chapter" data-level="1.15.1" data-path="r-basics.html"><a href="r-basics.html#accessing-matrix-values"><i class="fa fa-check"></i><b>1.15.1</b> Accessing matrix values</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="data-visualization.html"><a href="data-visualization.html"><i class="fa fa-check"></i><b>2</b> Data Visualization</a><ul>
<li class="chapter" data-level="2.1" data-path="data-visualization.html"><a href="data-visualization.html#introduction-1"><i class="fa fa-check"></i><b>2.1</b> Introduction</a></li>
<li class="chapter" data-level="2.2" data-path="data-visualization.html"><a href="data-visualization.html#data-types-1"><i class="fa fa-check"></i><b>2.2</b> Data types</a><ul>
<li class="chapter" data-level="" data-path="data-visualization.html"><a href="data-visualization.html#exercise-1"><i class="fa fa-check"></i>Exercise</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="data-visualization.html"><a href="data-visualization.html#distributions"><i class="fa fa-check"></i><b>2.3</b> Distributions</a><ul>
<li class="chapter" data-level="2.3.1" data-path="data-visualization.html"><a href="data-visualization.html#case-study-student-heights"><i class="fa fa-check"></i><b>2.3.1</b> Case study: student heights</a></li>
<li class="chapter" data-level="2.3.2" data-path="data-visualization.html"><a href="data-visualization.html#distribution-function"><i class="fa fa-check"></i><b>2.3.2</b> Distribution function</a></li>
<li class="chapter" data-level="2.3.3" data-path="data-visualization.html"><a href="data-visualization.html#cumulative-distribution-functions"><i class="fa fa-check"></i><b>2.3.3</b> Cumulative distribution functions</a></li>
<li class="chapter" data-level="2.3.4" data-path="data-visualization.html"><a href="data-visualization.html#histograms-1"><i class="fa fa-check"></i><b>2.3.4</b> Histograms</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="data-visualization.html"><a href="data-visualization.html#smoothed-density"><i class="fa fa-check"></i><b>2.4</b> Smoothed density</a><ul>
<li class="chapter" data-level="" data-path="data-visualization.html"><a href="data-visualization.html#exercises-8"><i class="fa fa-check"></i>Exercises</a></li>
</ul></li>
<li class="chapter" data-level="2.5" data-path="data-visualization.html"><a href="data-visualization.html#normal-distribution"><i class="fa fa-check"></i><b>2.5</b> Normal Distribution</a><ul>
<li class="chapter" data-level="2.5.1" data-path="data-visualization.html"><a href="data-visualization.html#standardized-units"><i class="fa fa-check"></i><b>2.5.1</b> Standardized units</a></li>
<li class="chapter" data-level="2.5.2" data-path="data-visualization.html"><a href="data-visualization.html#quantile-quantile-qq-plots"><i class="fa fa-check"></i><b>2.5.2</b> Quantile-quantile QQ plots</a></li>
<li class="chapter" data-level="2.5.3" data-path="data-visualization.html"><a href="data-visualization.html#percentiles"><i class="fa fa-check"></i><b>2.5.3</b> Percentiles</a></li>
<li class="chapter" data-level="" data-path="data-visualization.html"><a href="data-visualization.html#exercises-9"><i class="fa fa-check"></i>Exercises</a></li>
</ul></li>
<li class="chapter" data-level="2.6" data-path="data-visualization.html"><a href="data-visualization.html#boxplots"><i class="fa fa-check"></i><b>2.6</b> Boxplots</a></li>
<li class="chapter" data-level="2.7" data-path="data-visualization.html"><a href="data-visualization.html#case-study-are-female-student-heights-normally-distributed"><i class="fa fa-check"></i><b>2.7</b> Case study: are female student heights normally distributed?</a></li>
<li class="chapter" data-level="2.8" data-path="data-visualization.html"><a href="data-visualization.html#robust-summaries"><i class="fa fa-check"></i><b>2.8</b> Robust summaries</a><ul>
<li class="chapter" data-level="2.8.1" data-path="data-visualization.html"><a href="data-visualization.html#outliers"><i class="fa fa-check"></i><b>2.8.1</b> Outliers</a></li>
<li class="chapter" data-level="2.8.2" data-path="data-visualization.html"><a href="data-visualization.html#median"><i class="fa fa-check"></i><b>2.8.2</b> Median</a></li>
<li class="chapter" data-level="2.8.3" data-path="data-visualization.html"><a href="data-visualization.html#the-inter-quartile-range"><i class="fa fa-check"></i><b>2.8.3</b> The inter quartile range</a></li>
<li class="chapter" data-level="2.8.4" data-path="data-visualization.html"><a href="data-visualization.html#tukeys-definition-of-an-outlier"><i class="fa fa-check"></i><b>2.8.4</b> Tukey’s definition of an outlier</a></li>
<li class="chapter" data-level="2.8.5" data-path="data-visualization.html"><a href="data-visualization.html#median-absolute-deviation"><i class="fa fa-check"></i><b>2.8.5</b> Median absolute deviation</a></li>
<li class="chapter" data-level="" data-path="data-visualization.html"><a href="data-visualization.html#exercises-10"><i class="fa fa-check"></i>Exercises</a></li>
</ul></li>
<li class="chapter" data-level="2.9" data-path="data-visualization.html"><a href="data-visualization.html#case-study-self-reported-heights"><i class="fa fa-check"></i><b>2.9</b> Case Study: self-reported heights</a></li>
<li class="chapter" data-level="2.10" data-path="data-visualization.html"><a href="data-visualization.html#summarizing-data-with-dplyr"><i class="fa fa-check"></i><b>2.10</b> Summarizing data with dplyr</a><ul>
<li class="chapter" data-level="2.10.1" data-path="data-visualization.html"><a href="data-visualization.html#summarize"><i class="fa fa-check"></i><b>2.10.1</b> Summarize</a></li>
<li class="chapter" data-level="2.10.2" data-path="data-visualization.html"><a href="data-visualization.html#using-the-dot-to-access-the-piped-data"><i class="fa fa-check"></i><b>2.10.2</b> Using the dot to access the piped data</a></li>
<li class="chapter" data-level="2.10.3" data-path="data-visualization.html"><a href="data-visualization.html#group-then-summarize"><i class="fa fa-check"></i><b>2.10.3</b> Group then summarize</a></li>
<li class="chapter" data-level="2.10.4" data-path="data-visualization.html"><a href="data-visualization.html#sorting-data-tables"><i class="fa fa-check"></i><b>2.10.4</b> Sorting data tables</a></li>
<li class="chapter" data-level="" data-path="data-visualization.html"><a href="data-visualization.html#exercises-11"><i class="fa fa-check"></i>Exercises</a></li>
</ul></li>
<li class="chapter" data-level="2.11" data-path="data-visualization.html"><a href="data-visualization.html#a-first-introduction-to-ggplot2"><i class="fa fa-check"></i><b>2.11</b> A first introduction to ggplot2</a><ul>
<li class="chapter" data-level="2.11.1" data-path="data-visualization.html"><a href="data-visualization.html#the-cheat-sheet"><i class="fa fa-check"></i><b>2.11.1</b> The cheat sheet</a></li>
<li class="chapter" data-level="2.11.2" data-path="data-visualization.html"><a href="data-visualization.html#the-components-of-a-graph"><i class="fa fa-check"></i><b>2.11.2</b> The components of a graph</a></li>
<li class="chapter" data-level="2.11.3" data-path="data-visualization.html"><a href="data-visualization.html#the-components-of-a-graph-1"><i class="fa fa-check"></i><b>2.11.3</b> The components of a graph</a></li>
<li class="chapter" data-level="2.11.4" data-path="data-visualization.html"><a href="data-visualization.html#creating-a-blank-slate-ggplot-object"><i class="fa fa-check"></i><b>2.11.4</b> Creating a blank slate <code>ggplot</code> object</a></li>
<li class="chapter" data-level="2.11.5" data-path="data-visualization.html"><a href="data-visualization.html#layers"><i class="fa fa-check"></i><b>2.11.5</b> Layers</a></li>
<li class="chapter" data-level="2.11.6" data-path="data-visualization.html"><a href="data-visualization.html#geometry"><i class="fa fa-check"></i><b>2.11.6</b> Geometry</a></li>
<li class="chapter" data-level="2.11.7" data-path="data-visualization.html"><a href="data-visualization.html#aes"><i class="fa fa-check"></i><b>2.11.7</b> <code>aes</code></a></li>
<li class="chapter" data-level="2.11.8" data-path="data-visualization.html"><a href="data-visualization.html#adding-other-layers"><i class="fa fa-check"></i><b>2.11.8</b> Adding other layers</a></li>
<li class="chapter" data-level="2.11.9" data-path="data-visualization.html"><a href="data-visualization.html#global-aesthetic-mappings"><i class="fa fa-check"></i><b>2.11.9</b> Global aesthetic mappings</a></li>
<li class="chapter" data-level="2.11.10" data-path="data-visualization.html"><a href="data-visualization.html#scales"><i class="fa fa-check"></i><b>2.11.10</b> Scales</a></li>
<li class="chapter" data-level="2.11.11" data-path="data-visualization.html"><a href="data-visualization.html#labels-and-titles"><i class="fa fa-check"></i><b>2.11.11</b> Labels and titles</a></li>
<li class="chapter" data-level="2.11.12" data-path="data-visualization.html"><a href="data-visualization.html#adjustments"><i class="fa fa-check"></i><b>2.11.12</b> Adjustments</a></li>
<li class="chapter" data-level="2.11.13" data-path="data-visualization.html"><a href="data-visualization.html#add-on-packages"><i class="fa fa-check"></i><b>2.11.13</b> Add-on packages</a></li>
<li class="chapter" data-level="2.11.14" data-path="data-visualization.html"><a href="data-visualization.html#putting-it-all-together"><i class="fa fa-check"></i><b>2.11.14</b> Putting it all together</a></li>
</ul></li>
<li class="chapter" data-level="2.12" data-path="data-visualization.html"><a href="data-visualization.html#geometries"><i class="fa fa-check"></i><b>2.12</b> Geometries</a><ul>
<li class="chapter" data-level="2.12.1" data-path="data-visualization.html"><a href="data-visualization.html#histogram"><i class="fa fa-check"></i><b>2.12.1</b> Histogram</a></li>
<li class="chapter" data-level="2.12.2" data-path="data-visualization.html"><a href="data-visualization.html#density"><i class="fa fa-check"></i><b>2.12.2</b> Density</a></li>
<li class="chapter" data-level="2.12.3" data-path="data-visualization.html"><a href="data-visualization.html#qq-plots"><i class="fa fa-check"></i><b>2.12.3</b> QQ-plots</a></li>
</ul></li>
<li class="chapter" data-level="2.13" data-path="data-visualization.html"><a href="data-visualization.html#grids-of-plots"><i class="fa fa-check"></i><b>2.13</b> Grids of plots</a></li>
<li class="chapter" data-level="2.14" data-path="data-visualization.html"><a href="data-visualization.html#case-study-trends-in-world-health-and-economics"><i class="fa fa-check"></i><b>2.14</b> Case study: Trends in world health and economics</a><ul>
<li class="chapter" data-level="2.14.1" data-path="data-visualization.html"><a href="data-visualization.html#example-1-life-expectancy-and-fertility-rates"><i class="fa fa-check"></i><b>2.14.1</b> Example 1: Life expectancy and fertility rates</a></li>
<li class="chapter" data-level="2.14.2" data-path="data-visualization.html"><a href="data-visualization.html#a-scatterplot"><i class="fa fa-check"></i><b>2.14.2</b> A scatterplot</a></li>
<li class="chapter" data-level="2.14.3" data-path="data-visualization.html"><a href="data-visualization.html#faceting"><i class="fa fa-check"></i><b>2.14.3</b> Faceting</a></li>
<li class="chapter" data-level="2.14.4" data-path="data-visualization.html"><a href="data-visualization.html#fixed-scales-for-better-comparisons"><i class="fa fa-check"></i><b>2.14.4</b> Fixed scales for better comparisons</a></li>
<li class="chapter" data-level="2.14.5" data-path="data-visualization.html"><a href="data-visualization.html#time-series-plots"><i class="fa fa-check"></i><b>2.14.5</b> Time series plots</a></li>
<li class="chapter" data-level="2.14.6" data-path="data-visualization.html"><a href="data-visualization.html#example-2-income-distribution"><i class="fa fa-check"></i><b>2.14.6</b> Example 2: Income distribution</a></li>
<li class="chapter" data-level="2.14.7" data-path="data-visualization.html"><a href="data-visualization.html#transformations"><i class="fa fa-check"></i><b>2.14.7</b> Transformations</a></li>
<li class="chapter" data-level="2.14.8" data-path="data-visualization.html"><a href="data-visualization.html#modes"><i class="fa fa-check"></i><b>2.14.8</b> Modes</a></li>
<li class="chapter" data-level="2.14.9" data-path="data-visualization.html"><a href="data-visualization.html#stratify-and-boxplot"><i class="fa fa-check"></i><b>2.14.9</b> Stratify and boxplot</a></li>
<li class="chapter" data-level="2.14.10" data-path="data-visualization.html"><a href="data-visualization.html#comparing-distributions"><i class="fa fa-check"></i><b>2.14.10</b> Comparing distributions</a></li>
<li class="chapter" data-level="2.14.11" data-path="data-visualization.html"><a href="data-visualization.html#density-plots"><i class="fa fa-check"></i><b>2.14.11</b> Density plots</a></li>
<li class="chapter" data-level="2.14.12" data-path="data-visualization.html"><a href="data-visualization.html#accessing-computed-variables"><i class="fa fa-check"></i><b>2.14.12</b> Accessing computed variables</a></li>
<li class="chapter" data-level="2.14.13" data-path="data-visualization.html"><a href="data-visualization.html#case_when"><i class="fa fa-check"></i><b>2.14.13</b> ‘case_when’</a></li>
</ul></li>
<li class="chapter" data-level="2.15" data-path="data-visualization.html"><a href="data-visualization.html#ecological-fallacy"><i class="fa fa-check"></i><b>2.15</b> Ecological fallacy</a></li>
<li class="chapter" data-level="2.16" data-path="data-visualization.html"><a href="data-visualization.html#some-data-visualization-principles"><i class="fa fa-check"></i><b>2.16</b> Some data visualization principles</a><ul>
<li class="chapter" data-level="2.16.1" data-path="data-visualization.html"><a href="data-visualization.html#encoding-data-using-visual-cues"><i class="fa fa-check"></i><b>2.16.1</b> Encoding data using visual cues</a></li>
<li class="chapter" data-level="2.16.2" data-path="data-visualization.html"><a href="data-visualization.html#know-when-to-include-0"><i class="fa fa-check"></i><b>2.16.2</b> Know when to include 0</a></li>
<li class="chapter" data-level="2.16.3" data-path="data-visualization.html"><a href="data-visualization.html#do-not-distort-quantities"><i class="fa fa-check"></i><b>2.16.3</b> Do not distort quantities</a></li>
<li class="chapter" data-level="2.16.4" data-path="data-visualization.html"><a href="data-visualization.html#order-by-a-meaningful-value"><i class="fa fa-check"></i><b>2.16.4</b> Order by a meaningful value</a></li>
<li class="chapter" data-level="2.16.5" data-path="data-visualization.html"><a href="data-visualization.html#show-the-data-2"><i class="fa fa-check"></i><b>2.16.5</b> Show the data</a></li>
<li class="chapter" data-level="2.16.6" data-path="data-visualization.html"><a href="data-visualization.html#ease-comparisons-use-common-axes"><i class="fa fa-check"></i><b>2.16.6</b> Ease comparisons: use common axes</a></li>
<li class="chapter" data-level="2.16.7" data-path="data-visualization.html"><a href="data-visualization.html#ease-comparisons-align-plots-vertically-to-see-horizontal-changes-and-horizontally-to-see-vertical-changes"><i class="fa fa-check"></i><b>2.16.7</b> Ease comparisons: align plots vertically to see horizontal changes and horizontally to see vertical changes</a></li>
<li class="chapter" data-level="2.16.8" data-path="data-visualization.html"><a href="data-visualization.html#consider-transformations"><i class="fa fa-check"></i><b>2.16.8</b> Consider transformations</a></li>
<li class="chapter" data-level="2.16.9" data-path="data-visualization.html"><a href="data-visualization.html#ease-comparisons-visual-cues-to-be-compared-should-be-adjacent."><i class="fa fa-check"></i><b>2.16.9</b> Ease comparisons: Visual cues to be compared should be adjacent.</a></li>
<li class="chapter" data-level="2.16.10" data-path="data-visualization.html"><a href="data-visualization.html#ease-comparison-use-color"><i class="fa fa-check"></i><b>2.16.10</b> Ease comparison: use color</a></li>
<li class="chapter" data-level="2.16.11" data-path="data-visualization.html"><a href="data-visualization.html#think-of-the-color-blind"><i class="fa fa-check"></i><b>2.16.11</b> Think of the color blind</a></li>
<li class="chapter" data-level="2.16.12" data-path="data-visualization.html"><a href="data-visualization.html#use-scatter-plots-to-examine-the-relationship-between-two-variables"><i class="fa fa-check"></i><b>2.16.12</b> Use scatter plots to examine the relationship between two variables</a></li>
<li class="chapter" data-level="2.16.13" data-path="data-visualization.html"><a href="data-visualization.html#encoding-a-third-variable"><i class="fa fa-check"></i><b>2.16.13</b> Encoding a third variable</a></li>
<li class="chapter" data-level="2.16.14" data-path="data-visualization.html"><a href="data-visualization.html#avoid-pseudo-three-dimensional-plots"><i class="fa fa-check"></i><b>2.16.14</b> Avoid pseudo three dimensional plots</a></li>
<li class="chapter" data-level="2.16.15" data-path="data-visualization.html"><a href="data-visualization.html#avoid-gratuitous-three-dimensional-plots"><i class="fa fa-check"></i><b>2.16.15</b> Avoid gratuitous three dimensional plots</a></li>
<li class="chapter" data-level="2.16.16" data-path="data-visualization.html"><a href="data-visualization.html#further-reading"><i class="fa fa-check"></i><b>2.16.16</b> Further reading:</a></li>
<li class="chapter" data-level="" data-path="data-visualization.html"><a href="data-visualization.html#exercises-12"><i class="fa fa-check"></i>Exercises</a></li>
</ul></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Introduction to Data Science</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="data-visualization" class="section level1">
<h1><span class="header-section-number">Chapter 2</span> Data Visualization</h1>
<div id="introduction-1" class="section level2">
<h2><span class="header-section-number">2.1</span> Introduction</h2>
<p>Looking at the numbers and character strings that define a dataset is rarely useful. To convince yourself, print and stare at the US murders data table:</p>
<pre><code>#&gt;        state abb region population total
#&gt; 1    Alabama  AL  South    4779736   135
#&gt; 2     Alaska  AK   West     710231    19
#&gt; 3    Arizona  AZ   West    6392017   232
#&gt; 4   Arkansas  AR  South    2915918    93
#&gt; 5 California  CA   West   37253956  1257
#&gt; 6   Colorado  CO   West    5029196    65</code></pre>
<p>What do you learn from staring at this table? How quickly can you determine which states have the largest populations? Which states have the smallest? How large is a typical state? Is there a relationship between population size and total murders? How do murder rates vary across regions of the country? For most human brains it is quite difficult to extract this information just from looking at the numbers. In contrast, the answer to all the questions above are readily available from examining this plot:</p>
<div class="figure" style="text-align: center"><span id="fig:ggplot-example-plot-0"></span>
<img src="book_files/figure-html/ggplot-example-plot-0-1.png" alt="Murder totals versus population size by state." width="70%" />
<p class="caption">
Figure 2.1: Murder totals versus population size by state.
</p>
</div>
<p>We are reminded of the saying “a picture is worth a thousand words”. Data visualization provides a powerful way to communicate a data-driven finding. In some cases, the visualization is so convincing that no follow-up analysis is required.</p>
<p>The growing availability of informative datasets and software tools has led to increased reliance on data visualizations across many industries, academia, and government. A salient example is news organizations, which are increasingly embracing <em>data journalism</em> and including effective <em>infographics</em> as part of their reporting.</p>
<p>A particularly effective example is a Wall Street Journal <a href="http://graphics.wsj.com/infectious-diseases-and-vaccines/?mc_cid=711ddeb86e">article</a> showing data related to the impact of vaccines on battling infectious diseases. One of the graphs shows measles cases by US state through the years with a vertical line demonstrating when the vaccine was introduced.</p>
<p><img src="img/wsj-vaccines.png" width="600" align="middle"></p>
<p>Another striking example comes from the New York Times showing data on<br />
scores from the NYC Regents Exams. These scores are collected for several reasons including to determine if a student graduates from high school. In New York City you need a 65 to pass. The distribution of the test scores forces us to notice something somewhat problematic:</p>
<p><img src="img/nythist.gif" width="800" align="middle"></p>
<p>The most common test score is the minimum passing grade, with a few just below. This unexpected result is consistent with students close to passing having their scores bumped up.</p>
<p>This is an example of how data visualization can lead to discoveries which would otherwise be missed if we simply subjected the data to a battery of data analysis tools or procedures. Data visualization is the strongest tool of what we call exploratory data analysis (EDA). <a href="https://en.wikipedia.org/wiki/John_Tukey">John W. Tukey</a>, considered the father of EDA, once said,</p>
<blockquote>
<blockquote>
<p>“The greatest value of a picture is when it forces us to notice what we never expected to see.”</p>
</blockquote>
</blockquote>
<div class="figure" style="text-align: center"><span id="fig:unnamed-chunk-198"></span>
<img src="http://upload.wikimedia.org/wikipedia/en/e/e9/John_Tukey.jpg" alt="John W. Tukey (source: Wikipedia)." width="70%" />
<p class="caption">
Figure 2.2: John W. Tukey (source: Wikipedia).
</p>
</div>
<p>Many widely used data analysis tools were initiated by discoveries made via EDA. EDA is perhaps the most important part of data analysis, yet it is one that is often overlooked.</p>
<p>Data visualization is also now pervasive in philanthropic and educational organizations. In the talks <a href="https://www.ted.com/talks/hans_rosling_reveals_new_insights_on_poverty?language=en">New Insights on Poverty</a> and <a href="https://www.ted.com/talks/hans_rosling_shows_the_best_stats_you_ve_ever_seen">The Best Stats You’ve Ever Seen</a>, Hans Rosling forced us to to notice the unexpected with a series of plots related to world health and economics. In his videos, he used animated graphs to show us how the world was changing and how old narratives were no longer true.</p>
<div class="figure" style="text-align: center"><span id="fig:gampnider-example-plot"></span>
<img src="book_files/figure-html/gampnider-example-plot-1.png" alt="Life expectancy versus fertility for two 1962 and 2013" width="70%" />
<p class="caption">
Figure 2.3: Life expectancy versus fertility for two 1962 and 2013
</p>
</div>
<p>It is also important to note that mistakes, biases, systematic errors and other unexpected problems often lead to data that should be handled with care. Failure to discover these problems often leads to flawed analyses and false discoveries. As an example, consider that measurement devices sometimes fail and that most data analysis procedures are not designed to detect these. Yet, these data analysis procedures will still give you an answer. The fact that it can be difficult or impossible to notice an error just from the reported results makes data visualization particularly important.</p>
<p>Data visualization is a powerful approach to detecting these problems. We refer to this particular task as <em>exploratory data analysis</em> (EDA).</p>
<p>In this chapter we will learn the basics of data visualization and exploratory data analysis. We will use three motivating examples. We will use the ggplot2 package to code. To learn the very basics, we will start with a somewhat artificial example: heights reported by students. Then we will cover the two examples mentioned above 1) world health and economics and 2) infectious disease trends in the United States.</p>
<p>Of course, there is much more to data visualization than what we cover here. The following are references for those who wish to learn more:</p>
<ul>
<li>ER Tufte (1983) The visual display of quantitative information. Graphics Press.</li>
<li>ER Tufte (1990) Envisioning information. Graphics Press.</li>
<li>ER Tufte (1997) Visual explanations. Graphics Press.</li>
<li>A Gelman, C Pasarica, R Dodhia (2002) Let’s practice what we preach: Turning tables into graphs. The American Statistician 56:121-130</li>
<li>NB Robbins (2004) Creating more effective graphs. Wiley</li>
</ul>
<p>We also do not cover interactive graphics, a topic that is too advanced for this book. Some useful resources for those interested in learning more can be found below:</p>
<ul>
<li><a href="https://shiny.rstudio.com/" class="uri">https://shiny.rstudio.com/</a></li>
<li><a href="https://d3js.org/" class="uri">https://d3js.org/</a></li>
</ul>

</div>
<div id="data-types-1" class="section level2">
<h2><span class="header-section-number">2.2</span> Data types</h2>
<p>We will be working with two types of variables: categorical and numeric. Each can be divided into two other groups: categorical can be ordinal or not, whereas numerical variables can be discrete or continuous.</p>
<p>When each entry in a vector comes from one of a small number of groups, we refer to the data as <em>categorical data</em>. Two simple examples are sex (male or female), regions (Northeast, South, North Central, West). Some categorical data can be ordered, for example spiciness (mild, medium, hot), even if they are not numbers per se. In statistics textbooks they sometimes refer to these as <em>ordinal</em> data.</p>
<p>Example of numerical data are population sizes, murder rates, and heights. Some numerical data can be treated as ordered categorical. We can further divide numerical data into continuous and discrete. Continuous variables are those that can take any value such as heights, if measured with enough precision. For example, a pair of twins may be 68.12 and 68.11 inches respectively. Counts, such as population sizes, are discrete because they have to be round numbers.</p>
<p>Note that discrete numeric data can be considered ordinal. Although this is technically true, we usually reserve the term ordinal data for variables belonging to a small number of different groups, with each group having many members. In contrast, when we have many groups with few cases in each group, we typically refer to them as discrete numerical variables. So, for example, the number of packs of cigarettes a person smokes a day, rounded to the closest pack, would be considered ordinal, while the actual number of cigarettes would be considered a numerical variable. But indeed, there are examples that can be considered both numerical and ordinal when it comes to visualizing data.</p>
<div id="exercise-1" class="section level3 unnumbered">
<h3>Exercise</h3>
<ol style="list-style-type: decimal">
<li>Define variables containing the heights of males and females like this:</li>
</ol>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(dslabs)
<span class="kw">data</span>(heights)
male &lt;-<span class="st"> </span>heights<span class="op">$</span>height[heights<span class="op">$</span>sex<span class="op">==</span><span class="st">&quot;Male&quot;</span>]
female &lt;-<span class="st"> </span>heights<span class="op">$</span>height[heights<span class="op">$</span>sex<span class="op">==</span><span class="st">&quot;Female&quot;</span>]</code></pre></div>
<p>How many measurements do we have for each?</p>
<ol start="2" style="list-style-type: decimal">
<li><p>Suppose we can’t make a plot and want to compare the distributions side by side. We can’t just list all the numbers. Instead we will look at the percentiles. Create an five row table showing <code>female_percentiles</code> and <code>male_percentiles</code> with the 10th, 30th, 50th, …, 90th percentiles for each sex. Then create a data frame with these two as columns.</p></li>
<li><p>Study the following boxplots showing us populations sizes by country:</p>
<p><img src="book_files/figure-html/boxplot-exercise-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>Which continent has the country with the biggest population size ?</p></li>
<li><p>What continent has the largest median population size?</p></li>
<li><p>What is median population size for Africa to the nearest million?</p></li>
<li><p>What proportion of countries in Europe have populations below 14 million?</p>
<p>A. 0.99 B. 0.75 C. 0.50 D. 0.25</p></li>
<li><p>If we use a log transformation, which continent shown above has the largest interquartile range ?</p></li>
</ol>

</div>
</div>
<div id="distributions" class="section level2">
<h2><span class="header-section-number">2.3</span> Distributions</h2>
<p>You may have noticed that numerical data is often summarized with the <em>average</em> value. For example, the quality of a high school is sometimes summarized with one number: the average score on a standardized test. Occasionally, a second number is reported: the <em>standard deviation</em>. So, for example, you might read a report stating that scores were 680 plus or minus 50 (the standard deviation). The report has summarized an entire vector of scores with with just two numbers. Is this appropriate? Is there any important piece of information that we are missing by only looking at this summary rather than the entire list?</p>
<p>Our first data visualization building block is learning to summarize lists of factors or numeric vectors. The most basic statistical summary of a list of objects or numbers is its distribution. Once a vector has been summarized as distribution, there are several data visualization techniques to effectively relay this information.</p>
<div id="case-study-student-heights" class="section level3">
<h3><span class="header-section-number">2.3.1</span> Case study: student heights</h3>
<p>Here we introduce a new motivating problem. It is an artificial one, but it will help us illustrate the concepts needed to understand distributions.</p>
<p>Pretend that we have to describe the heights of our classmates to ET, an extraterrestrial that has never seen humans. As a first step we need to collect data. To do this we ask students to report their heights in inches. We ask them to provide sex information because we know there are two different distributions. We collect the data and save it in a data frame:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(dslabs)
<span class="kw">data</span>(heights)
<span class="kw">head</span>(heights)
<span class="co">#&gt;      sex height</span>
<span class="co">#&gt; 1   Male     75</span>
<span class="co">#&gt; 2   Male     70</span>
<span class="co">#&gt; 3   Male     68</span>
<span class="co">#&gt; 4   Male     74</span>
<span class="co">#&gt; 5   Male     61</span>
<span class="co">#&gt; 6 Female     65</span></code></pre></div>
<p>One way to convey the heights to ET is to simply send him this list of 1050 heights. But there are much more effective ways to convey this information and understanding the concept of a distribution will help. To simplify the explanation, at first we focus on male heights.</p>
</div>
<div id="distribution-function" class="section level3">
<h3><span class="header-section-number">2.3.2</span> Distribution function</h3>
<p>It turns that, in some cases, the average and the standard deviation are pretty much all we need to understand the data. We will learn data visualization techniques that will help us determine when this two number summary is appropriate. These same techniques will serve as an alternative for when two numbers is not enough.</p>
<p>The most basic statistical summary of a list of objects or numbers is its distribution. The simplest way to think of a distribution is as a compact description of a list with many entries. This concept should not be new for most of you. For example, with categorical data, the distribution simply describes the proportion of each unique category. The sex represented in the heights dataset is:</p>
<pre><code>#&gt; 
#&gt; Female   Male 
#&gt;  0.227  0.773</code></pre>
<p>This two category <em>frequency table</em> is the simplest form of a distribution. We don’t really need to visualize it since one number describes everything we need to know 23% are females and the rest are males. When there are more categories, then a simple barplot describes the distribution. Here is an example with the US state regions:</p>
<div class="figure" style="text-align: center"><span id="fig:state-region-distribution"></span>
<img src="book_files/figure-html/state-region-distribution-1.png" alt="Distribution of regions acorss the 50 states and D.C." width="70%" />
<p class="caption">
Figure 2.4: Distribution of regions acorss the 50 states and D.C.
</p>
</div>
<p>This particular plot is simply showing us four numbers: one for each category. We usually use barplots to display a few numbers. Although, this particular plot, a graphical representation of a frequency table, does not provide much more insight than a table itself, it is a first example of how we convert a vector into a plot that succinctly summarizes all the information in the vector. Once the data is numerical, the task of displaying distributions is more challenging.</p>
</div>
<div id="cumulative-distribution-functions" class="section level3">
<h3><span class="header-section-number">2.3.3</span> Cumulative distribution functions</h3>
<p>Numerical data, that are not categorical, also have distributions. In general, when data is not categorical, reporting the frequency of each entry is not an effective summary since most entries are unique. For example, while several students reported a height of 68 inches, only one student reported a height of <code>68.503937007874</code> inches and only one student reported a height <code>68.8976377952756</code> inches. We assume that they converted from 174 and 175 centimeters respectively.</p>
<p>Statistics textbooks teach us that a more useful way to define a distribution for numeric data is to define a function that reports the proportion of the data below <span class="math inline">\(a\)</span> for all possible values of <span class="math inline">\(a\)</span>. This function is called the cumulative distribution function (CDF). In Statistics the following notation is used:</p>
<p><span class="math display">\[ F(a) = \mbox{Pr}(x \leq a) \]</span></p>
<p>Here is a plot of <span class="math inline">\(F\)</span> for the height data:</p>
<div class="figure" style="text-align: center"><span id="fig:ecdf"></span>
<img src="book_files/figure-html/ecdf-1.png" alt="Empirical cummulative distribution function for male  height." width="70%" />
<p class="caption">
Figure 2.5: Empirical cummulative distribution function for male height.
</p>
</div>
<p>Like the frequency table does for categorical data, the CDF defines the distribution for numerical data. From the plot we can see, for example, that 34% of the values are below 65, since <span class="math inline">\(F(66)=\)</span> 0.164, or that 90% of the values are below 72, since <span class="math inline">\(F(72)=\)</span> 0.841, etc.. In fact, we can report the proportion of values between any two heights, say <span class="math inline">\(a\)</span> and <span class="math inline">\(b\)</span>, by computing <span class="math inline">\(F(b) - F(a)\)</span>. This means that if we send this plot above to ET, he will have all the information needed to reconstruct the entire list. Paraphrasing the expression “a picture is worth a thousands word”, in this case a picture is as informative as 812 numbers.</p>
<p>A final note: because CDFs can be defined mathematically, as opposed to using data as we do here, the word <em>empirical</em> is added to distinguish and we use the term empirical CDF (ECDF) instead.</p>
</div>
<div id="histograms-1" class="section level3">
<h3><span class="header-section-number">2.3.4</span> Histograms</h3>
<p>Although the CDF concept is widely discussed in statistics textbooks, the plot is actually not very popular in practice. The main reason is that it does not easily convey characteristics of interest such as: at what value is the distribution centered? Is the distribution symmetric? What ranges contain 95% of the values? Histograms are much preferred because they greatly facilitate answering such questions. Histograms sacrifice just a bit of information to produce plots that are much easier to interpret.</p>
<p>The simplest way to make a histograms is to divide the span of our data into non-overlapping bins of the same size. Then, for each bin, we count the number of values that fall in that interval. The histogram plots these counts as bars with the base of the bar defined by the intervals. Here is the histogram for the height data splitting the range of values into one inch intervals: <span class="math inline">\([49.5, 50.5], [51.5,52.5],(53.5,54.5],...,(82.5,83.5]\)</span></p>
<div class="figure" style="text-align: center"><span id="fig:height-histogram"></span>
<img src="book_files/figure-html/height-histogram-1.png" alt="Histogrom of male heights." width="70%" />
<p class="caption">
Figure 2.6: Histogrom of male heights.
</p>
</div>
<p>Note that a histogram is similar to a barplot, but it differs in that the x-axis is numerical, not categorical.</p>
<p>If we send this plot to ET, he will immediately learn some important properties about our data. First, the range of the data is from 50 to 84 with the majority (more than 95%) between 63 and 75 inches. Second, the heights are close to symmetric around 69 inches. Also, by adding up counts, ET could obtain a very good approximation of the proportion of the data in any interval. Therefore, the histogram above is not only easy to interpret, but also provides almost all the information contained in the raw list of 812 heights with about 30 bin counts.</p>
<p>So what information do we lose? Note that all values in each interval are treated the same when computing bin heights. So, for example, the histogram does not distinguish between 64, 64.1, and 64.2 inches. Given that these differences are almost unnoticeable to the eye, the practical implications are negligible and we were able to summarize the data to just 23 numbers.</p>
</div>
</div>
<div id="smoothed-density" class="section level2">
<h2><span class="header-section-number">2.4</span> Smoothed density</h2>
<p>Smooth density plots are aesthetically more appealing than histograms. Here is what a smooth density plot looks like for our heights data:</p>
<div class="figure" style="text-align: center"><span id="fig:example-of-smoothed-density"></span>
<img src="book_files/figure-html/example-of-smoothed-density-1.png" alt="Smooth density of male heights." width="70%" />
<p class="caption">
Figure 2.7: Smooth density of male heights.
</p>
</div>
<p>In this plot, we no longer have sharp edges at the interval boundaries and many of the local peaks have been removed. Also, the scale of the y-axis changed from counts to <em>density</em>.</p>
<p>To understand the smooth densities we have to understand <em>estimates</em>, a topic we don’t cover until a later chapter. However, we provide a heuristic explanation to help you understand the basics so you can use this useful data visualization tool.</p>
<p>The main new concept you must understand is that we assume that our list of observed values comes from a much much larger list of unobserved values. In the case of heights, you can imagine our list of 1050 students comes from a hypothetical list containing all the heights of all the students in all the world measured very precisely. Let’s say there are 1,000,000 of these. This list values, like any list of values, has a distribution and this is really what we want to report to ET since it is much more general. Unfortunately we don’t get to see it.</p>
<p>However, we make an assumption that helps us perhaps approximate it. Because we have 1,000,000 values, measured very precisely, we can make a histogram with very very small bins. The assumption is that if we do this, consecutive bins will be similar. This is what we mean by smooth: we don’t have big jumps. So here a hypothetical histogram with bins of size 1:</p>
<p><img src="book_files/figure-html/simulated-data-histogram-1-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>The smaller we make the bins, the smoother the histogram gets. Here are the histograms with bin width of 1, 0.5 and 0.1:</p>
<p><img src="book_files/figure-html/simulated-data-histogram-2-1.png" width="100%" style="display: block; margin: auto;" /></p>
<p>The smooth density is basically the curve that goes through the top of the histogram bars when the bins are very, very small. To make the curve not depend on the hypothetical size of the hypothetical list, we compute the curve on frequencies rather than counts</p>
<p><img src="book_files/figure-html/simulated-density-1-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>Now, back to reality. We don’t have millions of measurements, instead we have 812 and we can’t make a histogram with very small bins.</p>
<p>So instead we make a histogram, , using bin sizes appropriate for our data and computing frequencies rather than counts, and we draw a smooth curve that goes through the tops of the histogram bars:</p>
<p><img src="book_files/figure-html/smooth-density-2-1.png" width="100%" style="display: block; margin: auto;" /></p>
<p>Note that <em>smooth</em> is a relative term. We can actually control the <em>smoothness</em> of the curve that defines the smooth density through an option in the function that computes the smooth density. Here are two examples using different degrees of smoothness on the same histogram:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">p1 &lt;-<span class="st"> </span>heights <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(sex<span class="op">==</span><span class="st">&quot;Male&quot;</span>)<span class="op">%&gt;%</span><span class="st"> </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(height)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_histogram</span>(<span class="kw">aes</span>(<span class="dt">y=</span>..density..), <span class="dt">binwidth =</span> <span class="dv">1</span>) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">geom_density</span>(<span class="dt">col=</span><span class="st">&quot;#00BFC4&quot;</span>, <span class="dt">adjust =</span> <span class="fl">0.5</span>)

p2 &lt;-<span class="st"> </span>heights <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(sex<span class="op">==</span><span class="st">&quot;Male&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(height)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_histogram</span>(<span class="kw">aes</span>(<span class="dt">y=</span>..density..), <span class="dt">binwidth =</span> <span class="dv">1</span>) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">geom_density</span>(<span class="dt">col=</span><span class="st">&quot;#00BFC4&quot;</span>, <span class="dt">adjust =</span> <span class="dv">2</span>)

<span class="kw">grid.arrange</span>(p1,p2, <span class="dt">ncol=</span><span class="dv">2</span>)</code></pre></div>
<p><img src="book_files/figure-html/densities-different-smoothness-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>We need to make this choice with care as the resulting visualizations can change our interpretation of the data. We should select a degree of smoothness that we can defend as being representative of the underlying data. In the case of height, we really do have reason to believe that the proportion of people with similar heights should be the same. For example, the proportion that is 72 inches should be more similar to the proportion that is 71, than to the proportion that is 78 or 65. This implies that the curve should be pretty smooth; that is, more like the example on the right than on the left.</p>
<p>While the histogram is an assumption free summary, the smoothed density is based on some assumptions.</p>
<div id="interpreting-the-y-axis" class="section level4 unnumbered">
<h4>Interpreting the y-axis</h4>
<p>Finally, we point out that interpreting the y-axis of a smooth density plot is not straightforward. It is scaled so that the area under the density curve adds up to 1. So if you imagine we form a bin with a base 1 unit in length, the y-axis value tells us the proportion of values in that bin. But this is only true for bins of size 1. For other sized intervals, the best way to determine the proportion of data in that interval is by computing the proportion of the total area contained in that interval. For example, here are the proportion of values between 65 and 68:</p>
<p><img src="book_files/figure-html/area-under-curve-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>The proportion of this area is about 0.32 meaning that about that proportion is between 65 and 68 inches.</p>
<p>By understanding this we are ready to use the smooth density as a summary. For this dataset we would feel quite comfortable with the smoothness assumption and therefore with sharing this aesthetically pleasing figure with ET, which he could use to understand our male heights data:</p>
<p><img src="book_files/figure-html/example-of-smoothed-density-2-1.png" width="70%" style="display: block; margin: auto;" /></p>
</div>
<div id="densities-permit-stratification" class="section level4 unnumbered">
<h4>Densities permit stratification</h4>
<p>As a final note, we point out that an advantage of smooth densities over histograms for visualization purposes is that densities makes it easier to compare two distributions. This is in large part because the jagged edges of the histogram add clutter. Here is an example comparing male and female heights:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">heights <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(height, <span class="dt">fill=</span>sex)) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">geom_density</span>(<span class="dt">alpha =</span> <span class="fl">0.2</span>)</code></pre></div>
<p><img src="book_files/figure-html/two-densities-one-plot-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>With the right argument, <code>ggplot</code> automatically shades the intersecting region with a different color.</p>
</div>
<div id="exercises-8" class="section level3 unnumbered">
<h3>Exercises</h3>
<ol style="list-style-type: decimal">
<li>In the murders dataset, the region is a categorical variable and the following is its distribution:</li>
</ol>
<p><img src="book_files/figure-html/barplot-exercise-1.png" width="70%" style="display: block; margin: auto;" /></p>
<pre><code>To the closet 5%, what proportion of the states are in the North Central region?</code></pre>
<ol start="2" style="list-style-type: decimal">
<li><p>Which of the following is true:</p>
<p>A. The graph above is a histogram. B. The graph above shows only four numbers with a bar plot. C. Categories are not numbers so it does not make sense to graph the distribution. D. The colors, not the height of the bars, describe the distribution.</p></li>
<li><p>The plot below shows the eCDF for male heights:</p>
<p><img src="book_files/figure-html/ecdf-exercise-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>Based on the plot, what percentage of males are shorter than 75 inches?</p>
<p>A. 100% B. 95% C. 80% D. 72 inches</p></li>
<li><p>To the closest inch, what height <code>m</code> has the property that 1/2 of the male students are taller than <code>m</code> and 1/2 are shorter?</p>
<p>A. 61 inches B. 64 inches C. 69 inches D. 74 inches</p></li>
<li><p>Here is an eCDF of the murder rates across states:</p>
<p><img src="book_files/figure-html/ecdf-exercise-2-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>Knowing that there are 51 states (counting DC) and based on this plot, how many states have murder rates larger than 10 per 100,000 people?</p>
<p>A. 1 B. 5 C. 10 D. 50</p></li>
<li><p>Based on the eCDF above, which of the following statements are true:</p>
<p>A. About half the states have murder rates above 7 per 100,000 and the other half below. B. Most states have murder rates below 2 per 100,000. C. All the states have murder rates above 2 per 100,000. D. With the exception of 4 states, the murder rates are below 5 per 100,000.</p></li>
<li><p>Below is a histogram of male heights in our <code>heights</code> dataset:</p>
<p><img src="book_files/figure-html/height-histogram-exercise-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>Based on this plot, how many males are between 63.5 and 65.5?</p>
<p>A. 10 B. 24 C. 34 D. 100</p></li>
<li><p>About what <strong>percentage</strong> are shorter than 60 inches?</p>
<p>A. 1% B. 10% C. 25% D. 50%</p></li>
<li><p>Based on the density plot below, about what proportion of US states have populations larger than 10 million?</p>
<p><img src="book_files/figure-html/density-exercise-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>A. 0.02 B. 0.15 C. 0.50 D. 0.55</p></li>
<li><p>Below are three density plots. Is it possible that they are from the same dataset?</p>
<p><img src="book_files/figure-html/density-exercise-2-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>Which of the following statements is true:</p>
<p>A. It is impossible that they are from the same dataset. B. They are from the same dataset, but different due to code errors. C. They are the same dataset, but the first and second undersmooth and the third oversmooths. D. They are the same dataset, but the first is not in the log scale, the second undersmooths and the third oversmooths.</p></li>
</ol>
</div>
</div>
<div id="normal-distribution" class="section level2">
<h2><span class="header-section-number">2.5</span> Normal Distribution</h2>
<p>Histograms and density plots provide excellent summaries of a distribution. But can we summarize even further? We often see the average and standard deviation used as summary statistics: a two number summary! To understand what these summaries are and why they are so widely used, we need to understand the normal distribution.</p>
<p>The normal distribution, also known as the bell curve and as the Gaussian distribution, is one of the most famous mathematical concepts in history. A reason for this is that approximately normal distributions occur in many situations. Examples include gambling winnings, heights, weights, blood pressure, standardized test scores, and experimental measurement errors. There are explanations for this, but we describe these in a later chapter. Here we focus on how the normal distribution helps us summarize data.</p>
<p>Rather than using data, the normal distribution is defined with a mathematical formula. For any interval <span class="math inline">\((a,b)\)</span> the proportion of values in that interval can be computed using this formula:</p>
<p><span class="math display">\[\mbox{Pr}(a &lt; x &lt; b) = \int_a^b \frac{1}{\sqrt{2\pi}s} \exp\left\{-\frac{1}{2}\left( \frac{x-m}{s} \right)^2\right\} \, dx\]</span></p>
<p>You don’t need to memorize or understand the details of the formula. But note that it is completely defined by just two parameters: <span class="math inline">\(m\)</span> and <span class="math inline">\(s\)</span>. The rest of the symbols in the formula represent the interval ends that we determine, <span class="math inline">\(a\)</span> and <span class="math inline">\(b\)</span>, and known mathematical constants <span class="math inline">\(\pi\)</span> and <span class="math inline">\(\mathrm{e}\)</span>. These two parameters, <span class="math inline">\(m\)</span> and <span class="math inline">\(s\)</span>, are referred to as the <em>average</em>, also called the <em>mean</em>, and the <em>standard deviation</em> (SD) of the distribution respectively.</p>
<p>The distribution is symmetric, centered at the average, and most values (about 95%) are within 2 SDs from the average. Here is what it looks like when the average is 0 and the SD is 1: <img src="book_files/figure-html/normal-distribution-density-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>The fact that the distribution is defined by just two parameters implies that if a dataset is approximated by a normal distribution, all the information needed to describe the distribution can be encoded in just two numbers: the average and the standard deviation, which we now define for an arbitrary list of numbers.</p>
<p>For a list of numbers contained in a vector <code>x</code> the average is defined as</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">average &lt;-<span class="st"> </span><span class="kw">sum</span>(x) <span class="op">/</span><span class="st"> </span><span class="kw">length</span>(x)</code></pre></div>
<p>and the SD is defined as</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">SD &lt;-<span class="st"> </span><span class="kw">sqrt</span>( <span class="kw">sum</span>( (x<span class="op">-</span>mu)<span class="op">^</span><span class="dv">2</span>) <span class="op">/</span><span class="st"> </span><span class="kw">length</span>(x))</code></pre></div>
<p>which can be interpreted as the average distance between values and their average.</p>
<p>Let’s compute the values for the height for males which we will store in the object <span class="math inline">\(x\)</span>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">index &lt;-<span class="st"> </span>heights<span class="op">$</span>sex<span class="op">==</span><span class="st">&quot;Male&quot;</span>
x &lt;-<span class="st"> </span>heights<span class="op">$</span>height[index]</code></pre></div>
<p>The pre-built functions <code>mean</code> and <code>sd</code> [Footnote: SD divide by n-1] can be used here:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">average &lt;-<span class="st"> </span><span class="kw">mean</span>(x)
SD &lt;-<span class="st"> </span><span class="kw">sd</span>(x)
<span class="kw">c</span>(<span class="dt">average=</span>average,<span class="dt">SD=</span>SD)
<span class="co">#&gt; average      SD </span>
<span class="co">#&gt;   69.31    3.61</span></code></pre></div>
<p>Here is a plot of the smooth density and the normal distribution with mean average = 69.315 and SD = 3.611</p>
<p><img src="book_files/figure-html/data-and-normal-densities-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>Notice that it does appear to be quite a good approximation. We now will see how well this approximation works at predicting proportion of values within intervals.</p>
<div id="standardized-units" class="section level3">
<h3><span class="header-section-number">2.5.1</span> Standardized units</h3>
<p>For data that is approximately normally distributed, it is convenient to think in terms of <em>standard units</em>. The standard unit of a value tells us how many standard deviations away from the average it is. Specifically, for a value <span class="math inline">\(x\)</span> we define it as <span class="math inline">\(z = (x-\mbox{average})/\mbox{SD}\)</span>. If you look back at the formula for the normal distribution you notice that what is being exponentiated is <span class="math inline">\(- z^/2\)</span>. The maximum of <span class="math inline">\(\exp{-z^2/2}\)</span> is when <span class="math inline">\(z=0\)</span> which explains why the maximum of the distribution is at the mean. It also explains the symmetry since <span class="math inline">\(- z^/2\)</span> is symmetric around 0.</p>
<p>If we convert the normally distributed data to standard units, we can quickly know if, for example, a person is about average (<span class="math inline">\(z=0\)</span>), one of the largest (<span class="math inline">\(z=2\)</span>), one of the smallest (<span class="math inline">\(z=-2\)</span>) or an extremely rare occurrence (<span class="math inline">\(z&gt;3\)</span> or <span class="math inline">\(z &lt; -3\)</span>). Remember that it does not matter what the original units are, these rules apply to data that is approximately normal.</p>
<p>In R we can obtain standard units using the function <code>scale</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">z &lt;-<span class="st"> </span><span class="kw">scale</span>(x)</code></pre></div>
<p>Now to see how many men are within 2 SDs from the average we simply type:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">mean</span>(<span class="kw">abs</span>(z) <span class="op">&lt;</span><span class="st"> </span><span class="dv">2</span>)
<span class="co">#&gt; [1] 0.95</span></code></pre></div>
<p>The proportion is about 95% which is what the normal distribution predicts! To further confirm that in fact the approximation is a good one, we can use quantile-quantile plots.</p>
</div>
<div id="quantile-quantile-qq-plots" class="section level3">
<h3><span class="header-section-number">2.5.2</span> Quantile-quantile QQ plots</h3>
<p>A systematic way to assess how well the normal distribution fits the data is to check if the observed and predicted proportions match. In general, the approach of the QQ-plot is as follows:</p>
<ol style="list-style-type: decimal">
<li>Define a series of proportions <span class="math inline">\(p=0.05,\dots .95\)</span></li>
<li>For each <span class="math inline">\(p\)</span> determine the value <span class="math inline">\(q\)</span> so that the proportion of values in the data below <span class="math inline">\(q\)</span> is <span class="math inline">\(p\)</span>. The <span class="math inline">\(q\)</span>s are referred to as the <em>quantiles</em>.</li>
</ol>
<p>To give a quick a example, for the male heights data we have that:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">mean</span>(x <span class="op">&lt;=</span><span class="st"> </span><span class="fl">69.5</span>)
<span class="co">#&gt; [1] 0.515</span></code></pre></div>
<p>50% are shorter or equal to 69 inches. This implies that if <span class="math inline">\(p=0.50\)</span> then <span class="math inline">\(q=69.5\)</span>.</p>
<p>Now we define a series of <span class="math inline">\(p\)</span></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">p &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="fl">0.05</span>, <span class="fl">0.95</span>, <span class="fl">0.05</span>)</code></pre></div>
<p>If the quantiles for the data match the quantiles for the normal then it must be because the data follows a normal distribution.</p>
<p>To obtain the quantiles from the data we can use the <code>quantile</code> function like this:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">observed_quantiles &lt;-<span class="st"> </span><span class="kw">quantile</span>(x, p)</code></pre></div>
<p>To obtain the theoretical normal distribution quantiles, with the corresponding average and SD, we use the <code>qnorm</code> function:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">theoretical_quantiles &lt;-<span class="st"> </span><span class="kw">qnorm</span>( p, <span class="dt">mean =</span> <span class="kw">mean</span>(x), <span class="dt">sd =</span> <span class="kw">sd</span>(x))</code></pre></div>
<p>To see if they match or not, we plot them against each other and draw the identity line:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(theoretical_quantiles, observed_quantiles)
<span class="kw">abline</span>(<span class="dv">0</span>,<span class="dv">1</span>)</code></pre></div>
<p><img src="book_files/figure-html/qqplot-original-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>Notice that this code becomes much cleaner if we use standard units:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">observed_quantiles &lt;-<span class="st"> </span><span class="kw">quantile</span>(z, p)
theoretical_quantiles &lt;-<span class="st"> </span><span class="kw">qnorm</span>(p) 
<span class="kw">plot</span>(theoretical_quantiles, observed_quantiles)
<span class="kw">abline</span>(<span class="dv">0</span>,<span class="dv">1</span>)</code></pre></div>
<p><img src="book_files/figure-html/qqplot-standardized-1.png" width="70%" style="display: block; margin: auto;" /></p>
</div>
<div id="percentiles" class="section level3">
<h3><span class="header-section-number">2.5.3</span> Percentiles</h3>
<p>Before we move on, let’s define some terms that are commonly used in exploratory data analysis.</p>
<p><em>Percentiles</em> are special cases of <em>quantiles</em> that are commonly used. The percentiles are the quantiles you obtain when setting the <span class="math inline">\(p\)</span> at <span class="math inline">\(0.01, 0.02, ..., 0.99\)</span>. We call, for example, the case of <span class="math inline">\(p=0.25\)</span> the 25th percentile, which gives us a number for which 25% of the data is below. The most famous percentile is the 50th also known as the <em>median</em>.</p>
<p>For the normal distribution the <em>median</em> and average are the same, but this is generally not the case.</p>
<p>Another special case that receives a name are the <em>quartiles</em> which are obtained when setting <span class="math inline">\(p=0.25,0.50\)</span>, and <span class="math inline">\(0.75\)</span>.</p>
<div id="summarizing-male-heights-with-two-numbers" class="section level4 unnumbered">
<h4>Summarizing male heights with two numbers</h4>
<p>Using the histogram, density plots and qq-plots, we have become convinced that the male height data is well approximated with a normal distribution. In this case, we report back to ET a very succinct summary: male heights follow a normal distribution with an average of 69.315 inches and a SD of 3.611 inches. With this information ET will have everything he needs to know what to expect when he meets our male students.</p>
</div>
</div>
<div id="exercises-9" class="section level3 unnumbered">
<h3>Exercises</h3>
<ol style="list-style-type: decimal">
<li>Load the height data set and create a vector <code>x</code> with just the male heights:</li>
</ol>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(dslabs)
<span class="kw">data</span>(heights)
x &lt;-<span class="st"> </span>heights<span class="op">$</span>height[heights<span class="op">$</span>sex<span class="op">==</span><span class="st">&quot;Male&quot;</span>]</code></pre></div>
<p>What proportion of the data is between 69 and 72 inches (taller than 69 but shorter or equal to 72)? Hint: a logical operator and <code>mean</code>.</p>
<ol start="2" style="list-style-type: decimal">
<li><p>Suppose all you know about the data is the average and the standard deviation. Use the normal approximation to estimate the proportion you just calculated. Hint: Start by computing the average and standard deviation. Then use the <code>pnorm</code> function to predict the proportions.</p></li>
<li><p>Note the approximation calculated in question two is very close to the exact calculation in the first question. Now perform the same task for more extreme values. Compare the exact calculation and the normal approximation for the interval (79,81]. How many times bigger is the actual proportion than the approximation?</p></li>
<li><p>Approximate the distribution of adult men in the world as normally distributed with an average of 69 inches and a standard deviation of 3 inches. Using this approximation, estimate the proportion of adult men that are 7 foot tall or taller, referred to as <em>seven footers</em>. Hint: use the <code>pnorm</code> function.</p></li>
<li><p>There are about 1 billion men between the ages of 18 and 40 in the world. Use your answer to the previous question to estimate how many these men (18-40 yearl olds) are seven feet tall or taller in the world?</p></li>
<li><p>There are about 10 National Basketball Association (NBA) players that are 7 feet tall or higher. Using the answer to the previous two questions, what proportion of the world’s 18 to 40 year old seven footers are in the NBA?</p></li>
<li><p>Repeat the calculations performed in the previous question for Lebron James’ height: 6 feet 8 inches. There are about 150 players that are that tall.</p></li>
<li><p>In answering the previos questions, we found that it is not at all rare for a seven footer to become an NBA player. What would be a fair critique of our calculations:</p>
<p>A. Practice and talent are what make a great basketball player, not height. B. The normal approximation is not appropriate for heights. C. As seen in question 3, the normal approximation tends to underestimate the extreme values. It’s possible that there are more seven footers than we predicted. D. As seen in question 3, the normal approximation tends to overestimate the extreme values. It’s possible that there are less seven footers than we predicted.</p></li>
</ol>
</div>
</div>
<div id="boxplots" class="section level2">
<h2><span class="header-section-number">2.6</span> Boxplots</h2>
<p>To introduce boxplots we will go back to the US murder data. Suppose we want to summarize the murder rate distribution. Using the data visualization technique we have learned, we can quickly see that the normal approximation does not apply here:</p>
<div class="figure" style="text-align: center"><span id="fig:hist-qqplot-non-normal-data"></span>
<img src="book_files/figure-html/hist-qqplot-non-normal-data-1.png" alt="Histogram and qqplot of US states murder rates." width="70%" />
<p class="caption">
Figure 2.8: Histogram and qqplot of US states murder rates.
</p>
</div>
<p>In this case, the histogram, or a smooth density plot, would serve as a relatively succinct summary.</p>
<p>Now, suppose those used to receiving just two numbers as summaries ask us for a more compact summary.</p>
<p>Here Tukey offered some advice. Provide a five number summary composed of the range along with the quartiles (the 25th, 50th, and 75th percentiles). Tukey further suggested that we ignore <em>outliers</em> when computing the range and instead plot these as independent points. We provide a detailed explanation of outliers later in the chapter. Finally, he suggested we plot these numbers as a “box” with “whiskers”&quot; like this:</p>
<p><img src="book_files/figure-html/first-boxplot-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>with the box defined by the 25% and 75% percentile and the whiskers showing the range. The distance between these two are called the <em>interquartile</em> range. The two points are outliers according to Tukey’s definition. The median is shown with a horizontal line. Today, we call these <em>boxplots</em>.</p>
<p>From just this simple plot we know that the median is about 2.5, that the distribution is not symmetric, and that the range is 0 to 5 for the great majority of states with two exceptions.</p>
<p>Boxplots are even more useful when we want to quickly compare two or more distributions. For example, here are the heights for men and women:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">heights <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x=</span>sex, <span class="dt">y=</span>height, <span class="dt">fill=</span>sex)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_boxplot</span>()</code></pre></div>
<p><img src="book_files/figure-html/female-male-boxplots-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>The plot immediately reveals that males are, on average, taller than females. The standard deviations appear to be similar.</p>
</div>
<div id="case-study-are-female-student-heights-normally-distributed" class="section level2">
<h2><span class="header-section-number">2.7</span> Case study: are female student heights normally distributed?</h2>
<p>We have to give ET a full summary of our heights, but we have not yet summarized female heights. We expect that they will follow a normal distribution, just like males. However, exploratory plots reveal that the approximation is not as useful:</p>
<p><img src="book_files/figure-html/histogram-qqplot-female-heights-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>We see something we did not see for the males: the density plot has a second “bump”.Also, the qqplot shows that the highest points, tend to be taller than expected by the normal distribution. Finally, we also see five points in the qqplot that suggest shorter than expected heights for a normal distribution.<br />
When reporting back to ET we might need to provide a histogram rather than just the average and standard deviation for the female heights.</p>
<p>However, go back and read Tukey’s quote. We have noticed what we didn’t expect to see. If we look at other female height distributions, we do find that they are well approximated with a normal distribution. So why are our female students different? Is our class a requirement for the female basketball team? Are small proportions of females claiming to be taller than they are? Another, perhaps more likely, explanation is that in the form students used to enter their heights, <code>FEMALE</code> was the default sex and some males entered their heights, but forgot to change the sex variable. In any case, data visualization has helped discover a potential flaw in our data.</p>
<p>Regarding the five smallest values, note that these values are:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">heights <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(sex<span class="op">==</span><span class="st">&quot;Female&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">top_n</span>(<span class="dv">5</span>, <span class="kw">desc</span>(height)) <span class="op">%&gt;%</span><span class="st"> </span>.<span class="op">$</span>height
<span class="co">#&gt; [1] 51 53 55 52 52</span></code></pre></div>
<p>Because these are reported heihgts, a possibility is that the student meant to enter 5’1“, 5’2”, 5’3&quot; or 5’5“.</p>

</div>
<div id="robust-summaries" class="section level2">
<h2><span class="header-section-number">2.8</span> Robust summaries</h2>
<div id="outliers" class="section level3">
<h3><span class="header-section-number">2.8.1</span> Outliers</h3>
<p>We previously described how boxplots show <em>outliers</em>, but we did not provide a precise definition. Here we discuss outliers, approaches that can help detect them, and summaries that take into account their presence.</p>
<p>Outliers are very common in data science. Data recording can be complex and it is common to observe data points generated in error. For example, an old monitoring device may read out nonsensical measurements before completely failing. Human error is also a source of outliers, in particular when data entry is done manually. For instance, an individual may mistakenly enter their height in centimeters instead of inches.</p>
<p>Now, how do we distinguish an outlier from measurements that were too big or too small simply due to expected variability? This is not always an easy question to answer, but we try to provide some guidance. Let’s begin with a simple case.</p>
<p>Suppose a colleague is charged with collecting demography data for a group of males. The data is stored in the object:</p>
<pre><code>#&gt;  num [1:500] 5.59 5.8 5.54 6.15 5.83 5.54 5.87 5.93 5.89 5.67 ...</code></pre>
<p>Our colleague uses the fact that heights are usually well approximated by a normal distribution and summarizes the data with average and standard deviation:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">mean</span>(outlier_example)
<span class="co">#&gt; [1] 6.1</span>
<span class="kw">sd</span>(outlier_example)
<span class="co">#&gt; [1] 7.8</span></code></pre></div>
<p>and writes a report on the interesting fact that this group of males is much taller than usual. The average height is over six feet tall! Using your data science skills, however, you notice something else that is unexpected: the standard deviation is over 7 inches. Adding and subtracting two standard deviations, you note that 95% of this population will have heights between -9.489, 21.697 inches which does not make sense.</p>
<p>A quick plot reveals the problem:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">hist</span>(outlier_example)</code></pre></div>
<p><img src="book_files/figure-html/histogram-reveals-outliers-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>There appears to be at least one value that is nonsensical, since we know that a height of 180 feet is impossible. The boxplot detects this point as an outlier:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">boxplot</span>(outlier_example)</code></pre></div>
<p><img src="book_files/figure-html/boxplot-reveals-outliers-1.png" width="70%" style="display: block; margin: auto;" /></p>
</div>
<div id="median" class="section level3">
<h3><span class="header-section-number">2.8.2</span> Median</h3>
<p>When we have an outlier like this, the average can become very large. Keep in mind that mathematically we can make the average as large as we want by simply changing one number: with 500 data points, we can increase the average by any amount <span class="math inline">\(\Delta\)</span> by adding <span class="math inline">\(\Delta \times\)</span> 500 to a single number. The median, defined as the value for which half the values are smaller and the other half are bigger, is robust to such outliers. No matter how large we make the largest point, the median remains the same.</p>
<p>With this data the median is:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">median</span>(outlier_example)
<span class="co">#&gt; [1] 5.74</span></code></pre></div>
<p>which is about 5 feet and 9 inches.</p>
<p>The median is what boxplots display as a horizontal line.</p>
</div>
<div id="the-inter-quartile-range" class="section level3">
<h3><span class="header-section-number">2.8.3</span> The inter quartile range</h3>
<p>The box in boxplots are defined by the first and third quartile. These are meant to provide an idea of the variability in the data: 50% of the data is within this range. The difference between the 3rd and 1st quartile (or 75th and 25th percentiles) is referred to as the inter quartile range (IQR). As is the case with the median, this quantity will be robust to outliers as large values do not affect it. We can do some math to see that for normal data the IQR / 1.349 approximates the standard deviation of the data had an outlier not been present. We can see that this works well in our example since we get a standard deviation estimate of:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">IQR</span>(outlier_example) <span class="op">/</span><span class="st"> </span><span class="fl">1.349</span>
<span class="co">#&gt; [1] 0.245</span></code></pre></div>
<p>which is about 3 inches.</p>
</div>
<div id="tukeys-definition-of-an-outlier" class="section level3">
<h3><span class="header-section-number">2.8.4</span> Tukey’s definition of an outlier</h3>
<p>In R, points falling outside the whiskers of the boxplot are referred to as <em>outliers</em>. This definition of outlier was introduced by Tukey. The top whisker ends at the 75th percentile plus 1.5 <span class="math inline">\(\times\)</span> IQR. Similarly the bottom whisker ends at the 25th percentile minus 1.5<span class="math inline">\(\times\)</span> IQR. If we define the first and third quartiles as <span class="math inline">\(Q_1\)</span> and <span class="math inline">\(Q_3\)</span> respectively, then an outlier is anything outside the range:</p>
<p><span class="math display">\[[Q_1 - 1.5 \times (Q_3 - Q1), Q_3 + 1.5 \times (Q_3 - Q1)]\]</span>.</p>
<p>When the data is normally distributed. the standard units of these values are:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">q3 &lt;-<span class="st"> </span><span class="kw">qnorm</span>(<span class="fl">0.75</span>)
q1 &lt;-<span class="st"> </span><span class="kw">qnorm</span>(<span class="fl">0.25</span>)
iqr &lt;-<span class="st"> </span>q3 <span class="op">-</span><span class="st"> </span>q1
r &lt;-<span class="st"> </span><span class="kw">c</span>(q1 <span class="op">-</span><span class="st"> </span><span class="fl">1.5</span><span class="op">*</span>iqr, q3 <span class="op">+</span><span class="st"> </span><span class="fl">1.5</span><span class="op">*</span>iqr)
r
<span class="co">#&gt; [1] -2.7  2.7</span></code></pre></div>
<p>Using the <code>pnorm</code> function we see that 99.3% of the data falls in this interval.</p>
<p>Keep in mind that this is not such an extreme event: if we have 1000 data points that are randomly distributed, we expect to see about 7 outside of this range. But these would not be outliers since we expect to see them under the typical variation.</p>
<p>If we want an outlier to be rarer, we can increase the 1.5 to a larger number. Tukey also used 3 and called these <em>far out</em> outliers. With a normal distribution 100% of the data falls in this interval. This translates into about 1 in a million chance of being outside the range. In the <code>geom_boxplot</code> function this can be controlled by the <code>outlier.size</code> argument, which defaults to 1.5.</p>
<p>The 180 feet measurement is well beyond the range of the height data:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">max_height &lt;-<span class="st"> </span><span class="kw">quantile</span>(outlier_example, <span class="fl">0.75</span>) <span class="op">+</span><span class="st"> </span><span class="dv">3</span><span class="op">*</span><span class="kw">IQR</span>(outlier_example)</code></pre></div>
<p>If we take this value out, we can see that the data is in fact normally distributed as expected:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">x &lt;-<span class="st"> </span>outlier_example[outlier_example <span class="op">&lt;</span><span class="st"> </span>max_height]
<span class="kw">qqnorm</span>(x)
<span class="kw">qqline</span>(x)</code></pre></div>
<p><img src="book_files/figure-html/outlier-qqnorm-1.png" width="70%" style="display: block; margin: auto;" /></p>
</div>
<div id="median-absolute-deviation" class="section level3">
<h3><span class="header-section-number">2.8.5</span> Median absolute deviation</h3>
<p>Another way to estimate the standard deviation in the presence of outliers is to use the median absolute deviation (MAD). To compute the MAD, we first compute the median, and then for each value we compute the distance between that value and the median. The MAD is defined as the median of these distances. For technical reasons not discussed here, this quantity needs to be multiplied by 1.4826 to assure it approximates the actual standard deviation. The <code>mad</code> function already incorporates this correction. For the height data we get a MAD of:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">mad</span>(outlier_example)
<span class="co">#&gt; [1] 0.237</span></code></pre></div>
<p>which is about 3 inches.</p>
</div>
<div id="exercises-10" class="section level3 unnumbered">
<h3>Exercises</h3>
<p>Load the height data set and create a vector <code>x</code> with just the male heights used in Galton’s data on the heights of parents and their children from his historic research on heredity.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">##You can install data like this install.packages(&quot;HistData&quot;)
<span class="kw">library</span>(HistData)
<span class="kw">data</span>(Galton)
x &lt;-<span class="st"> </span>Galton<span class="op">$</span>child</code></pre></div>
<ol style="list-style-type: decimal">
<li><p>Compute the average and median of these data.</p></li>
<li><p>Compute the median and median absolute deviation of these data.</p></li>
<li><p>Now suppose Galton made a mistake when entering the first value, forgetting to use the decimal point. You can imitate this error by typing:</p></li>
</ol>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">x_with_error &lt;-<span class="st"> </span>x
x_with_error[<span class="dv">1</span>] &lt;-<span class="st"> </span>x_with_error[<span class="dv">1</span>]<span class="op">*</span><span class="dv">10</span></code></pre></div>
<pre><code>How many inches does the average grow after this mistake?</code></pre>
<ol start="4" style="list-style-type: decimal">
<li><p>How many inches does the SD grow after this mistake?</p></li>
<li><p>How many inches does the median grow after this mistake?</p></li>
<li><p>How many inches does the MAD grow after this mistake?</p></li>
<li><p>How could you use exploratory data analysis to detect that an error was made?</p></li>
</ol>
<p>A. Since it is only one value out of many, we will not be able to detect this. B. We would see an obvious shift in the distribution. C. A boxplot, histogram, or qq-plot would reveal a clear outlier. D. A scatter plot would show high levels of measurement error.</p>
<ol start="8" style="list-style-type: decimal">
<li>How much can the average accidentally grow with mistakes like this? Write a function called <code>error_avg</code> that takes a value <code>k</code> and returns the average of the vector <code>x</code> after the first entry changed to <code>k</code>. Show the results for <code>k=10000</code> and <code>k=-10000</code>.</li>
</ol>
</div>
</div>
<div id="case-study-self-reported-heights" class="section level2">
<h2><span class="header-section-number">2.9</span> Case Study: self-reported heights</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">data</span>(reported_heights)
<span class="kw">str</span>(reported_heights)
<span class="co">#&gt; &#39;data.frame&#39;:    1095 obs. of  3 variables:</span>
<span class="co">#&gt;  $ time_stamp: chr  &quot;2014-09-02 13:40:36&quot; &quot;2014-09-02 13:46:59&quot; &quot;2014-09-02 13:59:20&quot; &quot;2014-09-02 14:51:53&quot; ...</span>
<span class="co">#&gt;  $ sex       : chr  &quot;Male&quot; &quot;Male&quot; &quot;Male&quot; &quot;Male&quot; ...</span>
<span class="co">#&gt;  $ height    : chr  &quot;75&quot; &quot;70&quot; &quot;68&quot; &quot;74&quot; ...</span></code></pre></div>
<p>Height is a character vector so we create a new column with the numeric version:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">reported_heights &lt;-<span class="st"> </span>reported_heights <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">original_heights =</span> height, <span class="dt">height =</span> <span class="kw">as.numeric</span>(height))</code></pre></div>
<p>We get a warning about NAs. This is because some of the self reported heights were not numbers. We can see why we get these:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">reported_heights <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(<span class="kw">is.na</span>(height)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">head</span>()
<span class="co">#&gt;            time_stamp    sex height original_heights</span>
<span class="co">#&gt; 1 2014-09-02 15:16:28   Male     NA            5&#39; 4&quot;</span>
<span class="co">#&gt; 2 2014-09-02 15:16:37 Female     NA            165cm</span>
<span class="co">#&gt; 3 2014-09-02 15:16:52   Male     NA              5&#39;7</span>
<span class="co">#&gt; 4 2014-09-02 15:16:56   Male     NA            &gt;9000</span>
<span class="co">#&gt; 5 2014-09-02 15:16:56   Male     NA             5&#39;7&quot;</span>
<span class="co">#&gt; 6 2014-09-02 15:17:09 Female     NA             5&#39;3&quot;</span></code></pre></div>
<p>Some students self reported their heights using feet and inches rather than just inches. Others used centimeters and others were just trolling. For now we will remove these entries:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">reported_heights &lt;-<span class="st"> </span><span class="kw">filter</span>(reported_heights, <span class="op">!</span><span class="kw">is.na</span>(height))</code></pre></div>
<p>If we compute the average and standard deviation, we notice that we obtain strange results. The average and standard deviation are different from the median and MAS:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">reported_heights <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(sex) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarize</span>(<span class="dt">average =</span> <span class="kw">mean</span>(height), <span class="dt">sd =</span> <span class="kw">sd</span>(height),
            <span class="dt">median =</span> <span class="kw">median</span>(height), <span class="dt">MAD =</span> <span class="kw">mad</span>(height))
<span class="co">#&gt; # A tibble: 2 x 5</span>
<span class="co">#&gt;      sex average    sd median   MAD</span>
<span class="co">#&gt;    &lt;chr&gt;   &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;</span>
<span class="co">#&gt; 1 Female    63.4  27.9   64.2  4.05</span>
<span class="co">#&gt; 2   Male   103.4 529.9   70.0  4.45</span></code></pre></div>
<p>This suggests that we have outliers, which is confirmed by simply creating a boxplot:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">reported_heights <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(sex, height)) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">geom_boxplot</span>()</code></pre></div>
<p><img src="book_files/figure-html/height-outlier-ggplot-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>We can see some rather extreme values. To see what these values are, we can quickly look at the largest values using the <code>arrange</code> function:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">reported_heights <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">arrange</span>(<span class="kw">desc</span>(height)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">top_n</span>(<span class="dv">10</span>, height)
<span class="co">#&gt;             time_stamp    sex height original_heights</span>
<span class="co">#&gt; 1  2014-09-03 23:55:37   Male  11111            11111</span>
<span class="co">#&gt; 2  2016-04-10 22:45:49   Male  10000            10000</span>
<span class="co">#&gt; 3  2015-08-10 03:10:01   Male    684              684</span>
<span class="co">#&gt; 4  2015-02-27 18:05:06   Male    612              612</span>
<span class="co">#&gt; 5  2014-09-02 15:16:41   Male    511              511</span>
<span class="co">#&gt; 6  2014-09-07 20:53:43   Male    300              300</span>
<span class="co">#&gt; 7  2014-11-28 12:18:40   Male    214              214</span>
<span class="co">#&gt; 8  2017-04-03 16:16:57   Male    210              210</span>
<span class="co">#&gt; 9  2015-11-24 10:39:45   Male    192              192</span>
<span class="co">#&gt; 10 2014-12-26 10:00:12   Male    190              190</span>
<span class="co">#&gt; 11 2016-11-06 10:21:02 Female    190              190</span></code></pre></div>
<p>The first seven entries look like strange errors. However, the next few look like they were entered as centimeters instead of inches. Since 184 cm is equivalent to six feet tall, we suspect that 184 was actually meant to be 72 inches.</p>
<p>We can review all the nonsensical answers by looking at the data considered to be <em>far out</em> by Tukey:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">max_height &lt;-<span class="st"> </span><span class="kw">quantile</span>(reported_heights<span class="op">$</span>height, .<span class="dv">75</span>) <span class="op">+</span><span class="st"> </span><span class="dv">3</span><span class="op">*</span><span class="kw">IQR</span>(reported_heights<span class="op">$</span>height)
min_height &lt;-<span class="st"> </span><span class="kw">quantile</span>(reported_heights<span class="op">$</span>height, .<span class="dv">25</span>) <span class="op">-</span><span class="st"> </span><span class="dv">3</span><span class="op">*</span><span class="kw">IQR</span>(reported_heights<span class="op">$</span>height)
<span class="kw">c</span>(min_height, max_height )
<span class="co">#&gt; 25% 75% </span>
<span class="co">#&gt;  44  93</span></code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">outliers &lt;-<span class="st"> </span>reported_heights <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">between</span>(height, min_height, max_height)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">arrange</span>(height)
outliers<span class="op">$</span>height
<span class="co">#&gt;   [1]     0.00     0.70     1.00     1.00     1.00     1.60     1.70</span>
<span class="co">#&gt;   [8]     2.00     5.00     5.00     5.00     5.00     5.10     5.10</span>
<span class="co">#&gt;  [15]     5.10     5.10     5.11     5.11     5.11     5.11     5.20</span>
<span class="co">#&gt;  [22]     5.20     5.20     5.25     5.25     5.30     5.40     5.40</span>
<span class="co">#&gt;  [29]     5.50     5.50     5.50     5.50     5.50     5.50     5.50</span>
<span class="co">#&gt;  [36]     5.50     5.50     5.50     5.50     5.51     5.57     5.60</span>
<span class="co">#&gt;  [43]     5.60     5.60     5.60     5.60     5.60     5.60     5.69</span>
<span class="co">#&gt;  [50]     5.70     5.70     5.70     5.70     5.70     5.70     5.70</span>
<span class="co">#&gt;  [57]     5.75     5.80     5.80     5.80     5.80     5.80     5.90</span>
<span class="co">#&gt;  [64]     5.90     5.90     5.90     6.00     6.00     6.00     6.00</span>
<span class="co">#&gt;  [71]     6.00     6.00     6.00     6.00     6.00     6.00     6.00</span>
<span class="co">#&gt;  [78]     6.00     6.00     6.00     6.00     6.00     6.00     6.00</span>
<span class="co">#&gt;  [85]     6.00     6.10     6.10     6.20     6.20     6.30     6.50</span>
<span class="co">#&gt;  [92]     6.50     6.50     6.70     7.00    12.00    19.00    22.00</span>
<span class="co">#&gt;  [99]    23.00    25.00    34.00    34.00   100.00   103.20   111.00</span>
<span class="co">#&gt; [106]   120.00   120.00   150.00   150.00   152.00   157.00   157.00</span>
<span class="co">#&gt; [113]   158.00   158.00   158.00   159.00   160.00   160.00   161.00</span>
<span class="co">#&gt; [120]   162.00   162.00   162.00   163.00   164.00   164.00   165.00</span>
<span class="co">#&gt; [127]   165.00   165.00   167.00   167.00   167.00   168.00   168.00</span>
<span class="co">#&gt; [134]   168.00   168.00   169.00   169.00   169.00   169.00   170.00</span>
<span class="co">#&gt; [141]   170.00   170.00   170.00   170.00   170.00   170.00   170.00</span>
<span class="co">#&gt; [148]   170.00   172.00   172.00   172.00   172.00   172.00   172.00</span>
<span class="co">#&gt; [155]   172.00   173.00   173.00   173.00   174.00   174.00   174.00</span>
<span class="co">#&gt; [162]   174.00   175.00   175.00   175.00   175.00   175.00   176.00</span>
<span class="co">#&gt; [169]   176.00   177.00   178.00   178.00   178.00   178.00   178.00</span>
<span class="co">#&gt; [176]   179.00   180.00   180.00   180.00   180.00   180.00   180.00</span>
<span class="co">#&gt; [183]   180.00   180.00   180.00   182.00   183.00   183.00   183.00</span>
<span class="co">#&gt; [190]   184.00   184.00   184.00   185.00   185.00   186.00   190.00</span>
<span class="co">#&gt; [197]   190.00   192.00   210.00   214.00   300.00   511.00   612.00</span>
<span class="co">#&gt; [204]   684.00 10000.00 11111.00</span></code></pre></div>
<p>Examining these heights we see two common mistakes: entries in centimeters, which turn out to be too large, and entries of the form <code>x.y</code> with <code>x</code> and <code>y</code> representing feet and inches respectively. Some of the even smaller values, such as 1.6, could be entries in meters.</p>
<p>In the Data Wrangling Chapter, we will learn techniques for correcting these values and converting them into inches. Here we were able to detect this problem using careful data exploration to uncover issues with the data: the first step in the great majority of data science projects.</p>

</div>
<div id="summarizing-data-with-dplyr" class="section level2">
<h2><span class="header-section-number">2.10</span> Summarizing data with dplyr</h2>
<p>An important part of exploratory data analysis is summarizing data. We learned about the average and standard deviation as a two summary statistic that provides all the necessary information to summarize data that is normally distributed. We also learned that better summaries can be achieved by splitting data into groups before using the normal approximation. For example, in our heights dataset we described the height of men and women separately. In this section we cover two new dplyr verbs that make these computations easier: <code>summarize</code> and <code>group_by</code>. We learn to access resulting values using what we call the <em>dot placeholder</em>. Finally, we also learn to use <code>arrange</code> which helps us examine data after sorting.</p>
<div id="summarize" class="section level3">
<h3><span class="header-section-number">2.10.1</span> Summarize</h3>
<p>The <code>summarize</code> function in dplyr provides a way to compute summary statistics with intuitive and readable code. We start with a simple example based on heights:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(dslabs)
<span class="kw">data</span>(heights)</code></pre></div>
<p>that computes the average and standard deviation for males:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">s &lt;-<span class="st"> </span>heights <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(sex <span class="op">==</span><span class="st"> &quot;Male&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarize</span>(<span class="dt">average =</span> <span class="kw">mean</span>(height), <span class="dt">standard_deviation =</span> <span class="kw">sd</span>(height))
s
<span class="co">#&gt;   average standard_deviation</span>
<span class="co">#&gt; 1    69.3               3.61</span></code></pre></div>
<p>This takes our original data table as input, filters it to keep only males and then produces a new, summarized table with just the average and the standard deviation of heights. We get to choose the names of the columns of the resulting table. For example, above we decided to use <code>average</code> and <code>standard_deviation</code>, but we could have used other names just the same.</p>
<p>Because the resulting table, stored in <code>s</code>, is a data frame, we can access the components with the accessor <code>$</code>, which in this case will be a numeric:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">s<span class="op">$</span>average
<span class="co">#&gt; [1] 69.3</span>
s<span class="op">$</span>standard_deviation
<span class="co">#&gt; [1] 3.61</span></code></pre></div>
<p>As with most other dplyr functions, <code>summarize</code> is aware of the variable names and we can use them directly. So when inside the call to the <code>summarize</code> function we write <code>mean(height)</code>, it is accessing the column with the name, and then computing the average of the respective numeric vector. We can compute any other summary that operates on vectors and returns a single value. For example, we can add the median, min and max like this:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">heights <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(sex <span class="op">==</span><span class="st"> &quot;Male&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarize</span>(<span class="dt">median =</span> <span class="kw">median</span>(height), <span class="dt">minimum =</span> <span class="kw">min</span>(height), <span class="dt">maximum =</span> <span class="kw">max</span>(height))
<span class="co">#&gt;   median minimum maximum</span>
<span class="co">#&gt; 1     69      50    82.7</span></code></pre></div>
<p>We can obtain these three values with just one line using the <code>quantiles</code> function. For example, <code>quantile(x, c(0,0.5,1))</code> returns the min, median, and max of the vector <code>x</code>. However, if we attempt to use a function that returns two or more values:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">heights <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(sex <span class="op">==</span><span class="st"> &quot;Male&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarize</span>(<span class="dt">range =</span> <span class="kw">quantile</span>(height, <span class="kw">c</span>(<span class="dv">0</span>, <span class="fl">0.5</span>, <span class="dv">1</span>)))</code></pre></div>
<p>we will receive an error: <code>Error: expecting result of length one, got : 2</code>. With the function <code>summarize</code> we can only call functions that return a single value. In a later chapter, we will learn how to deal with functions that return more than one value.</p>
<p>For another example of how we can use the <code>summarize</code> function, let’s compute the average murder rate for the United States. Remember our data table includes total murders and population size for each state and we have already used dplyr to add a murder rate column:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">data</span>(murders)
murders &lt;-<span class="st"> </span>murders <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">murder_rate =</span> total<span class="op">/</span>population<span class="op">*</span><span class="dv">100000</span>)</code></pre></div>
<p>Remember that the US murder is <strong>not</strong> the average of the state murder rates:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summarize</span>(murders, <span class="kw">mean</span>(murder_rate))
<span class="co">#&gt;   mean(murder_rate)</span>
<span class="co">#&gt; 1              2.78</span></code></pre></div>
<p>This is because in the computation above the small states are given the same weight as the large ones. The US murder rate is the totalUS murders divided by the total US population. So the correct computation is:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">us_murder_rate &lt;-<span class="st"> </span>murders <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">summarize</span>(<span class="dt">rate =</span> <span class="kw">sum</span>(total) <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(population) <span class="op">*</span><span class="st"> </span><span class="dv">100000</span>)
us_murder_rate
<span class="co">#&gt;   rate</span>
<span class="co">#&gt; 1 3.03</span></code></pre></div>
<p>This computation counts larger states proportionally to their size which results in a larger value.</p>
</div>
<div id="using-the-dot-to-access-the-piped-data" class="section level3">
<h3><span class="header-section-number">2.10.2</span> Using the dot to access the piped data</h3>
<p>The <code>us_murder_rate</code> object defined above represents just one number. Yet we are storing it in a data frame:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">class</span>(us_murder_rate)
<span class="co">#&gt; [1] &quot;data.frame&quot;</span></code></pre></div>
<p>since, as most dplyr functions, <code>summarize</code> always returns a data frame.</p>
<p>This might be problematic if we want to use the result with functions that require a numeric value. Here we show a useful trick for accessing values stored in data piped via <code>%&gt;%</code>: when a data object is piped it can be accessed using the dot <code>.</code>. To understand what we mean take a look at this line of code:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">us_murder_rate <span class="op">%&gt;%</span><span class="st"> </span>.<span class="op">$</span>rate 
<span class="co">#&gt; [1] 3.03</span></code></pre></div>
<p>This returns the value in the <code>rate</code> column of <code>us_murder_rate</code> making it equivalent to <code>us_murder_rate$rate</code>. To understand this line, you just need to think of <code>.</code> as a placeholder for the data that is being passed through the pipe. Because this data object is a data frame, we can access its columns with the <code>$</code>.</p>
<p>To get a number from the original data table with one line of code we can type:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">us_murder_rate &lt;-<span class="st"> </span>murders <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">summarize</span>(<span class="dt">rate =</span> <span class="kw">sum</span>(total) <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(population) <span class="op">*</span><span class="st"> </span><span class="dv">100000</span>) <span class="op">%&gt;%</span>
<span class="st">  </span>.<span class="op">$</span>rate

us_murder_rate
<span class="co">#&gt; [1] 3.03</span></code></pre></div>
<p>which is now a numeric:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">class</span>(us_murder_rate)
<span class="co">#&gt; [1] &quot;numeric&quot;</span></code></pre></div>
<p>We will see other instances in which using the <code>.</code> is useful. For now, we will only use it to produce numeric vectors from pipelines constructed with dplyr.</p>
</div>
<div id="group-then-summarize" class="section level3">
<h3><span class="header-section-number">2.10.3</span> Group then summarize</h3>
<p>A common operation in data exploration is to first split data into groups and then compute summaries for each group. For example, we may want to compute the average and standard deviation for men’s and women’s heights separately. The <code>group_by</code> function helps us do this.</p>
<p>If we type this:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">heights <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(sex)
<span class="co">#&gt; # A tibble: 1,050 x 2</span>
<span class="co">#&gt; # Groups:   sex [2]</span>
<span class="co">#&gt;      sex height</span>
<span class="co">#&gt;   &lt;fctr&gt;  &lt;dbl&gt;</span>
<span class="co">#&gt; 1   Male     75</span>
<span class="co">#&gt; 2   Male     70</span>
<span class="co">#&gt; 3   Male     68</span>
<span class="co">#&gt; 4   Male     74</span>
<span class="co">#&gt; 5   Male     61</span>
<span class="co">#&gt; 6 Female     65</span>
<span class="co">#&gt; # ... with 1,044 more rows</span></code></pre></div>
<p>the result does not look very different from <code>heights</code>, except we see this <code>Groups: sex [2]</code> when we print the object. Although not immediately obvious from its appearance, this is now a special data frame called a <em>grouped data frame</em> and dplyr functions, in particular <code>summarize</code>, will behave differently when acting on this object. Conceptually you can think of this table as many tables, with the same columns but not necessarily the same number of rows, stacked together in one object. When we summarize the data after grouping, this is what happens:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">heights <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(sex) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarize</span>(<span class="dt">average =</span> <span class="kw">mean</span>(height), <span class="dt">standard_deviation =</span> <span class="kw">sd</span>(height))
<span class="co">#&gt; # A tibble: 2 x 3</span>
<span class="co">#&gt;      sex average standard_deviation</span>
<span class="co">#&gt;   &lt;fctr&gt;   &lt;dbl&gt;              &lt;dbl&gt;</span>
<span class="co">#&gt; 1 Female    64.9               3.76</span>
<span class="co">#&gt; 2   Male    69.3               3.61</span></code></pre></div>
<p>The <code>summarize</code> function applies the summarization to each group separately.</p>
<p>For another example, let’s compute the median murder rate in the four regions of the country:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">murders <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(region) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarize</span>(<span class="dt">median_rate =</span> <span class="kw">median</span>(murder_rate))
<span class="co">#&gt; # A tibble: 4 x 2</span>
<span class="co">#&gt;          region median_rate</span>
<span class="co">#&gt;          &lt;fctr&gt;       &lt;dbl&gt;</span>
<span class="co">#&gt; 1     Northeast        1.80</span>
<span class="co">#&gt; 2         South        3.40</span>
<span class="co">#&gt; 3 North Central        1.97</span>
<span class="co">#&gt; 4          West        1.29</span></code></pre></div>
</div>
<div id="sorting-data-tables" class="section level3">
<h3><span class="header-section-number">2.10.4</span> Sorting data tables</h3>
<p>When examining a dataset it is often convenient to sort the table by the different columns. We know about the <code>order</code> and <code>sort</code> function, but for ordering entire tables, the dplyr function <code>arrange</code> is useful. For example, here we order the states by population size when we type:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">murders <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">arrange</span>(population) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">head</span>()
<span class="co">#&gt;                  state abb        region population total murder_rate</span>
<span class="co">#&gt; 1              Wyoming  WY          West     563626     5       0.887</span>
<span class="co">#&gt; 2 District of Columbia  DC         South     601723    99      16.453</span>
<span class="co">#&gt; 3              Vermont  VT     Northeast     625741     2       0.320</span>
<span class="co">#&gt; 4         North Dakota  ND North Central     672591     4       0.595</span>
<span class="co">#&gt; 5               Alaska  AK          West     710231    19       2.675</span>
<span class="co">#&gt; 6         South Dakota  SD North Central     814180     8       0.983</span></code></pre></div>
<p>We get to decide which column to sort by. To see the states by population, from smallest to largest, we arrange by <code>murder_rate</code> instead:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">murders <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">arrange</span>(murder_rate) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">head</span>()
<span class="co">#&gt;           state abb        region population total murder_rate</span>
<span class="co">#&gt; 1       Vermont  VT     Northeast     625741     2       0.320</span>
<span class="co">#&gt; 2 New Hampshire  NH     Northeast    1316470     5       0.380</span>
<span class="co">#&gt; 3        Hawaii  HI          West    1360301     7       0.515</span>
<span class="co">#&gt; 4  North Dakota  ND North Central     672591     4       0.595</span>
<span class="co">#&gt; 5          Iowa  IA North Central    3046355    21       0.689</span>
<span class="co">#&gt; 6         Idaho  ID          West    1567582    12       0.766</span></code></pre></div>
<p>Note that the default behavior is to order in ascending order. In dplyr, the function <code>desc</code> transforms a vector so that it is in descending order. To sort the table in descending order we can type:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">murders <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">arrange</span>(<span class="kw">desc</span>(murder_rate)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">head</span>()
<span class="co">#&gt;                  state abb        region population total murder_rate</span>
<span class="co">#&gt; 1 District of Columbia  DC         South     601723    99       16.45</span>
<span class="co">#&gt; 2            Louisiana  LA         South    4533372   351        7.74</span>
<span class="co">#&gt; 3             Missouri  MO North Central    5988927   321        5.36</span>
<span class="co">#&gt; 4             Maryland  MD         South    5773552   293        5.07</span>
<span class="co">#&gt; 5       South Carolina  SC         South    4625364   207        4.48</span>
<span class="co">#&gt; 6             Delaware  DE         South     897934    38        4.23</span></code></pre></div>
<div id="nested-sorting" class="section level4 unnumbered">
<h4>Nested sorting</h4>
<p>If we are ordering by a column with ties, we can use a second column to break the tie. Similarly, a third column can be used to break ties between first and second and so on. Here we order by <code>region</code> then, within region, we order by murder rate:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">murders <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">arrange</span>(region, murder_rate) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">head</span>()
<span class="co">#&gt;           state abb    region population total murder_rate</span>
<span class="co">#&gt; 1       Vermont  VT Northeast     625741     2       0.320</span>
<span class="co">#&gt; 2 New Hampshire  NH Northeast    1316470     5       0.380</span>
<span class="co">#&gt; 3         Maine  ME Northeast    1328361    11       0.828</span>
<span class="co">#&gt; 4  Rhode Island  RI Northeast    1052567    16       1.520</span>
<span class="co">#&gt; 5 Massachusetts  MA Northeast    6547629   118       1.802</span>
<span class="co">#&gt; 6      New York  NY Northeast   19378102   517       2.668</span></code></pre></div>
</div>
<div id="the-top-n" class="section level4">
<h4><span class="header-section-number">2.10.4.1</span> The top <span class="math inline">\(n\)</span></h4>
<p>In the code above we have used the function <code>head</code> to avoid having the page fill up with the entire dataset. If we want to see a larger proportion, we can use the <code>top_n</code> function. Here are the first 10 rows:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">murders <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">top_n</span>(<span class="dv">10</span>, murder_rate)
<span class="co">#&gt;                   state abb        region population total murder_rate</span>
<span class="co">#&gt; 1               Arizona  AZ          West    6392017   232        3.63</span>
<span class="co">#&gt; 2              Delaware  DE         South     897934    38        4.23</span>
<span class="co">#&gt; 3  District of Columbia  DC         South     601723    99       16.45</span>
<span class="co">#&gt; 4               Georgia  GA         South    9920000   376        3.79</span>
<span class="co">#&gt; 5             Louisiana  LA         South    4533372   351        7.74</span>
<span class="co">#&gt; 6              Maryland  MD         South    5773552   293        5.07</span>
<span class="co">#&gt; 7              Michigan  MI North Central    9883640   413        4.18</span>
<span class="co">#&gt; 8           Mississippi  MS         South    2967297   120        4.04</span>
<span class="co">#&gt; 9              Missouri  MO North Central    5988927   321        5.36</span>
<span class="co">#&gt; 10       South Carolina  SC         South    4625364   207        4.48</span></code></pre></div>
<p><code>top_n</code> picks the highest <code>n</code> based on the column given as a second argument. However, the rows are not sorted.</p>
<p>If the second argument is left blank, then it returns the first <code>n</code> columns. This means that to see the 10 states with the highest murder rates we can type:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">murders <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">arrange</span>(<span class="kw">desc</span>(murder_rate)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">top_n</span>(<span class="dv">10</span>)
<span class="co">#&gt; Selecting by murder_rate</span>
<span class="co">#&gt;                   state abb        region population total murder_rate</span>
<span class="co">#&gt; 1  District of Columbia  DC         South     601723    99       16.45</span>
<span class="co">#&gt; 2             Louisiana  LA         South    4533372   351        7.74</span>
<span class="co">#&gt; 3              Missouri  MO North Central    5988927   321        5.36</span>
<span class="co">#&gt; 4              Maryland  MD         South    5773552   293        5.07</span>
<span class="co">#&gt; 5        South Carolina  SC         South    4625364   207        4.48</span>
<span class="co">#&gt; 6              Delaware  DE         South     897934    38        4.23</span>
<span class="co">#&gt; 7              Michigan  MI North Central    9883640   413        4.18</span>
<span class="co">#&gt; 8           Mississippi  MS         South    2967297   120        4.04</span>
<span class="co">#&gt; 9               Georgia  GA         South    9920000   376        3.79</span>
<span class="co">#&gt; 10              Arizona  AZ          West    6392017   232        3.63</span></code></pre></div>
</div>
</div>
<div id="exercises-11" class="section level3 unnumbered">
<h3>Exercises</h3>
<p>For these exercesis we will be using the data from the survey collected by the United States National Center for Health Statistics (NCHS). This center has conducted a series of health and nutrition surveys since the 1960’s. Starting in 1999 about 5,000 individuals of all ages have been interviewed every year and they complete the health examination component of the survey. Part of the data is made avaialble via the NHANES package which can install using</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">install.packages</span>(<span class="st">&quot;NHANES&quot;</span>)</code></pre></div>
<p>Once you install it you can load the data this way:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(NHANES)
<span class="kw">data</span>(NHANES)</code></pre></div>
<p>The NHANES data has many missing values. Remember that the main summarization function in R will return <code>NA</code> if any of the entries of the input vector is an <code>NA</code>. Here is an example:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(dslabs)
<span class="kw">data</span>(na_example)
<span class="kw">mean</span>(na_example)
<span class="co">#&gt; [1] NA</span>
<span class="kw">sd</span>(na_example)
<span class="co">#&gt; [1] NA</span></code></pre></div>
<p>To ignore the <code>NA</code>s we can use the <code>na.rm</code> argument:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">mean</span>(na_example, <span class="dt">na.rm=</span><span class="ot">TRUE</span>)
<span class="co">#&gt; [1] 2.3</span>
<span class="kw">sd</span>(na_example, <span class="dt">na.rm=</span><span class="ot">TRUE</span>)
<span class="co">#&gt; [1] 1.22</span></code></pre></div>
<p>Let’s now explore the NHANES data.</p>
<ol style="list-style-type: decimal">
<li><p>We will provide some basic facts about blood pressure. First let’s select a group to set the standard. We will use 20-29 year old females. Note that the category is coded with <code>20-29</code>, with a space in front! The <code>AgeDecade</code> is a categorical variable with these ages. What is the average and standard deviation of systolic blood pressure, as saved in the <code>BPSysAve</code> variable? Save it to a variable called <code>ref</code>. Hint: Use <code>filter</code> and <code>summarize</code> and use the <code>na.rm=TRUE</code> argument when computing the average and standard deviation. You can also filter the NA values using <code>filter</code>.</p></li>
<li><p>Using only one line of code, assign the average to a numeric variable <code>ref_avg</code>. Hint: Use the code similar to above and then the dot.</p></li>
<li><p>Now report the min and max values for the same group.</p></li>
<li><p>Now compute the average and standard deviation for females, but for each age group separately. Note that the age groups are defined by <code>AgeDecade</code>. Hint: rather than filtering by age, filter by <code>Gender</code> and then use <code>group_by</code>.</p></li>
<li><p>Now do the same for males.</p></li>
<li><p>We can actually combine both these summaries into one line of code. This is because <code>group_by</code> permits us to group by more than one variable. Obtain one big summary table using <code>group_by(AgeDecade, Gender)</code>.</p></li>
<li><p>For males between the ages of 40-49, compare systolic blood pressure across race as reported in the <code>Race1</code> variable. Order the resulting table from lowest to highest average systolic blood pressure.</p></li>
</ol>

</div>
</div>
<div id="a-first-introduction-to-ggplot2" class="section level2">
<h2><span class="header-section-number">2.11</span> A first introduction to ggplot2</h2>
<p>We have now described several data visualization techniques and are ready to learn how to create them in R. Throughout the book we will be using the <a href="http://ggplot2.org">ggplot2</a> package. We can load it, along with dplyr, as part of the tidyverse:</p>
<p>Many other approaches are available for creating plots in R. In fact, the plotting capabilities that come with a basic installation of R are already quite powerful. We have seen examples of these already with the functions <code>plot</code>, <code>hist</code> and <code>boxplot</code>. There are also other packages for creating graphics such as <code>grid</code> and <code>lattice</code>. We chose to use ggplot2 in this book because it breaks plots into components in a way that permits beginners to create relatively complex and aesthetically pleasing plots using syntax that is intuitive and relatively easy to remember.</p>
<p>One reason ggplot2 is generally more intuitive for beginners is that it uses a <a href="http://www.springer.com/us/book/9780387245447">grammar of graphics</a>, the <em>gg</em> in ggplot2. This is analogous to the way learning grammar can help a beginner construct hundreds of different sentences by learning just a handful of verbs, nouns and adjectives without having to memorize each specific sentence. Similarly, by learning a handful of ggplot2 building blocks and its grammar, you will be able to create hundreds of different plots.</p>
<p>Another reason ggplot2 makes it easier for beginners is that its default behavior is carefully chosen to satisfy the great majority of cases and is aesthetically pleasing. As a result, it is possible to create informative and elegant graphs with relatively simple and readable code.</p>
<p>One limitation is that ggplot2 is designed to work exclusively with data tables in which rows are observations and columns are variables. However, a substantial percentage of datasets that beginners work with are, or can be converted into, this format. An advantage of this approach is that, assuming that our data follows this format, it simplifies the code and learning the grammar.</p>
<div id="the-cheat-sheet" class="section level3">
<h3><span class="header-section-number">2.11.1</span> The cheat sheet</h3>
<p>To use ggplot2 you will have to learn several functions and arguments. These are hard to memorize so we highly recommend you have the a <a href="https://www.rstudio.com/wp-content/uploads/2015/03/ggplot2-cheatsheet.pdf">ggplot2 sheet cheat</a> handy. You can get a copy here: <a href="https://www.rstudio.com/wp-content/uploads/2015/03/ggplot2-cheatsheet.pdf" class="uri">https://www.rstudio.com/wp-content/uploads/2015/03/ggplot2-cheatsheet.pdf</a> or simply perform a ninternet search for “ggplot2 cheat sheet”.</p>
</div>
<div id="the-components-of-a-graph" class="section level3">
<h3><span class="header-section-number">2.11.2</span> The components of a graph</h3>
<p>We construct a graph that summarizes the US murders dataset:</p>
<div class="figure" style="text-align: center"><span id="fig:ggplot-example-plot"></span>
<img src="book_files/figure-html/ggplot-example-plot-1.png" alt="Muder totals versus population size for US states." width="70%" />
<p class="caption">
Figure 2.9: Muder totals versus population size for US states.
</p>
</div>
<p>We can clearly see how much states vary across population size and the total number of murders. Not surprisingly, we also see a clear relationship between murder totals and population size. A state falling on the dashed grey line has the same murder rate as the US average. The four geographic regions are denoted with color which depicts how most southern states have murder rates above the average.</p>
<p>This data visualization shows us pretty much all the information in the data table. The code needed to make this plot is relatively simple. We will learn to create the plot part by part.</p>
</div>
<div id="the-components-of-a-graph-1" class="section level3">
<h3><span class="header-section-number">2.11.3</span> The components of a graph</h3>
<p>The first step in learning ggplot2 is to be able to break a graph apart into components. Let’s break down the plot above and introduce some of the ggplot2 terminology. The main three components to note are:</p>
<ol style="list-style-type: decimal">
<li><strong>Data</strong>: The US murders data table is being summarized. We refer to this as the <strong>data</strong> component.</li>
<li><strong>Geometry</strong>: The plot above is a scatter plot. This is referred to as the <strong>geometry</strong> component. Other possible geometries are barplot, histograms, smooth densities, qqplots, and boxplots.</li>
<li><strong>Aesthetic mapping</strong>: The x-axis values are used to display population size, the y-axis values are used to display the total number of murders, text is used to identify the states, and colors are used to denote the four different regions. These are the <strong>aesthetic mappings</strong> component. How we define the mapping depends on what <strong>geometry</strong> we are using.</li>
</ol>
<p>We also note that:</p>
<ol start="4" style="list-style-type: decimal">
<li>The range of the x-axis and y-axis appears to be defined by the range of the data. They are both on log-scales. We refer to this as the <strong>scale</strong> component.</li>
<li>There are labels, a title, a legend, and we use the style of The Economist magazine.</li>
</ol>
<p>We will now construct the plot piece by piece. We start by loading the dataset:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(dslabs)
<span class="kw">data</span>(murders)</code></pre></div>
</div>
<div id="creating-a-blank-slate-ggplot-object" class="section level3">
<h3><span class="header-section-number">2.11.4</span> Creating a blank slate <code>ggplot</code> object</h3>
<p>The first step in creating a ggplot2 graph is to define a <code>ggplot</code> object. We do this with the function <code>ggplot</code> which initializes the graph. If we read the help file for this function, we see that the first argument is used to specify what data is associated with this object:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(<span class="dt">data =</span> murders)</code></pre></div>
<p>We can also pipe the data. So this line of code is equivalent to the one above:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">murders <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">ggplot</span>()</code></pre></div>
<p><img src="book_files/figure-html/ggplot-example-2-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>It renders a plot, in this case a blank slate, since no geometry has been defined. The only style choice we see is a grey background.</p>
<p>What has happened above is that the object was created and because it was not assigned, it was automatically evaluated. But we can define an object, for example, like this:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> murders)
<span class="kw">class</span>(p)
<span class="co">#&gt; [1] &quot;gg&quot;     &quot;ggplot&quot;</span></code></pre></div>
<p>To render the plot associated with this object we simply print the object <code>p</code>. The following two lines of code produce the same plot we see above:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">print</span>(p)
p</code></pre></div>
</div>
<div id="layers" class="section level3">
<h3><span class="header-section-number">2.11.5</span> Layers</h3>
<p>In ggplot we create graphs by adding <em>layers</em>. Layers can define geometries, compute summary statistics, define what scales to use, or even change styles. To add layers, we use the the symbol <code>+</code>. In general a line of code will look like this:</p>
<blockquote>
<blockquote>
<p>DATA %&gt;% <code>ggplot()</code> + LAYER 1 + LAYER 2 + … + LAYER N</p>
</blockquote>
</blockquote>
<p>Usually, the first added layer defines the geometry. We want to make a scatter plot. So what geometry do we use?</p>
</div>
<div id="geometry" class="section level3">
<h3><span class="header-section-number">2.11.6</span> Geometry</h3>
<p>Taking a quick look at the cheat sheet we see that the function used to create plots with this geometry is <code>geom_point</code>.</p>
<p><img src="img/ggplot2-cheatsheeta.png" width="70%" style="display: block; margin: auto;" /></p>
<p><img src="img/ggplot2-cheatsheetb.png" width="70%" style="display: block; margin: auto;" /></p>
<p>Geometry function names follow this pattern: <code>geom</code> and the name of the geometry connected by an underscore.</p>
<p>For <code>geom_point</code> to know what to do, we need to provide data and a mapping. We have already connected the object <code>p</code> with the <code>murders</code> data table and if we add as a layer <code>geom_point</code>, we will default to using this data. To find out what mapping are expected we read the <strong>Aesthetics</strong> section of the help file <code>geom_point</code> help file:</p>
<blockquote>
<p>Aesthetics</p>
<p>geom_point understands the following aesthetics (required aesthetics are in bold):</p>
<p>x</p>
<p>y</p>
<p>alpha</p>
<p>colour</p>
</blockquote>
<p>and, as expected, we see that at least two arguments are required <code>x</code> and <code>y</code>.</p>
</div>
<div id="aes" class="section level3">
<h3><span class="header-section-number">2.11.7</span> <code>aes</code></h3>
<p><code>aes</code> will be one of the functions you will most use. This function connects data with what we see on the graph. We refer to this connect as the <strong>aesthetic mappings</strong>. The outcome of this function is often used as the argument of a geometry function. This example produces a scatter plot of total murders versus population in millions:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">murders <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">ggplot</span>() <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">x =</span> population<span class="op">/</span><span class="dv">10</span><span class="op">^</span><span class="dv">6</span>, <span class="dt">y =</span> total))</code></pre></div>
<p>We can drop the <code>x =</code> and <code>y =</code> if we wanted to since these are the first and second expected arguments as seen in the help page.</p>
<p>We can also add a layer to the <code>p</code> object that has defined above as <code>p &lt;- ggplot(data = murders)</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(population<span class="op">/</span><span class="dv">10</span><span class="op">^</span><span class="dv">6</span>, total))</code></pre></div>
<p><img src="book_files/figure-html/ggplot-example-3-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>The scale and labels are defined by default when adding this layer. We also use the variable names from the object component: <code>population</code> and <code>total</code>.</p>
<p>The behavior of recognizing the variables from the data component is quite specific to <code>aes</code>. With most functions, if you try to access the values of <code>population</code> or <code>total</code> outside of <code>aes</code> you receive an error.</p>
</div>
<div id="adding-other-layers" class="section level3">
<h3><span class="header-section-number">2.11.8</span> Adding other layers</h3>
<p>A second layer in the plot we wish to make involves adding a label to each point to identify the state. The <code>geom_label</code> and <code>geom_text</code> functions permit us to add text to the plot, without and with a rectangle behind the text respectively.</p>
<p>Because each state (each point) has a label, we need an aesthetic mapping to make the connection. By reading the help file, we learn that we supply the mapping between point and label through the <code>label</code> argument of <code>aes</code>. So the code looks like this:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(population<span class="op">/</span><span class="dv">10</span><span class="op">^</span><span class="dv">6</span>, total)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_text</span>(<span class="kw">aes</span>(population<span class="op">/</span><span class="dv">10</span><span class="op">^</span><span class="dv">6</span>, total, <span class="dt">label =</span> abb))</code></pre></div>
<p><img src="book_files/figure-html/ggplot-example-4-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>We have successfully added a second layer to the plot.</p>
<p>As an example of the unique behavior of <code>aes</code> mentioned above, note that this call:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">p_test &lt;-<span class="st"> </span>p <span class="op">+</span><span class="st"> </span><span class="kw">geom_text</span>(<span class="kw">aes</span>(population<span class="op">/</span><span class="dv">10</span><span class="op">^</span><span class="dv">6</span>, total, <span class="dt">label =</span> abb))</code></pre></div>
<p>is fine, whereas this call</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">p_test &lt;-<span class="st"> </span>p <span class="op">+</span><span class="st"> </span><span class="kw">geom_text</span>(<span class="kw">aes</span>(population<span class="op">/</span><span class="dv">10</span><span class="op">^</span><span class="dv">6</span>, total), <span class="dt">label =</span> abb) </code></pre></div>
<p>will give you an error as <code>abb</code> is not found once it is outside of the <code>aes</code> function. The layer <code>geom_text</code> does not know where to find <code>abb</code> as it is not a global variable.</p>
<div id="tinkering-with-other-arguments" class="section level4">
<h4><span class="header-section-number">2.11.8.1</span> Tinkering with other arguments</h4>
<p>Each geometry function has many arguments other than <code>aes</code> and <code>data</code>. They tend to be specific to the function. For example, in the plot we wish to make, the points are larger than the default ones. In the help file we see that <code>size</code> is an aesthetic and we can change it like this:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(population<span class="op">/</span><span class="dv">10</span><span class="op">^</span><span class="dv">6</span>, total), <span class="dt">size =</span> <span class="dv">3</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_text</span>(<span class="kw">aes</span>(population<span class="op">/</span><span class="dv">10</span><span class="op">^</span><span class="dv">6</span>, total, <span class="dt">label =</span> abb))</code></pre></div>
<p><img src="book_files/figure-html/ggplot-example-5-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p><code>size</code> is <strong>not</strong> a mapping, it affects all the points so we do not need to include it inside <code>aes</code>.</p>
<p>Now that the points are larger, it is hard to see the labels. If we read the help file for <code>geom_text</code>, we see learn of the <code>nudge_x</code> argument which moves the text slightly to the right:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(population<span class="op">/</span><span class="dv">10</span><span class="op">^</span><span class="dv">6</span>, total), <span class="dt">size =</span> <span class="dv">3</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_text</span>(<span class="kw">aes</span>(population<span class="op">/</span><span class="dv">10</span><span class="op">^</span><span class="dv">6</span>, total, <span class="dt">label =</span> abb), <span class="dt">nudge_x =</span> <span class="dv">1</span>)</code></pre></div>
<p><img src="book_files/figure-html/ggplot-example-6-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>This is preferred as it makes it easier to read the text.</p>
</div>
</div>
<div id="global-aesthetic-mappings" class="section level3">
<h3><span class="header-section-number">2.11.9</span> Global aesthetic mappings</h3>
<p>In the previous line of code, we define the mapping <code>aes(population/10^6, total)</code> twice, once in each geometry. We can avoid this by using a <em>glogbal</em> aesthetic mapping. We can do this when we define the blank slate <code>ggplot</code> object. Remember that the function <code>ggplot</code> contains an argument that permits us to define aesthetic mappings:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">args</span>(ggplot)
<span class="co">#&gt; function (data = NULL, mapping = aes(), ..., environment = parent.frame()) </span>
<span class="co">#&gt; NULL</span></code></pre></div>
<p>If we define a mapping in <code>ggplot</code>, then all the geometries that are added as layers will default to this mapping. We redefine <code>p</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">p &lt;-<span class="st"> </span>murders <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(population<span class="op">/</span><span class="dv">10</span><span class="op">^</span><span class="dv">6</span>, total, <span class="dt">label =</span> abb))</code></pre></div>
<p>and then we can simply use code as follows:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>(<span class="dt">size =</span> <span class="dv">3</span>) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">geom_text</span>(<span class="dt">nudge_x =</span> <span class="fl">1.5</span>)</code></pre></div>
<p><img src="book_files/figure-html/ggplot-example-7-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>We keep the <code>size</code> and <code>nudge_x</code> argument in <code>geom_point</code> and <code>geom_text</code> respectively because we only want to increase the size of points and nudge only the labels. Also note that the <code>geom_point</code> function does not need a <code>label</code> argument and therefore ignores it.</p>
<div id="local-aesthetic-mappings-override-global-ones" class="section level4">
<h4><span class="header-section-number">2.11.9.1</span> Local aesthetic mappings override global ones</h4>
<p>If necessary, we can override the global mapping by defining a new mapping within each layer. These <em>local</em> definitions override the <em>global</em>. Here is an example:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>(<span class="dt">size =</span> <span class="dv">3</span>) <span class="op">+</span><span class="st">  </span>
<span class="st">  </span><span class="kw">geom_text</span>(<span class="kw">aes</span>(<span class="dt">x =</span> <span class="dv">10</span>, <span class="dt">y =</span> <span class="dv">800</span>, <span class="dt">label =</span> <span class="st">&quot;Hello there!&quot;</span>))</code></pre></div>
<p><img src="book_files/figure-html/ggplot-example-8-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>Clearly, the second call to <code>geom_text</code> does not use the <code>population</code> and <code>total</code>.</p>
</div>
</div>
<div id="scales" class="section level3">
<h3><span class="header-section-number">2.11.10</span> Scales</h3>
<p>First, our desired scales are in log-scale. This is not the default so this change needs to be added through a <em>scales</em> layer. A quick look at the cheat sheet reveals the <code>scale_x_continuous</code> lets us control the behavior of scales. We use them like this:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>(<span class="dt">size =</span> <span class="dv">3</span>) <span class="op">+</span><span class="st">  </span>
<span class="st">  </span><span class="kw">geom_text</span>(<span class="dt">nudge_x =</span> <span class="fl">0.05</span>) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="dt">trans =</span> <span class="st">&quot;log10&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">trans =</span> <span class="st">&quot;log10&quot;</span>) </code></pre></div>
<p><img src="book_files/figure-html/ggplot-example-9-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>Because we are in the log-scale now, the <em>nudge</em> must be made smaller.</p>
<p>This particular transformation is so common that ggplot2 provides specialized functions:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>(<span class="dt">size =</span> <span class="dv">3</span>) <span class="op">+</span><span class="st">  </span>
<span class="st">  </span><span class="kw">geom_text</span>(<span class="dt">nudge_x =</span> <span class="fl">0.05</span>) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">scale_x_log10</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_y_log10</span>() </code></pre></div>
</div>
<div id="labels-and-titles" class="section level3">
<h3><span class="header-section-number">2.11.11</span> Labels and titles</h3>
<p>Similarly, the cheat sheet quickly reveals that to change labels and add a title, we use the following functions:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>(<span class="dt">size =</span> <span class="dv">3</span>) <span class="op">+</span><span class="st">  </span>
<span class="st">  </span><span class="kw">geom_text</span>(<span class="dt">nudge_x =</span> <span class="fl">0.05</span>) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">scale_x_log10</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_y_log10</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">xlab</span>(<span class="st">&quot;Populations in millions (log scale)&quot;</span>) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ylab</span>(<span class="st">&quot;Total number of murders (log scale)&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;US Gun Murders in US 2010&quot;</span>)</code></pre></div>
<p><img src="book_files/figure-html/ggplot-example-10-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>We are almost there! All we have left to do is add color, a legend and optional changes to the style.</p>
<div id="categories-as-colors" class="section level4">
<h4><span class="header-section-number">2.11.11.1</span> Categories as colors</h4>
<p>We can change the color of the points using the <code>col</code> argument in the <code>geom_point</code> function. To facilitate exposition, we will redefine <code>p</code> to be everything except the points layer:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">p &lt;-<span class="st">  </span>murders <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(population<span class="op">/</span><span class="dv">10</span><span class="op">^</span><span class="dv">6</span>, total, <span class="dt">label =</span> abb)) <span class="op">+</span><span class="st">   </span>
<span class="st">  </span><span class="kw">geom_text</span>(<span class="dt">nudge_x =</span> <span class="fl">0.05</span>) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">scale_x_log10</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_y_log10</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">xlab</span>(<span class="st">&quot;Populations in millions (log scale)&quot;</span>) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ylab</span>(<span class="st">&quot;Total number of murders (log scale)&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;US Gun Murders in US 2010&quot;</span>)</code></pre></div>
<p>and then test out what happens by adding different calls to <code>geom_point</code>. We can make all the points blue by adding the <code>color</code> argument:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>(<span class="dt">size =</span> <span class="dv">3</span>, <span class="dt">color =</span><span class="st">&quot;blue&quot;</span>)</code></pre></div>
<p><img src="book_files/figure-html/ggplot-example-11-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>This, of course, is not what we want. We want to assign color depending on the geographical region. A nice default behavior of ggplot2 is that if we assign a categorical variable to color, it automatically assigns a different color to each category. It also adds a legend!</p>
<p>To map each point to a color, we need to use <code>aes</code> since this is a mapping. We use the following code:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">col=</span>region), <span class="dt">size =</span> <span class="dv">3</span>)</code></pre></div>
<p><img src="book_files/figure-html/ggplot-example-12-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>The <code>x</code> and <code>y</code> mappings are inherited from those already defined in <code>p</code>. So we do not redefine them. We also move <code>aes</code> to the first argument since that is where the mappings are expected in this call.</p>
<p>Here we see yet another useful default behavior: ggplot2 has automatically added a legend that maps color to region.</p>
</div>
<div id="adding-a-line" class="section level4">
<h4><span class="header-section-number">2.11.11.2</span> Adding a line</h4>
<p>We want to add a line that represents the average murder rate for the entire country. Once we determine the per million rate to be <span class="math inline">\(r\)</span>, this line is defined by the formula: <span class="math inline">\(y = r x\)</span> with <span class="math inline">\(y\)</span> and <span class="math inline">\(x\)</span> our axes: total murders and population in millions respectively. In the log-scale this line turns into: <span class="math inline">\(\log(y) = \log(r) + \log(x)\)</span>. So in our plot it’s a line with slope 1 and intercept <span class="math inline">\(\log(r)\)</span>. To compute this value we use what we our dplyr skills:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">r &lt;-<span class="st"> </span>murders <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">summarize</span>(<span class="dt">rate =</span> <span class="kw">sum</span>(total) <span class="op">/</span><span class="st">  </span><span class="kw">sum</span>(population) <span class="op">*</span><span class="st"> </span><span class="dv">10</span><span class="op">^</span><span class="dv">6</span>) <span class="op">%&gt;%</span><span class="st"> </span>.<span class="op">$</span>rate</code></pre></div>
<p>To add a line we use the <code>geom_abline</code> function. ggplot2 uses <code>ab</code> in the name to remind us we are supplying the intercept (<code>a</code>) and slope (<code>b</code>). The default line has slope 1 and intercept 0 so we only have to define the intercept:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">col=</span>region), <span class="dt">size =</span> <span class="dv">3</span>) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">geom_abline</span>(<span class="dt">intercept =</span> <span class="kw">log10</span>(r))</code></pre></div>
<p><img src="book_files/figure-html/ggplot-example-13-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>We can change the line type and color of the lines using arguments. Also we draw it first so it doesn’t go over our points.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">p &lt;-<span class="st"> </span>p <span class="op">+</span><span class="st"> </span><span class="kw">geom_abline</span>(<span class="dt">intercept =</span> <span class="kw">log10</span>(r), <span class="dt">lty =</span> <span class="dv">2</span>, <span class="dt">color =</span> <span class="st">&quot;darkgrey&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">col=</span>region), <span class="dt">size =</span> <span class="dv">3</span>)  </code></pre></div>
<p>Note that we redefined <code>p</code>.</p>
</div>
</div>
<div id="adjustments" class="section level3">
<h3><span class="header-section-number">2.11.12</span> Adjustments</h3>
<p>The default plots created by ggplot2 are already very useful. However, we frequently need to make minor tweaks to the default behavior. Although it is not always obvious how to make these even with the cheat sheet, ggplot2 is very flexible.</p>
<p>For example, we can make changes to the legend via the <code>scale_color_discrete</code> function. In our plot the word <em>region</em> is capitalized and we can change it like this:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">p &lt;-<span class="st"> </span>p <span class="op">+</span><span class="st"> </span><span class="kw">scale_color_discrete</span>(<span class="dt">name =</span> <span class="st">&quot;Region&quot;</span>) </code></pre></div>
</div>
<div id="add-on-packages" class="section level3">
<h3><span class="header-section-number">2.11.13</span> Add-on packages</h3>
<p>The power of ggplot2 is augmented further due to the availability of add-on packages. The remaining changes needed to put the finishing touches on our plot require the <code>ggthemes</code> and <code>ggrepel</code> packages.</p>
<p>The style of a ggplot2 graph can be changed using the <code>theme</code> functions. Several themes are included as part of the ggplot2 package. In fact, for most of the plots in this book, we use a function in the <code>dslabs</code> package that automatically sets a default theme:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ds_theme_set</span>()</code></pre></div>
<p>Many other themes are added by the package ggthemes. Among those are the <code>theme_economist</code> theme that we used. After installing the package, you can change the style by adding a layer like this:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(ggthemes)
p <span class="op">+</span><span class="st"> </span><span class="kw">theme_economist</span>()</code></pre></div>
<p>You can see how some of the other themes look by simply changing the function. For instance, you might try the <code>theme_fivethirtyeight()</code> theme instead.</p>
<p>The final difference has to do with the position of the labels. In our plot, some of the labels fall on top of each other. The add-on package <code>ggrepel</code> includes a geometry that adds labels while ensuring that they don’t fall on top of each other. We simply change <code>geom_text</code> with <code>geom_text_repell</code>.</p>
</div>
<div id="putting-it-all-together" class="section level3">
<h3><span class="header-section-number">2.11.14</span> Putting it all together</h3>
<p>Now that we are done testing, we can write one piece of code that produces our desired plot from scratch.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(ggthemes)
<span class="kw">library</span>(ggrepel)

### First define the slope of the line
r &lt;-<span class="st"> </span>murders <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">summarize</span>(<span class="dt">rate =</span> <span class="kw">sum</span>(total) <span class="op">/</span><span class="st">  </span><span class="kw">sum</span>(population) <span class="op">*</span><span class="st"> </span><span class="dv">10</span><span class="op">^</span><span class="dv">6</span>) <span class="op">%&gt;%</span><span class="st"> </span>.<span class="op">$</span>rate

## Now make the plot
murders <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(population<span class="op">/</span><span class="dv">10</span><span class="op">^</span><span class="dv">6</span>, total, <span class="dt">label =</span> abb)) <span class="op">+</span><span class="st">   </span>
<span class="st">  </span><span class="kw">geom_abline</span>(<span class="dt">intercept =</span> <span class="kw">log10</span>(r), <span class="dt">lty =</span> <span class="dv">2</span>, <span class="dt">color =</span> <span class="st">&quot;darkgrey&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">col=</span>region), <span class="dt">size =</span> <span class="dv">3</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_text_repel</span>() <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">scale_x_log10</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_y_log10</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">xlab</span>(<span class="st">&quot;Populations in millions (log scale)&quot;</span>) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ylab</span>(<span class="st">&quot;Total number of murders (log scale)&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;US Gun Murders in US 2010&quot;</span>) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">scale_color_discrete</span>(<span class="dt">name =</span> <span class="st">&quot;Region&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">theme_economist</span>()</code></pre></div>
<p><img src="book_files/figure-html/final-ggplot-example-1.png" width="70%" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="geometries" class="section level2">
<h2><span class="header-section-number">2.12</span> Geometries</h2>
<p>Now let’s try to make the summary plots we have described in this chapter.</p>
<div id="histogram" class="section level3">
<h3><span class="header-section-number">2.12.1</span> Histogram</h3>
<p>Let’s start with the histogram. In a first step we need to use dplyr to filter the data:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">heights <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(sex<span class="op">==</span><span class="st">&quot;Male&quot;</span>)</code></pre></div>
<p>Once we have a dataset, the next step is deciding what geometry we need. If you guessed <code>geom_histogram</code>, you guessed correctly. Looking at the help file for this function we learn that the only required argument is <code>x</code>, the variable for which we will construct a histogram. The code looks like this:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">p &lt;-<span class="st"> </span>heights <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(sex<span class="op">==</span><span class="st">&quot;Male&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> height)) 

p <span class="op">+</span><span class="st"> </span><span class="kw">geom_histogram</span>()
<span class="co">#&gt; `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</span></code></pre></div>
<p><img src="book_files/figure-html/ggplot-histogram-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>As before, we can drop the <code>x =</code>.</p>
<p>This call gives us a message:</p>
<blockquote>
<p><code>stat_bin()</code> using <code>bins = 30</code>. Pick better value with <code>binwidth</code>.</p>
</blockquote>
<p>We previously used a bin size of 1 inch, so the code looks like this:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_histogram</span>(<span class="dt">binwidth =</span> <span class="dv">1</span>)</code></pre></div>
<p>Finally, if for aesthetic reasons we want to add color, we use the arguments described in the help file. We also add labels and a title:</p>
<p><img src="book_files/figure-html/height-histogram-rep-1.png" width="70%" style="display: block; margin: auto;" /></p>
</div>
<div id="density" class="section level3">
<h3><span class="header-section-number">2.12.2</span> Density</h3>
<p>To create a smooth density, we need a different geometry: we used <code>geom_density</code> instead.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_density</span>()</code></pre></div>
<p><img src="book_files/figure-html/ggplot-density-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>To fill in with color, we can use the <code>fill</code> argument.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_density</span>(<span class="dt">fill=</span><span class="st">&quot;blue&quot;</span>)</code></pre></div>
<p><img src="book_files/figure-html/ggplot-density-with-fill-1.png" width="70%" style="display: block; margin: auto;" /></p>
</div>
<div id="qq-plots" class="section level3">
<h3><span class="header-section-number">2.12.3</span> QQ-plots</h3>
<p>For qq-plots we use the <code>geom_qq</code> geometry. From the help file, we learn that we need to specify the <code>sample</code> (we will learn about samples in a later chapter).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">p &lt;-<span class="st"> </span>heights <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(sex<span class="op">==</span><span class="st">&quot;Male&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">sample =</span> height)) 
p <span class="op">+</span><span class="st"> </span><span class="kw">geom_qq</span>()</code></pre></div>
<p><img src="book_files/figure-html/ggplot-qq-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>By default the sample variable is compared to a normal distribution with average 0 and standard deviation 1. To change this, again from the help file, we use the <code>dparams</code> arguments.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">params &lt;-<span class="st"> </span>heights <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(sex<span class="op">==</span><span class="st">&quot;Male&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarize</span>(<span class="dt">mean =</span> <span class="kw">mean</span>(height), <span class="dt">sd =</span> <span class="kw">sd</span>(height))

p  <span class="op">+</span><span class="st">  </span><span class="kw">geom_qq</span>(<span class="dt">dparams =</span> params)</code></pre></div>
<p><img src="book_files/figure-html/ggplot-qq-dparams-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>Adding an identity line is as simple as assigning another layer. For straight lines, we use the <code>geom_abline</code> function. To help you remember the name of this function, remember that the <code>ab</code> in front of <code>line</code> serves to remind us that we need to supply an intercept (a) and slope (b) to draw the line <span class="math inline">\(y=a+bx\)</span>. The default is the identity <code>a=0</code> and <code>b=1</code></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">p <span class="op">+</span><span class="st">  </span><span class="kw">geom_qq</span>(<span class="dt">dparams =</span> params) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">geom_abline</span>()</code></pre></div>
<p><img src="book_files/figure-html/ggplot-qq-with-line-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>Another option here is to scale the data first and the make a qqplot against the standard normal:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">heights <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(sex<span class="op">==</span><span class="st">&quot;Male&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">sample =</span> <span class="kw">scale</span>(height))) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">geom_qq</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_abline</span>()</code></pre></div>
<p><img src="book_files/figure-html/ggplot-qq-standard-units-1.png" width="70%" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="grids-of-plots" class="section level2">
<h2><span class="header-section-number">2.13</span> Grids of plots</h2>
<p>There are often reasons to graph plots next to each other. The <code>gridExtra</code> package permits us to do that:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">p &lt;-<span class="st"> </span>heights <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(sex<span class="op">==</span><span class="st">&quot;Male&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> height)) 
p1 &lt;-<span class="st"> </span>p <span class="op">+</span><span class="st"> </span><span class="kw">geom_histogram</span>(<span class="dt">binwidth =</span> <span class="dv">1</span>, <span class="dt">fill =</span> <span class="st">&quot;blue&quot;</span>, <span class="dt">col=</span><span class="st">&quot;black&quot;</span>)
p2 &lt;-<span class="st"> </span>p <span class="op">+</span><span class="st"> </span><span class="kw">geom_histogram</span>(<span class="dt">binwidth =</span> <span class="dv">2</span>, <span class="dt">fill =</span> <span class="st">&quot;blue&quot;</span>, <span class="dt">col=</span><span class="st">&quot;black&quot;</span>)
p3 &lt;-<span class="st"> </span>p <span class="op">+</span><span class="st"> </span><span class="kw">geom_histogram</span>(<span class="dt">binwidth =</span> <span class="dv">3</span>, <span class="dt">fill =</span> <span class="st">&quot;blue&quot;</span>, <span class="dt">col=</span><span class="st">&quot;black&quot;</span>)</code></pre></div>
<p>To print them all side-by-side, we can use the function <code>grid.arrange</code> in the <code>gridExtra</code> package:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(gridExtra)
<span class="kw">grid.arrange</span>(p1,p2,p3, <span class="dt">ncol =</span> <span class="dv">3</span>)</code></pre></div>
<p><img src="book_files/figure-html/gridextra-example-1.png" width="70%" style="display: block; margin: auto;" /></p>

</div>
<div id="case-study-trends-in-world-health-and-economics" class="section level2">
<h2><span class="header-section-number">2.14</span> Case study: Trends in world health and economics</h2>
<p>In this section we will demonstrate how relatively simple ggplot2 code can create insightful and aesthetically pleasing plots that help us better understand trends in world health and economics. We later augment the code somewhat to perfect the plots and describe some general data visualization principles.</p>
<div id="example-1-life-expectancy-and-fertility-rates" class="section level3">
<h3><span class="header-section-number">2.14.1</span> Example 1: Life expectancy and fertility rates</h3>
<p><a href="https://en.wikipedia.org/wiki/Hans_Rosling">Hans Rosling</a> was the co-founder of the <a href="http://www.gapminder.org/">Gapminder Foundation</a>, an organization dedicated to educating the public by using data to dispel common myths about the so-called developing world. The organization uses data to show how actual trends in health and economics contradict the narratives that emanate from sensationalist media coverage of catastrophes, tragedies and other unfortunate events. As stated in the Gapminder Foundation’s website:</p>
<blockquote>
<blockquote>
<blockquote>
<p>Journalists and lobbyists tell dramatic stories. That’s their job. They tell stories about extraordinary events and unusual people. The piles of dramatic stories pile up in peoples’ minds into an over-dramatic worldview and strong negative stress feelings: “The world is getting worse!”, “It’s we vs. them!” , “Other people are strange!”, “The population just keeps growing!” and “Nobody cares!”</p>
</blockquote>
</blockquote>
</blockquote>
<p>Hans Rosling conveyed actual data-based trends in a dramatic way of his own, using effective data visualization. This section is based on two talks that exemplify this approach to education: <a href="https://www.ted.com/talks/hans_rosling_reveals_new_insights_on_poverty?language=en">New Insights on Poverty</a> and <a href="https://www.ted.com/talks/hans_rosling_shows_the_best_stats_you_ve_ever_seen">The Best Stats You’ve Ever Seen</a>. Specifically, in this section, we use data to attempt to answer the following two questions:</p>
<ol style="list-style-type: decimal">
<li>Is it a fair characterization of today’s world to say it is divided into western rich nations and the developing world in Africa, Asia and Latin America?</li>
<li>Has income inequality across countries worsened during the last 40 years?</li>
</ol>
<p>To answer these question we will be using the <code>gapminder</code> dataset provided in <code>dslabs</code>. This dataset was created using a number of spreadsheets available from the <a href="http://www.gapminder.org/">Gapminder</a> Foundation. You can access the table like this:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(dslabs)
<span class="kw">data</span>(gapminder)
<span class="kw">head</span>(gapminder)
<span class="co">#&gt;               country year infant_mortality life_expectancy fertility</span>
<span class="co">#&gt; 1             Albania 1960            115.4            62.9      6.19</span>
<span class="co">#&gt; 2             Algeria 1960            148.2            47.5      7.65</span>
<span class="co">#&gt; 3              Angola 1960            208.0            36.0      7.32</span>
<span class="co">#&gt; 4 Antigua and Barbuda 1960               NA            63.0      4.43</span>
<span class="co">#&gt; 5           Argentina 1960             59.9            65.4      3.11</span>
<span class="co">#&gt; 6             Armenia 1960               NA            66.9      4.55</span>
<span class="co">#&gt;   population      gdp continent          region</span>
<span class="co">#&gt; 1    1636054       NA    Europe Southern Europe</span>
<span class="co">#&gt; 2   11124892 1.38e+10    Africa Northern Africa</span>
<span class="co">#&gt; 3    5270844       NA    Africa   Middle Africa</span>
<span class="co">#&gt; 4      54681       NA  Americas       Caribbean</span>
<span class="co">#&gt; 5   20619075 1.08e+11  Americas   South America</span>
<span class="co">#&gt; 6    1867396       NA      Asia    Western Asia</span></code></pre></div>
<div id="hans-roslings-quiz" class="section level4 unnumbered">
<h4>Hans Rosling’s quiz</h4>
<p>As done in the <em>New Insights on Poverty</em> video, we start by testing our knowledge regarding differences in child mortality across different countries.</p>
<p>For each of the six pairs of countries below, which country do you think had the highest child mortality in 2015? Which pairs do you think are most similar?</p>
<ol style="list-style-type: decimal">
<li>Sri Lanka or Turkey</li>
<li>Poland or South Korea</li>
<li>Malaysia or Russia</li>
<li>Pakistan or Vietnam</li>
<li>Thailand or South Africa</li>
</ol>
<p>When answering these questions without data, the non-European countries are typically picked as having higher child mortality rates: Sri Lanka over Turkey, South Korea over Poland, and Malaysia over Russia. It is also common to assume that countries considered to be part of the developing world: Pakistan, Vietnam, Thailand and South Africa, have similarly high mortality rates.</p>
<p>To answer these questions <strong>with data</strong> we can use <code>dplyr</code>. For example, for the first comparison we see that:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(tidyverse)
gapminder <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(year <span class="op">==</span><span class="st"> </span><span class="dv">2015</span> <span class="op">&amp;</span><span class="st"> </span>country <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Sri Lanka&quot;</span>,<span class="st">&quot;Turkey&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(country, infant_mortality)
<span class="co">#&gt;     country infant_mortality</span>
<span class="co">#&gt; 1 Sri Lanka              8.4</span>
<span class="co">#&gt; 2    Turkey             11.6</span></code></pre></div>
<p>Turkey has the higher rate.</p>
<p>We can use this code on all comparisons and find the following:</p>
<table>
<thead>
<tr class="header">
<th align="left">country</th>
<th align="right">infant_mortality</th>
<th align="left">country1</th>
<th align="right">infant_mortality1</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Sri Lanka</td>
<td align="right">8.4</td>
<td align="left">Turkey</td>
<td align="right">11.6</td>
</tr>
<tr class="even">
<td align="left">Poland</td>
<td align="right">4.5</td>
<td align="left">South Korea</td>
<td align="right">2.9</td>
</tr>
<tr class="odd">
<td align="left">Malaysia</td>
<td align="right">6.0</td>
<td align="left">Russia</td>
<td align="right">8.2</td>
</tr>
<tr class="even">
<td align="left">Pakistan</td>
<td align="right">65.8</td>
<td align="left">Vietnam</td>
<td align="right">17.3</td>
</tr>
<tr class="odd">
<td align="left">Thailand</td>
<td align="right">10.5</td>
<td align="left">South Africa</td>
<td align="right">33.6</td>
</tr>
</tbody>
</table>
<p>We see that the European countries on this list have higher child mortality rates: Poland has a higher rate than South Korea, and Russia has a higher rate than Malaysia. We also see that Pakistan has a much higher rate than Vietnam, and South Africa has a much higher rate than Thailand. It turns out that most people do worse than if they were guessing, which implies that more than ignorant, we are misinformed.</p>
</div>
</div>
<div id="a-scatterplot" class="section level3">
<h3><span class="header-section-number">2.14.2</span> A scatterplot</h3>
<p>The reason for this stems from the preconceived notion that the world is divided into two groups: the western world (Western Europe and North America), characterized by long life spans and small families, versus the developing world (Africa, Asia, and Latin America) characterized by short life spans and and large families. But, does the data support this dichotomous view?</p>
<p>The necessary data to answer this question is also available in our <code>gapminder</code> table. Using our newly learned data visualization skills we will be able to tackle this challenge.</p>
<p>In order to analyze this world view, our first plot is a scatter plot of life expectancy versus fertility rates (average number of children per woman). We start by looking at data from about 50 years ago, when perhaps this view was first cemented in our minds.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">filter</span>(gapminder, year<span class="op">==</span><span class="dv">1962</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">ggplot</span>( <span class="kw">aes</span>(fertility, life_expectancy)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>()</code></pre></div>
<p><img src="book_files/figure-html/fertility-versus-life-expectancy-1962-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>Most points fall into two distinct categories:</p>
<ol style="list-style-type: decimal">
<li>Life expectancy around 70 years and 3 or less children per family</li>
<li>Life expectancy lower then 65 years and more than 5 children per family.</li>
</ol>
<p>To confirm that indeed these countries are from the regions we expect, we can use color to represent continent.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">filter</span>(gapminder, year<span class="op">==</span><span class="dv">1962</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">ggplot</span>( <span class="kw">aes</span>(fertility, life_expectancy, <span class="dt">color =</span> continent)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>() </code></pre></div>
<p><img src="book_files/figure-html/fertility-versus-life-expectancy-1962-with-color-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>So in 1962, “the west versus developing world” view was grounded in some reality. But is this still the case 50 years later?</p>
</div>
<div id="faceting" class="section level3">
<h3><span class="header-section-number">2.14.3</span> Faceting</h3>
<p>We could easily plot the 2012 data in the same way we did for 1962. But to compare, side by side plots are preferable. In ggplot2 we can achieve this by <em>faceting variables</em>: we stratify the data by some variable and make the same plot for each strata.</p>
<p>To achieve faceting we add a layer with the function <code>facet_grid</code>, which automatically separates the plots. This function lets you facet by up to two variables using columns to represent one variable and rows to represent the other. The function expects the row and column variables to be separated by a <code>~</code>. Here is an example of a scatter plot with <code>facet_grid</code> added as the last layer:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">filter</span>(gapminder, year<span class="op">%in%</span><span class="kw">c</span>(<span class="dv">1962</span>, <span class="dv">2012</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(fertility, life_expectancy, <span class="dt">col =</span> continent)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">facet_grid</span>(continent<span class="op">~</span>year)</code></pre></div>
<p><img src="book_files/figure-html/fertility-versus-life-expectancy-facet-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>We see a plot for each continent/year pair. However, this is just an example and more than what we want, which is simply to compare 1962 and 2012. In this case, there is just one variable and we use <code>.</code> to let facet know that we are not using one of the variables:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">filter</span>(gapminder, year<span class="op">%in%</span><span class="kw">c</span>(<span class="dv">1962</span>, <span class="dv">2012</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(fertility, life_expectancy, <span class="dt">col =</span> continent)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">facet_grid</span>( . <span class="op">~</span><span class="st"> </span>year)</code></pre></div>
<p><img src="book_files/figure-html/fertility-versus-life-expectancy-two-years-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>This plot clearly shows that the majority of countries have moved from the <em>developing world</em> cluster to the <em>western world</em> one. In 2012, the western versus developing world view no longer makes sense. This is particularly clear when comparing Europe to Asia, which includes several countries that have made great improvements.</p>
<div id="facet_wrap" class="section level4">
<h4><span class="header-section-number">2.14.3.1</span> <code>facet_wrap</code></h4>
<p>To explore how this transformation happened through the years, we can make the plot for several years. For example, we can add 1970, 1980, 1990, and 2000. If we do this, we will not want all the plots on the same row, the default behavior of <code>facet_grid</code>, since they will become too thin to show the data. Instead we will want to use multiple rows and columns. The function <code>facet_wrap</code> permits us to do this by automatically wrapping the series of plots so that each display has viewable dimensions:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">years &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">1962</span>, <span class="dv">1980</span>, <span class="dv">1990</span>, <span class="dv">2000</span>, <span class="dv">2012</span>)
continents &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Europe&quot;</span>, <span class="st">&quot;Asia&quot;</span>)
gapminder <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(year <span class="op">%in%</span><span class="st"> </span>years <span class="op">&amp;</span><span class="st"> </span>continent <span class="op">%in%</span><span class="st"> </span>continents) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">ggplot</span>( <span class="kw">aes</span>(fertility, life_expectancy, <span class="dt">col =</span> continent)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>year) </code></pre></div>
<p><img src="book_files/figure-html/fertility-versus-life-expectancy-five-years-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>This plot clearly shows how most Asian countries have improved at a much faster rate than European ones.</p>
</div>
</div>
<div id="fixed-scales-for-better-comparisons" class="section level3">
<h3><span class="header-section-number">2.14.4</span> Fixed scales for better comparisons</h3>
<p>The default choice of the range of the axes is an important one. When not using <code>facet</code>, this range is determined by the data shown in the plot. When using <code>facet</code>, this range is determined by the data shown in all plots and therefore kept fixed across plots. This makes comparisons across plots much easier. For example, in the above plot we can see that life expectancy has increased and the fertility has decreased across most countries. We see this because the cloud of points moves. This is not the case if we adjust the scales:</p>
<p><img src="book_files/figure-html/facet-without-fixed-scales-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>In the plot above we have to pay special attention to the range to notice that the plot on the right has a larger life expectancy.</p>
</div>
<div id="time-series-plots" class="section level3">
<h3><span class="header-section-number">2.14.5</span> Time series plots</h3>
<p>The visualizations above effectively illustrates that data no longer supports the western versus developing world view. Once we see these plots, new questions emerge. For example, which countries are improving more, which ones less? Was the improvement constant during the last 50 years or was it more accelerated during certain periods? For a closer look that may help answer these questions, we introduce <em>time series plots</em>.</p>
<p>Time series plots have time in the x-axis and an outcome or measurement of interest on the y-axis. For example, here is a trend plot of United States fertility rates:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">gapminder <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(country <span class="op">==</span><span class="st"> &quot;United States&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(year,fertility)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>()</code></pre></div>
<p><img src="book_files/figure-html/fertility-time-series-plot-points-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>We see that the trend is not linear at all. Instead there is sharp drop during the 60s and 70s to below 2. Then the trend comes back to 2 and stabilizes during the 90s.</p>
<p>When the points are regularly and densely spaced, as they are here, we create curves by joining the points with lines, to convey that these data are from a single country. To do this we use the <code>geom_line</code> function instead of <code>geom_point</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">gapminder <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(country <span class="op">==</span><span class="st"> &quot;United States&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(year,fertility)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_line</span>()</code></pre></div>
<p><img src="book_files/figure-html/fertility-time-series-plot-curve-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>This is particularly helpful when we look at two countries. If we subset the data to include two countries, one from Europe and one from Asia, then adapt the code above:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">countries &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;South Korea&quot;</span>,<span class="st">&quot;Germany&quot;</span>)
gapminder <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(country <span class="op">%in%</span><span class="st"> </span>countries) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(year,fertility)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_line</span>()</code></pre></div>
<p><img src="book_files/figure-html/wrong-time-series-plot-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>Unfortunately, this is <strong>not</strong> the plot that we want. Rather than a line for each country, the points for both countries are joined. This is actually expected since we have not told <code>ggplot</code> anything about wanting two separate lines. To let <code>ggplot</code> know that there are two curves that need to be made separately, we assign each point to a <code>group</code>, one for each country:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">countries &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;South Korea&quot;</span>,<span class="st">&quot;Germany&quot;</span>)
gapminder <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(country <span class="op">%in%</span><span class="st"> </span>countries) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(year,fertility, <span class="dt">group =</span> country)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_line</span>()
<span class="co">#&gt; Warning: Removed 2 rows containing missing values (geom_path).</span></code></pre></div>
<p><img src="book_files/figure-html/time-series-two-curves-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>But which line goes with which country? We can assign colors to make this distinction. A useful side-effect of using the <code>color</code> argument to assign different colors to the different countries is that the data is automatically grouped:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">countries &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;South Korea&quot;</span>,<span class="st">&quot;Germany&quot;</span>)
gapminder <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(country <span class="op">%in%</span><span class="st"> </span>countries) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(year,fertility, <span class="dt">col =</span> country)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_line</span>()
<span class="co">#&gt; Warning: Removed 2 rows containing missing values (geom_path).</span></code></pre></div>
<p><img src="book_files/figure-html/fertility-time-series-plot-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>The plot clearly shows how South Korea’s fertility rate dropped drastically during the 60s and 70s and by 1990 had a similar rate to that of Germany.</p>
<div id="we-prefer-labels-over-legends" class="section level4 unnumbered">
<h4>We prefer labels over legends</h4>
<p>For trend plots we recommend labeling the lines rather than using legends since the viewer can quickly see which line is which country. This suggestion actually applies to most plots: labeling is usually preferred over legends.</p>
<p>We demonstrate how we can do this using the life expectancy data. We define a data table with the label locations and then use a second mapping just for these labels:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">labels &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">country =</span> countries, <span class="dt">x =</span> <span class="kw">c</span>(<span class="dv">1975</span>,<span class="dv">1965</span>), <span class="dt">y =</span> <span class="kw">c</span>(<span class="dv">60</span>,<span class="dv">72</span>))

gapminder <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(country <span class="op">%in%</span><span class="st"> </span>countries) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(year, life_expectancy, <span class="dt">col =</span> country)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_line</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_text</span>(<span class="dt">data =</span> labels, <span class="kw">aes</span>(x, y, <span class="dt">label =</span> country), <span class="dt">size =</span> <span class="dv">5</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;none&quot;</span>)</code></pre></div>
<p><img src="book_files/figure-html/labels-better-than-legends-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>The plot clearly shows how an improvement in life expectancy followed the drops in fertility rates. In 1960 Germans lived 15 years longer than South Koreans, although by 2010 the gap is completely closed. It exemplifies the improvement that many non-western countries have achieved in the last 40 years.</p>
</div>
</div>
<div id="example-2-income-distribution" class="section level3">
<h3><span class="header-section-number">2.14.6</span> Example 2: Income distribution</h3>
<p>Another commonly held notion is that wealth distribution across the world has become worse during the last decades. When general audiences are asked if poor countries have become poorer and rich countries become richer, the majority answers yes. By using stratification, histograms, smooth densities, and boxplots, we will be able to understand if this is in fact the case. We will also learn how transformations can sometimes help provide more informative summaries and plots.</p>
</div>
<div id="transformations" class="section level3">
<h3><span class="header-section-number">2.14.7</span> Transformations</h3>
<p>The <code>gapminder</code> data table includes a column with the countries gross domestic product (GDP). GDP measures the market value of goods and services produced by a country in a year. The GDP per person is often used as a rough summary of a country’s wealth. Here we divide this quantity by 365 to obtain the more interpretable measure <em>dollars per day</em>. Using current US dollars as a unit, a person surviving on an income of less than $2 a day is defined to be living in <em>absolute povery</em>. We add this variable to the data table:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">gapminder &lt;-<span class="st"> </span>gapminder <span class="op">%&gt;%</span><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">dollars_per_day =</span> gdp<span class="op">/</span>population<span class="op">/</span><span class="dv">365</span>)</code></pre></div>
<p>The GDP values are adjusted for inflation and represent current US dollars, so these values are meant to be comparable across the years. Of course, these are country averages and within each country there is much variability. All the graphs and insights described below relate to country averages and not to individuals.</p>
<div id="country-income-distribution" class="section level4 unnumbered">
<h4>Country income distribution</h4>
<p>Here is a histogram of per day incomes from 1970:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">past_year &lt;-<span class="st"> </span><span class="dv">1970</span>
gapminder <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(year <span class="op">==</span><span class="st"> </span>past_year <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw">is.na</span>(gdp)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(dollars_per_day)) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">geom_histogram</span>(<span class="dt">binwidth =</span> <span class="dv">1</span>, <span class="dt">color =</span> <span class="st">&quot;black&quot;</span>)</code></pre></div>
<p><img src="book_files/figure-html/dollars-per-day-distribution-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>We use the <code>color = &quot;black&quot;</code> argument to draw a boundary and clearly distinguish the bins.</p>
<p>In this plot we see that for the majority of countries, averages are below $10 a day. However, the majority of the x-axis is dedicated to the 35 countries with averages above $10. So the plot is not very informative about countries with values below $10 a day.</p>
<p>It might be more informative to quickly be able to see how many countries have average daily incomes of about $1 (extremely poor), $2 (very poor), $4 (poor), $8 (middle), $16 (well off), $32 (rich), $64 (very rich) per day. These changes are multiplicative and log transformations convert multiplicative changes into additive ones: when using base 2, a doubling of a value turns into an increase by 1.</p>
<p>Here is the distribution if we apply a log base 2 transform:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">gapminder <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(year <span class="op">==</span><span class="st"> </span>past_year <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw">is.na</span>(gdp)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="kw">log2</span>(dollars_per_day))) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">geom_histogram</span>(<span class="dt">binwidth =</span> <span class="dv">1</span>, <span class="dt">color =</span> <span class="st">&quot;black&quot;</span>)</code></pre></div>
<p><img src="book_files/figure-html/dollars-per-day-distribution-log-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>In a way this provides a <em>close up</em> of the mid to lower income countries.</p>
</div>
<div id="which-base" class="section level4 unnumbered">
<h4>Which base?</h4>
<p>In the case above we used base 2 in the log transformations. Other common choices are base <span class="math inline">\(\mathrm{e}\)</span> (the natural log) and base 10.</p>
<p>In general, we do not recommend using the natural log for data exploration and visualization. This is because while <span class="math inline">\(2^2, 2^3, 2^4, \dots\)</span> or <span class="math inline">\(10^1, 10^2, \dots\)</span> are easy to compute in our heads, the same is not true for <span class="math inline">\(\mathrm{e}^2, \mathrm{e}^3, \dots\)</span>.</p>
<p>In the dollars per day example, we used base 2 instead of base 10 because the resulting range is easier to interpret. The range of the values being plotted is 0.327, 48.885.</p>
<p>In base 10 this turns into a range that includes very few integers: just 0 and 1. With base two, our range includes -2, -1, 0, 1, 2, 3, 4 and 5. It is easier to compute <span class="math inline">\(2^x\)</span> and <span class="math inline">\(10^x\)</span> when <span class="math inline">\(x\)</span> is an integer and between -10 and 10, so we prefer to have smaller integers in the scale. Another consequence of a limited range is that choosing the binwidth is more challenging. With log base 2, we know that a binwidth of 1 will translate to a bin with range <span class="math inline">\(x\)</span> to <span class="math inline">\(2x\)</span>.</p>
<p>For an example in which base 10 makes more sense consider population sizes. A log base 10 makes more sense since the range for these is:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">filter</span>(gapminder, year <span class="op">==</span><span class="st"> </span>past_year) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarize</span>(<span class="dt">min =</span> <span class="kw">min</span>(population), <span class="dt">max =</span> <span class="kw">max</span>(population))
<span class="co">#&gt;     min      max</span>
<span class="co">#&gt; 1 46075 8.09e+08</span></code></pre></div>
<p>Here is the histogram of the transformed values:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">gapminder <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(year <span class="op">==</span><span class="st"> </span>past_year) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="kw">log10</span>(population))) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_histogram</span>(<span class="dt">binwidth =</span> <span class="fl">0.5</span>, <span class="dt">color =</span> <span class="st">&quot;black&quot;</span>)</code></pre></div>
<p><img src="book_files/figure-html/population-histogram-log10-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>In the above, we quickly see that country populations range between ten thousand and ten billion.</p>
</div>
<div id="transform-the-values-or-the-scale" class="section level4 unnumbered">
<h4>Transform the values or the scale?</h4>
<p>There are two ways we can use log transformations in plots. We can log the values before plotting them or use log scales in the axes. Both approaches are useful and have different strengths. If we log the data, we can more easily interpret intermediate values in the scale. For example, if we see</p>
<blockquote>
<blockquote>
<p>—-1—-x—-2——–3—-</p>
</blockquote>
</blockquote>
<p>for log transformed data, we know that the value of <span class="math inline">\(x\)</span> is about 1.5. If the scales are logged:</p>
<blockquote>
<blockquote>
<p>—-1—-x—-10——100—</p>
</blockquote>
</blockquote>
<p>then, to determine <code>x</code>, we need to compute <span class="math inline">\(10^{1.5}\)</span>, which is not easy to do in our heads. The advantage of using logged scales is that we see the original values on the axes. However, the advantage of showing logged scales is that the original values are displayed in the plot, which are easier to interpret. For example, we would see “32 dollars a day” instead of “5 log base 2 dollar a day”.</p>
<p>As we learned earlier, if we want to scale the axis with logs we can use the <code>scale_x_ccontinuous</code> function. So instead of logging the values first, we apply this layer:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">gapminder <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(year <span class="op">==</span><span class="st"> </span>past_year <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw">is.na</span>(gdp)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(dollars_per_day)) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">geom_histogram</span>(<span class="dt">binwidth =</span> <span class="dv">1</span>, <span class="dt">color =</span> <span class="st">&quot;black&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="dt">trans =</span> <span class="st">&quot;log2&quot;</span>)</code></pre></div>
<p><img src="book_files/figure-html/dollars-per-day-log-scale-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>Note that the log base 10 transformation has it’s own function: <code>scale_x_log10()</code>, but currently base 2 does not. Although we could easily define our own.</p>
<p>There are other transformations available through the <code>trans</code> argument. As we learn later on, the square root (<code>sqrt</code>) transformation, for example, is useful when considering counts. The logistic transformation (<code>logit</code>) is useful when plotting proportions between 0 and 1. The <code>reverse</code> transformation is useful when we want smaller values to be on the right or on top.</p>
</div>
</div>
<div id="modes" class="section level3">
<h3><span class="header-section-number">2.14.8</span> Modes</h3>
<p>In statistics these bumps are sometimes referred to as <em>modes</em>. The mode of a distribution is the value with the highest frequency. The mode of the normal distribution is the average. When a distribution, like the one above, doesn’t monotonically decrease from the mode, we call the locations where it goes up and down again local modes and say that the distribution has multiple modes.</p>
<p>The histogram above suggest that the 1970 country income distribution has two modes: one at about 2 dollars per day (1 in the log 2 scale) and another at about 32 dollars per day (5 in the log 2 scale). This <em>bimodality</em> is consistent with a dichotomous world made up of countries with average incomes less than $8 (3 in the log 2 scale) a day and countries above that.</p>
</div>
<div id="stratify-and-boxplot" class="section level3">
<h3><span class="header-section-number">2.14.9</span> Stratify and boxplot</h3>
<p>The histogram showed us that the income distribution values show a dichotomy. However, the histogram does not show us if the two groups of countries are <em>west</em> versus the <em>developing</em> world.</p>
<p>To see distributions by geographical region, we first stratify the data into regions and then examine the distribution for each. Because of the number of regions</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">n_distinct</span>(gapminder<span class="op">$</span>region)
<span class="co">#&gt; [1] 22</span></code></pre></div>
<p>looking at histograms or smooth densities for each will not be useful. Instead, we can stack boxplots next to each other:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">p &lt;-<span class="st"> </span>gapminder <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(year <span class="op">==</span><span class="st"> </span>past_year <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw">is.na</span>(gdp)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(region, dollars_per_day)) 
p <span class="op">+</span><span class="st"> </span><span class="kw">geom_boxplot</span>() </code></pre></div>
<p><img src="book_files/figure-html/dollars-per-day-boxplot-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>Now we can’t read the region names because the default gpplot2 behavior is to write the labels horizontally and, here, we run out of room. We can easily fix this by rotating the labels. Consulting the cheat sheet we find we can rotate the names by changing the <code>theme</code> through <code>element_text</code>. The <code>hjust=1</code> justifies the text so that it is next to the axis.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_boxplot</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">axis.text.x =</span> <span class="kw">element_text</span>(<span class="dt">angle =</span> <span class="dv">90</span>, <span class="dt">hjust =</span> <span class="dv">1</span>))</code></pre></div>
<p><img src="book_files/figure-html/dollars-per-day-boxplot-rotate-labels-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>We can already see that there is indeed a “west versus the rest”&quot; dichotomy.</p>
<div id="do-not-order-alphabetically" class="section level4 unnumbered">
<h4>Do not order alphabetically</h4>
<p>There are a few more adjustments we can make to this plot that help uncover this reality. First, it helps to order the regions in the boxplots from poor to rich rather than alphabetically. This can be achieved using the <code>reorder</code> function. This function lets us change the order of the levels of a factor variable based on a summary computed on a numeric vector. Remember that many graphing functions coerce character vectors into a factor. The default behavior resutls in alphabetically ordered levels:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fac &lt;-<span class="st"> </span><span class="kw">factor</span>(<span class="kw">c</span>(<span class="st">&quot;Asia&quot;</span>, <span class="st">&quot;Asia&quot;</span>, <span class="st">&quot;West&quot;</span>, <span class="st">&quot;West&quot;</span>, <span class="st">&quot;West&quot;</span>))
<span class="kw">levels</span>(fac)
<span class="co">#&gt; [1] &quot;Asia&quot; &quot;West&quot;</span>

value &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">10</span>, <span class="dv">11</span>, <span class="dv">12</span>, <span class="dv">6</span>, <span class="dv">4</span>)
fac &lt;-<span class="st"> </span><span class="kw">reorder</span>(fac, value, <span class="dt">FUN =</span> mean)
<span class="kw">levels</span>(fac)
<span class="co">#&gt; [1] &quot;West&quot; &quot;Asia&quot;</span></code></pre></div>
<p>Second, we can use color to distinguish the different continents, a visual cue that helps find specific regions. Here is the code:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">p &lt;-<span class="st"> </span>gapminder <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(year <span class="op">==</span><span class="st"> </span>past_year <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw">is.na</span>(gdp)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">region =</span> <span class="kw">reorder</span>(region, dollars_per_day, <span class="dt">FUN =</span> median)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(region, dollars_per_day, <span class="dt">fill =</span> continent)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_boxplot</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">axis.text.x =</span> <span class="kw">element_text</span>(<span class="dt">angle =</span> <span class="dv">90</span>, <span class="dt">hjust =</span> <span class="dv">1</span>)) <span class="op">+</span>
<span class="st">  </span><span class="kw">xlab</span>(<span class="st">&quot;&quot;</span>)
p</code></pre></div>
<p><img src="book_files/figure-html/dollars-per-day-by-continent-boxplot-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>This plot shows two clear groups, with the rich group composed of North America, Northern and Western Europe, New Zealand and Australia. As with the histogram, if we remake the plot using a log scale:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">p <span class="op">+</span><span class="st"> </span><span class="kw">scale_y_continuous</span>(<span class="dt">trans =</span> <span class="st">&quot;log2&quot;</span>)</code></pre></div>
<p><img src="book_files/figure-html/dollars-per-day-by-continent-boxplot-log-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>we are better able to see differences within the developing world.</p>
</div>
<div id="show-the-data" class="section level4 unnumbered">
<h4>Show the data</h4>
<p>In many cases we do not show the data because it adds clutter to the plot and obfuscates the message. In the example above, we don’t have that many points so adding them actually lets us see all the data. We can add this layer using geom_point():</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">p <span class="op">+</span><span class="st"> </span><span class="kw">scale_y_continuous</span>(<span class="dt">trans =</span> <span class="st">&quot;log2&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">show.legend =</span> <span class="ot">FALSE</span>) </code></pre></div>
<p><img src="book_files/figure-html/boxplot-with-points-1.png" width="70%" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="comparing-distributions" class="section level3">
<h3><span class="header-section-number">2.14.10</span> Comparing distributions</h3>
<p>The exploratory data analysis above has revealed two characteristics about average income distribution in 1970. Using a histogram we found a bimodal distribution with the modes relating to poor and rich countries. Then by stratifying by region and examining boxplots, we found that the rich countries were mostly in Europe and Northern America, along with Australia and New Zealand. We define a vector with these regions:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">west &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Western Europe&quot;</span>,
          <span class="st">&quot;Northern Europe&quot;</span>,
          <span class="st">&quot;Southern Europe&quot;</span>,
          <span class="st">&quot;Northern America&quot;</span>,
          <span class="st">&quot;Australia and New Zealand&quot;</span>)</code></pre></div>
<p>Now we want to focus on comparing the differences in distributions across time.</p>
<p>We start by confirming that the bimodality observed in 1970 is explained by a “west versus developing world”&quot; dichotomy. We do this by creating histograms for the previously identified groups. We create the two groups with an <code>ifelse</code> inside a <code>mutate</code> and then we use <code>facet_grid</code> to make a histogram for each group:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">gapminder <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(year <span class="op">==</span><span class="st"> </span>past_year <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw">is.na</span>(gdp)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">group =</span> <span class="kw">ifelse</span>(region<span class="op">%in%</span>west, <span class="st">&quot;West&quot;</span>, <span class="st">&quot;Developing&quot;</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(dollars_per_day)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_histogram</span>(<span class="dt">binwidth =</span> <span class="dv">1</span>, <span class="dt">color =</span> <span class="st">&quot;black&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="dt">trans =</span> <span class="st">&quot;log2&quot;</span>) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">facet_grid</span>(. <span class="op">~</span><span class="st"> </span>group)</code></pre></div>
<p><img src="book_files/figure-html/income-hist-west-v-developing-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>Now we are ready to see if the separation is worse today than it was 40 years ago. We do this by faceting by both region and year:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">past_year &lt;-<span class="st"> </span><span class="dv">1970</span>
present_year &lt;-<span class="st"> </span><span class="dv">2010</span>
gapminder <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(year <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(past_year, present_year) <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw">is.na</span>(gdp)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">group =</span> <span class="kw">ifelse</span>(region<span class="op">%in%</span>west, <span class="st">&quot;West&quot;</span>, <span class="st">&quot;Developing&quot;</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(dollars_per_day)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_histogram</span>(<span class="dt">binwidth =</span> <span class="dv">1</span>, <span class="dt">color =</span> <span class="st">&quot;black&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="dt">trans =</span> <span class="st">&quot;log2&quot;</span>) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">facet_grid</span>(year <span class="op">~</span><span class="st"> </span>group)</code></pre></div>
<p><img src="book_files/figure-html/income-hist-west-v-developing-two-years-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>Before we interpret the findings of this plot, we notice that there are more countries represented in the 2010 histograms than in 1970: the total counts are larger. One reason for this is that several countries were founded after 1970. For example, the Soviet Union divided into several countries including Russia and Ukraine during the 1990s. Another reason is that data was available for more countries in 2010.</p>
<p>We remake the plots using only countries with data available for both years. In the data wrangling chapter we will learn <code>tidyverse</code> tools that permit us to write efficient code for this, but here we can use simple code using the <code>intersect</code> function:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">country_list_<span class="dv">1</span> &lt;-<span class="st"> </span>gapminder <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(year <span class="op">==</span><span class="st"> </span>past_year <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw">is.na</span>(dollars_per_day)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span>.<span class="op">$</span>country

country_list_<span class="dv">2</span> &lt;-<span class="st"> </span>gapminder <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(year <span class="op">==</span><span class="st"> </span>present_year <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw">is.na</span>(dollars_per_day)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span>.<span class="op">$</span>country
      
country_list &lt;-<span class="st"> </span><span class="kw">intersect</span>(country_list_<span class="dv">1</span>, country_list_<span class="dv">2</span>)</code></pre></div>
<p>These 108 account for 86 % of the world population, so this subset should be representative.</p>
<p>Let’s remake the plot but only for this subset by simply adding <code>country %in% country_list</code> to the filter function: <img src="book_files/figure-html/income-histogram-west-v-devel-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>We now see that while the rich countries have become a bit richer, percentage-wise, the poor countries appear to have improved more. In particular, we see that the proportion of <em>developing</em> countries earning more than $16 a day increases substantially.</p>
<p>To see which specific regions improved the most, we can remake the boxplots we made above but now adding the year 2010:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">p &lt;-<span class="st"> </span>gapminder <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(year <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(past_year, present_year) <span class="op">&amp;</span><span class="st"> </span>country <span class="op">%in%</span><span class="st"> </span>country_list) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">ggplot</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">axis.text.x =</span> <span class="kw">element_text</span>(<span class="dt">angle =</span> <span class="dv">90</span>, <span class="dt">hjust =</span> <span class="dv">1</span>)) <span class="op">+</span>
<span class="st">  </span><span class="kw">xlab</span>(<span class="st">&quot;&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">trans =</span> <span class="st">&quot;log2&quot;</span>)  </code></pre></div>
<p>and then using facet to compare the two years:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_boxplot</span>(<span class="kw">aes</span>(region, dollars_per_day, <span class="dt">fill =</span> continent)) <span class="op">+</span>
<span class="st">  </span><span class="kw">facet_grid</span>(year<span class="op">~</span>.)</code></pre></div>
<p><img src="book_files/figure-html/income-histogram-by-region-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>Here, we pause to introduce another powerful ggplot2 feature. Because we want to compare each region before and after, it would be convenient to have the 1970 boxplot next to the 2010 boxplot for each region. In general, comparisons are easier when data are plotted next to each other.</p>
<p>So, instead of faceting, we keep the data from each year together and ask ggplot2 to color (or fill) them depending on the year. Note that groups are automatically separated by year and each pair of boxplots drawn next to each other. Finally, because year is a number, we turn it into a factor since ggplot2 automatically assigns a color to each category of a factor:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_boxplot</span>(<span class="kw">aes</span>(region, dollars_per_day, <span class="dt">fill =</span> <span class="kw">factor</span>(year)))</code></pre></div>
<p><img src="book_files/figure-html/income-histogram-west-v-devel-by-year-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>Finally, we point out that if what we are most interested is in comparing before and after values, it might make more sense to plot the ratios, or difference in the log scale. We are still not ready to learn to code this, but here is what the plot would look like:</p>
<p><img src="book_files/figure-html/income-west-v-devel-before-after-ratio-1.png" width="70%" style="display: block; margin: auto;" /></p>
</div>
<div id="density-plots" class="section level3">
<h3><span class="header-section-number">2.14.11</span> Density plots</h3>
<p>We have used data exploration to discover that the income gap between rich and poor countries has narrowed considerably during the last 40 years. We used a series of histograms and boxplots to see this. Here we suggest a succinct way to convey this message with just one plot. We will use smooth density plots.</p>
<p>Let’s start by noting that density plots for income distribution in 1970 and 2010 deliver the message that the gap is closing:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">gapminder <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(year <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(past_year, present_year) <span class="op">&amp;</span><span class="st"> </span>country <span class="op">%in%</span><span class="st"> </span>country_list) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(dollars_per_day)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_density</span>(<span class="dt">fill =</span> <span class="st">&quot;grey&quot;</span>) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="dt">trans =</span> <span class="st">&quot;log2&quot;</span>) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">facet_grid</span>(year<span class="op">~</span>.)</code></pre></div>
<p><img src="book_files/figure-html/income-smooth-density-by-year-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>In the 1970 plot we see two clear modes: poor and rich countries. In 2010 it appears that some of the poor countries have shifted towards the right, closing the gap.</p>
<p>The next message we need to covey is that the reason for this change in distribution is that poor countries became richer, rather than some rich countries becoming poorer. To do this we need to assign a color to the groups we identified during data exploration.</p>
<p>However, we first need to learn how to make these smooth densities in a way that preserves information on the number of countries in each group. To understand why we need this, note the discrepancy in the size of each group:</p>
<table>
<thead>
<tr class="header">
<th align="left">group</th>
<th align="right">n</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Developing</td>
<td align="right">87</td>
</tr>
<tr class="even">
<td align="left">West</td>
<td align="right">21</td>
</tr>
</tbody>
</table>
<p>Yet when we overlay two densities, the default is to have the area represented by each distribution add up to 1 regardless of the size of each group:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">gapminder <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(year <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(past_year, present_year) <span class="op">&amp;</span><span class="st"> </span>country <span class="op">%in%</span><span class="st"> </span>country_list) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">group =</span> <span class="kw">ifelse</span>(region <span class="op">%in%</span><span class="st"> </span>west, <span class="st">&quot;West&quot;</span>, <span class="st">&quot;Developing&quot;</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(dollars_per_day, <span class="dt">fill =</span> group)) <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="dt">trans =</span> <span class="st">&quot;log2&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_density</span>(<span class="dt">alpha =</span> <span class="fl">0.2</span>) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">facet_grid</span>(year <span class="op">~</span><span class="st"> </span>.)</code></pre></div>
<p><img src="book_files/figure-html/income-smooth-density-by-year-west-v-developing-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>which make it appear as if there are the same number of countries in each group. To change this, we will need to learn to access computed variables with <code>geom_density</code> function.</p>
</div>
<div id="accessing-computed-variables" class="section level3">
<h3><span class="header-section-number">2.14.12</span> Accessing computed variables</h3>
<p>To have the areas of these densities be proportional to the size of the groups, we can simply multiply the y-axis values by the size of the group. From the <code>geom_density</code> help file we see that the functions compute a variable called <code>count</code> that does exactly this. We want this variable to be on the y-axis rather than the density.</p>
<p>In ggplot2 we access these variables by surrounding the name with two dots <code>..</code>. So we will use the following mapping:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">aes</span>(<span class="dt">x =</span> dollars_per_day, <span class="dt">y =</span> ..count..)</code></pre></div>
<p>We can now create the desired plot by simply changing the mapping in the previous code chunk:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">p &lt;-<span class="st"> </span>gapminder <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(year <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(past_year, present_year) <span class="op">&amp;</span><span class="st"> </span>country <span class="op">%in%</span><span class="st"> </span>country_list) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">group =</span> <span class="kw">ifelse</span>(region <span class="op">%in%</span><span class="st"> </span>west, <span class="st">&quot;West&quot;</span>, <span class="st">&quot;Developing&quot;</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(dollars_per_day, <span class="dt">y =</span> ..count.., <span class="dt">fill =</span> group)) <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="dt">trans =</span> <span class="st">&quot;log2&quot;</span>)

p <span class="op">+</span><span class="st"> </span><span class="kw">geom_density</span>(<span class="dt">alpha =</span> <span class="fl">0.2</span>) <span class="op">+</span><span class="st"> </span><span class="kw">facet_grid</span>(year <span class="op">~</span><span class="st"> </span>.)</code></pre></div>
<p><img src="book_files/figure-html/income-smooth-density-counts-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>If we want the densities to be smoother, we use the <code>bw</code> argument. We tried a few and decided on 0.75:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_density</span>(<span class="dt">alpha =</span> <span class="fl">0.2</span>, <span class="dt">bw =</span> <span class="fl">0.75</span>) <span class="op">+</span><span class="st"> </span><span class="kw">facet_grid</span>(year <span class="op">~</span><span class="st"> </span>.)</code></pre></div>
<p><img src="book_files/figure-html/income-smooth-density-counts-by-year-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>This plot now shows what is happening very clearly. The developing world distribution is changing. A third mode appears consisting of the countries that most narrowed the gap.</p>
</div>
<div id="case_when" class="section level3">
<h3><span class="header-section-number">2.14.13</span> ‘case_when’</h3>
<p>We can actually make this figure somewhat more informative. From the exploratory data analysis we noticed that many of the countries that most improved were from Asia. We can easily alter the plot to show key regions separately.</p>
<p>We introduce the <code>case_when</code> function which is useful for defining groups. It currently does not have a data argument (this might change) so we need to access the components of our data table using the dot placeholder:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">gapminder &lt;-<span class="st"> </span>gapminder <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">group =</span> <span class="kw">case_when</span>(
    .<span class="op">$</span>region <span class="op">%in%</span><span class="st"> </span>west <span class="op">~</span><span class="st"> &quot;West&quot;</span>,
    .<span class="op">$</span>region <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Eastern Asia&quot;</span>, <span class="st">&quot;South-Eastern Asia&quot;</span>) <span class="op">~</span><span class="st"> &quot;East Asia&quot;</span>,
    .<span class="op">$</span>region <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Caribbean&quot;</span>, <span class="st">&quot;Central America&quot;</span>, <span class="st">&quot;South America&quot;</span>) <span class="op">~</span><span class="st"> &quot;Latin America&quot;</span>,
    .<span class="op">$</span>continent <span class="op">==</span><span class="st"> &quot;Africa&quot;</span> <span class="op">&amp;</span><span class="st"> </span>.<span class="op">$</span>region <span class="op">!=</span><span class="st"> &quot;Northern Africa&quot;</span> <span class="op">~</span><span class="st"> &quot;Sub-Saharan Africa&quot;</span>,
    <span class="ot">TRUE</span> <span class="op">~</span><span class="st"> &quot;Others&quot;</span>))</code></pre></div>
<p>We turn this <code>group</code> variable into a factor to control the order of the levels:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">gapminder &lt;-<span class="st"> </span>gapminder <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">group =</span> <span class="kw">factor</span>(group, <span class="dt">levels =</span> <span class="kw">c</span>(<span class="st">&quot;Others&quot;</span>, <span class="st">&quot;Latin America&quot;</span>, <span class="st">&quot;East Asia&quot;</span>,<span class="st">&quot;Sub-Saharan Africa&quot;</span>, <span class="st">&quot;West&quot;</span>)))</code></pre></div>
<p>We pick this particular order for a reason that becomes clear later.</p>
<p>Now we can now easily plot the densities for each region. We use <code>color</code> and <code>size</code> to clearly see the tops:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">p &lt;-<span class="st"> </span>gapminder <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">filter</span>(year <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(past_year, present_year) <span class="op">&amp;</span><span class="st"> </span>country <span class="op">%in%</span><span class="st"> </span>country_list) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(dollars_per_day, <span class="dt">y =</span> ..count.., <span class="dt">fill =</span> group, <span class="dt">color =</span> group)) <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="dt">trans =</span> <span class="st">&quot;log2&quot;</span>)

p <span class="op">+</span><span class="st"> </span><span class="kw">geom_density</span>(<span class="dt">alpha =</span> <span class="fl">0.2</span>, <span class="dt">bw =</span> <span class="fl">0.75</span>, <span class="dt">size =</span> <span class="dv">2</span>) <span class="op">+</span><span class="st"> </span><span class="kw">facet_grid</span>(year <span class="op">~</span><span class="st"> </span>.)</code></pre></div>
<p><img src="book_files/figure-html/income-smooth-density-by-region-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>The plot is cluttered and somewhat hard to read. A clearer picture is sometimes achieved by stacking the densities on top of each other:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_density</span>(<span class="dt">alpha =</span> <span class="fl">0.2</span>, <span class="dt">bw =</span> <span class="fl">0.75</span>, <span class="dt">position =</span> <span class="st">&quot;stack&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">facet_grid</span>(year <span class="op">~</span><span class="st"> </span>.)</code></pre></div>
<p><img src="book_files/figure-html/income-smooth-density-counts-by-region-and-year-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>Here we can clearly see how the distributions for East Asia, Latin America and others shift markedly to the right. While Sub-Saharan Africa remains stagnant.</p>
<p>Notice that we order the levels of the group so that the West’s density are plotted first, then Sub-Saharan Africa. Having the two extremes plotted first allows us see the remaining bimodality better.</p>
<div id="weighted-densities" class="section level4">
<h4><span class="header-section-number">2.14.13.1</span> Weighted densities</h4>
<p>As a final point, we note that these distributions weigh every country the same. So if most of the population is improving, but living in a very large country, such as China, we might not appreciate this. We can actually weight the smooth densities using the <code>weight</code> mapping argument. The plot then looks like this:</p>
<p><img src="book_files/figure-html/income-smooth-density-counts-by-region-year-weighted-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>This particular figure shows very clearly how the income distribution gap is closing with most of the poor remaining in Sub-Saharan Africa.</p>
</div>
</div>
</div>
<div id="ecological-fallacy" class="section level2">
<h2><span class="header-section-number">2.15</span> Ecological fallacy</h2>
<p>Throughout this section we have been comparing regions of the world. We have seen that, on average, some regions do better than others. In this section, we focus on describing the importance of variability within the groups when examining the relationship between a country’s infant mortality rates and average income.</p>
<p>We start by comparing these quantities across regions but before doing this we define a few more regions:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">gapminder &lt;-<span class="st"> </span>gapminder <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">group =</span> <span class="kw">case_when</span>(
    .<span class="op">$</span>region <span class="op">%in%</span><span class="st"> </span>west <span class="op">~</span><span class="st"> &quot;The West&quot;</span>,
    .<span class="op">$</span>region <span class="op">%in%</span><span class="st"> &quot;Northern Africa&quot;</span> <span class="op">~</span><span class="st"> &quot;Northern Africa&quot;</span>,
    .<span class="op">$</span>region <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Eastern Asia&quot;</span>, <span class="st">&quot;South-Eastern Asia&quot;</span>) <span class="op">~</span><span class="st"> &quot;East Asia&quot;</span>,
    .<span class="op">$</span>region <span class="op">==</span><span class="st"> &quot;Southern Asia&quot;</span><span class="op">~</span><span class="st"> &quot;Southern Asia&quot;</span>,
    .<span class="op">$</span>region <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Central America&quot;</span>, <span class="st">&quot;South America&quot;</span>, <span class="st">&quot;Caribbean&quot;</span>) <span class="op">~</span><span class="st"> &quot;Latin America&quot;</span>,
    .<span class="op">$</span>continent <span class="op">==</span><span class="st"> &quot;Africa&quot;</span> <span class="op">&amp;</span><span class="st"> </span>.<span class="op">$</span>region <span class="op">!=</span><span class="st"> &quot;Northern Africa&quot;</span> <span class="op">~</span><span class="st"> &quot;Sub-Saharan Africa&quot;</span>,
    .<span class="op">$</span>region <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Melanesia&quot;</span>, <span class="st">&quot;Micronesia&quot;</span>, <span class="st">&quot;Polynesia&quot;</span>) <span class="op">~</span><span class="st"> &quot;Pacific Islands&quot;</span>))</code></pre></div>
<p>We then compute these quantities for each region:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">surv_income &lt;-<span class="st"> </span>gapminder <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(year <span class="op">%in%</span><span class="st"> </span>present_year <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw">is.na</span>(gdp) <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw">is.na</span>(infant_mortality) <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw">is.na</span>(group)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(group) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarize</span>(<span class="dt">income =</span> <span class="kw">sum</span>(gdp)<span class="op">/</span><span class="kw">sum</span>(population)<span class="op">/</span><span class="dv">365</span>,
            <span class="dt">infant_survival_rate =</span> <span class="dv">1</span><span class="op">-</span><span class="kw">sum</span>(infant_mortality<span class="op">/</span><span class="dv">1000</span><span class="op">*</span>population)<span class="op">/</span><span class="kw">sum</span>(population)) 

surv_income <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">arrange</span>(income)
<span class="co">#&gt; # A tibble: 7 x 3</span>
<span class="co">#&gt;                group income infant_survival_rate</span>
<span class="co">#&gt;                &lt;chr&gt;  &lt;dbl&gt;                &lt;dbl&gt;</span>
<span class="co">#&gt; 1 Sub-Saharan Africa   1.76                0.936</span>
<span class="co">#&gt; 2      Southern Asia   2.07                0.952</span>
<span class="co">#&gt; 3    Pacific Islands   2.70                0.956</span>
<span class="co">#&gt; 4    Northern Africa   4.94                0.970</span>
<span class="co">#&gt; 5      Latin America  13.24                0.983</span>
<span class="co">#&gt; 6          East Asia  13.44                0.985</span>
<span class="co">#&gt; # ... with 1 more rows</span></code></pre></div>
<p>This shows a dramatic difference. While in the West less than 0.5% of infants die, in Sub-Saharan Africa the rate is higher than 6%! The relationship between these two variables is almost perfectly linear:</p>
<p><img src="book_files/figure-html/ecological-fallacy-averages-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>In this plot we introduce the use of the <code>limit</code> argument which lets us change the range of the axes. We are making the range larger than the data requires because we will later compare this plot to one with more variability and we want the ranges to be the same. We also introduce the <code>breaks</code> argument which lets us set the location of the axes labels. Finally, we introduce a new transformation, the logistic transformation.</p>
<div id="logistic-transformation" class="section level4 unnumbered">
<h4>Logistic transformation</h4>
<p>The logistic or logit transformation for a proportion or rate <span class="math inline">\(p\)</span> is defined as:</p>
<p><span class="math display">\[f(p) = \log \left( \frac{p}{1-p} \right)\]</span></p>
<p>When <span class="math inline">\(p\)</span> is a proportion or probability, the quantity that is being logged, <span class="math inline">\(p/(1-p)\)</span> is called the <em>odds</em>. In this case <span class="math inline">\(p\)</span> is the proportion of infants that survived. The odds tell us how many more infants are expected to survive than to die. The log transformation makes this symmetric. If the rates are the same, then the log odds is 0. Fold increases or decreases turn into positive and negative increments respectively.</p>
<p>This scale is useful when we want to highlight differences near 0 or 1. For survival rates this is important because a survival rate of 90% is unacceptable, while a survival of 99% is relatively good. We would much prefer a survival rate closer to 99.9%. We want our scale to highlight these difference and the logit does this. Note that 99.9/0.1 is about 10 times bigger than 99/1 which is about 10 times larger than 90/10. And by using the log these fold changes turn into constant increases.</p>
</div>
<div id="show-the-data-1" class="section level4 unnumbered">
<h4>Show the data</h4>
<p>Now, back to our plot. Based on the plot above, do we conclude that a country with a low income is destined to have low survival rate? Do we conclude that all survival rates in Sub-Saharan Africa are all lower than in Southern Asia which in turn are lower than in the Pacific Islands, and so on?</p>
<p>Jumping to this conclusion based on a plot showing averages is referred to as the <em>ecological fallacy</em>. The almost perfect relationship between survival rates and income is only observed for the averages at the region level. Once we show all the data, we see a somewhat more complicated story:</p>
<p><img src="book_files/figure-html/ecological-fallacy-all-data-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>Specifically, we see that there is a large amount of variability. We see that countries from the same regions can be quite different and that countries with the same income can have different survival rates. For example, while on average Sub-Saharan Africa had the worse health and economic outcomes, there is wide variability within that group. Mauritius and Botswana are doing better than Angola and Sierra Leone with Mauritius comparable to Western countries.</p>

</div>
</div>
<div id="some-data-visualization-principles" class="section level2">
<h2><span class="header-section-number">2.16</span> Some data visualization principles</h2>
<p>We have already provided some rules to follow as we created plots for our examples. Here we aim to provide some general principles we can use as a guide for effective data visualization. Much of this section is based on a talk by <a href="http://kbroman.org/">Karl Broman</a> titled <a href="https://www.biostat.wisc.edu/~kbroman/presentations/graphs2017.pdf">“Creating effective figures and tables”</a> including some of the figures which were made with code that Karl makes available on his <a href="https://github.com/kbroman/Talk_Graphs">GitHub</a> repository, and class notes from Peter Aldhous’ <a href="http://paldhous.github.io/ucb/2016/dataviz/index.html">Introduction to Data Visualization course</a>. Following Karl’s approach, we show some examples of plot styles we should avoid, explain how to improve them, and use these as motivation for a list of principles. We compare and contrast plots that follow these principles to those that don’t.</p>
<p>The principles are mostly based on research related to how humans detect patterns and make visual comparisons. The preferred approaches are those that best fit the way our brains process visual information. When deciding on a visualization approach it is also important to keep our goal in mind. We may be comparing a viewable number of quantities, describing distribution for categories or numeric values, comparing the data from two groups, or describing the relationship between two variables. As a final note, we want to emphasize that for a data scientist it is important to adapt and optimize graphs to the audience. For example, an exploratory plot made for ourselves will be different than a chart intended to communicate a finding to a general audience.</p>
<p>We will be using these libraries:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(tidyverse)
<span class="kw">library</span>(gridExtra)
<span class="kw">library</span>(dslabs)</code></pre></div>
<div id="encoding-data-using-visual-cues" class="section level3">
<h3><span class="header-section-number">2.16.1</span> Encoding data using visual cues</h3>
<p>We start by describing some principles for encoding data. There are several approaches at our disposal including position, aligned lengths, angles, area, brightness, and color hue.</p>
<p>To illustrate how some of these strategies compare, let’s suppose we want to report the results from two hypothetical polls regarding browser preference taken in 2000 and then 2015. Here, for each year, we are simply comparing four quantities – the four percentages. A widely used graphical representation of percentages, popularized by Microsoft Excel, is the pie chart:</p>
<div class="figure" style="text-align: center"><span id="fig:piechart"></span>
<img src="book_files/figure-html/piechart-1.png" alt="Pie chart of browser usage." width="70%" />
<p class="caption">
Figure 2.10: Pie chart of browser usage.
</p>
</div>
<p>Here we are representing quantities with both areas and angles since both the angle and area of each pie slice is proportional to the quantity it represents. This turns out to be a suboptimal choice since, as demonstrated by perception studies, humans are not good at precisely quantifying angles and are even worse when only area is the only available visual cue. The donut chart is an example of a plot that uses only area:</p>
<div class="figure" style="text-align: center"><span id="fig:donutchart"></span>
<img src="book_files/figure-html/donutchart-1.png" alt="Pie chart of browser usage." width="70%" />
<p class="caption">
Figure 2.11: Pie chart of browser usage.
</p>
</div>
<p>To see how hard it is to quantify angles and area, note that the rankings and all the percentages in the plots above changed from 2000 to 2015. Can you determine the actual percentages and rank the browsers’ popularity? Can you see how the percentages changed from 2000 to 2015? It is not easy to tell from the plot. In fact, the <code>pie</code> R function help file states that:</p>
<blockquote>
<p>“Pie charts are a very bad way of displaying information. The eye is good at judging linear measures and bad at judging relative areas. A bar chart or dot chart is a preferable way of displaying this type of data.</p>
</blockquote>
<p>In this case, simply showing the numbers is not only clearer, but would also save on printing costs if printing a paper copy.</p>
<table>
<thead>
<tr class="header">
<th align="left">Browser</th>
<th align="right">2000</th>
<th align="right">2015</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Opera</td>
<td align="right">3</td>
<td align="right">2</td>
</tr>
<tr class="even">
<td align="left">Safari</td>
<td align="right">21</td>
<td align="right">22</td>
</tr>
<tr class="odd">
<td align="left">Firefox</td>
<td align="right">23</td>
<td align="right">21</td>
</tr>
<tr class="even">
<td align="left">Chrome</td>
<td align="right">26</td>
<td align="right">29</td>
</tr>
<tr class="odd">
<td align="left">IE</td>
<td align="right">28</td>
<td align="right">27</td>
</tr>
</tbody>
</table>
<p>The preferred way to plot these quantities is to use length and position as visual cues since humans are much better at judging linear measures. The bar plot uses this approach by using bars of length proportional to the quantities of interest. By adding horizontal lines at strategically chosen values, in this case at every multiple of 10, we ease the visual burden of quantifying through the position of the top of the bars. Compare and contrast the information we can extract from the two figures.</p>
<div class="figure" style="text-align: center"><span id="fig:two-barplots"></span>
<img src="book_files/figure-html/two-barplots-1.png" alt="Barplot of browser usage." width="70%" />
<p class="caption">
Figure 2.12: Barplot of browser usage.
</p>
</div>
<p>Notice how much easier it is to see the differences in the bar plot. In fact, we can now determine the actual percentages by following a horizontal line to the x-axis.</p>
<p>If for some reason you need to make a pie chart, label each pie slice with its respective percentage so viewers do not have to infer them from the angles or area:</p>
<p><img src="book_files/figure-html/excel-barplot-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>In general, when displaying quantities, position and length are preferred over angles and/or area. Brightness and color are even harder to quantify than angles. But, as we will see later, they are sometimes useful when more than two dimensions must be displayed at once.</p>
</div>
<div id="know-when-to-include-0" class="section level3">
<h3><span class="header-section-number">2.16.2</span> Know when to include 0</h3>
<p>When using bar plots it is dishonest not to start the bars at 0. This is because, by using a bar plot, we are implying the length is proportional to the quantities being displayed. By avoiding 0, relatively small differences can be made to look much bigger than they actually are. This approach is often used by politicians or media organizations trying to exaggerate a difference. Below is an illustrative example:</p>
<p><img src="img/class2_8.jpg" width="70%" style="display: block; margin: auto;" /></p>
<p>(Source: Fox News, via <a href="http://paldhous.github.io/ucb/2016/dataviz/week2.html">Peter Aldhous</a> via Media Matters via Fox News) via <a href="http://mediamatters.org/blog/2013/04/05/fox-news-newest-dishonest-chart-immigration-enf/193507">Media Matters</a>.</p>
<p>From the plot above, it appears that apprehensions have almost tripled when, in fact, they have only increased by about 16%. Starting the graph at 0 illustrates this clearly:</p>
<p><img src="book_files/figure-html/barplot-from-zero-1-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>Here is another example, described in detail: <a href="http://flowingdata.com/2012/08/06/fox-news-continues-charting-excellence/">here</a>.</p>
<p><img src="img/Bush-cuts.png" width="70%" style="display: block; margin: auto;" /></p>
<p>which makes a 13% increase look like a five fold change. Here is the appropriate plot:</p>
<p><img src="book_files/figure-html/barplot-from-zero-2-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>When using position rather than length, then it is not necessary to include 0. This is particularly the case when we want to compare differences between groups relative to the within the group variability. Here is an illustrative example showing country average life expectancy stratified across continents in 2012:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">p1 &lt;-<span class="st"> </span>gapminder <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(year <span class="op">==</span><span class="st"> </span><span class="dv">2012</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(continent, life_expectancy)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>()
p2 &lt;-<span class="st"> </span>p1 <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">limits =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">84</span>))
<span class="kw">grid.arrange</span>(p2, p1, <span class="dt">ncol =</span> <span class="dv">2</span>)</code></pre></div>
<p><img src="book_files/figure-html/points-plot-not-fromw-zero-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>Note that in the plot on the left, which includes 0, the space between 0 and 43 adds no information and makes it harder to compare the between and within group variability.</p>
</div>
<div id="do-not-distort-quantities" class="section level3">
<h3><span class="header-section-number">2.16.3</span> Do not distort quantities</h3>
<p>During President Barack Obama’s 2011 State of the Union Address the following chart was used to compare the US GDP to the GDP of four competing nations:</p>
<p><img src="img/class2_30.jpg" width="70%" style="display: block; margin: auto;" /></p>
<p>Judging by the area of the circles, the US appears to have an economy over five times larger than China’s and over 30 times larger than France’s. However, if we look at the actual numbers, we see that this is not the case. The actual ratios are 2.6 and 5.8 times bigger than China and France respectively. The reason for this distortion is that the radius, rather than the area, was made to be proportional to the quantity. which implies that the proportion between the areas is squared: 2.6 turns into 6.5 and 5.8 turns into 34.1. Here is a comparison of the circles we get if we make the value proportional to the radius and to the area:</p>
<p><img src="book_files/figure-html/area-not-radius-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>Not surprisingly, ggplot defaults to using area rather than radius. Of course, in this case, we really should not be using area at all since we can use position and length:</p>
<p><img src="book_files/figure-html/barplot-better-than-area-1.png" width="70%" style="display: block; margin: auto;" /></p>
</div>
<div id="order-by-a-meaningful-value" class="section level3">
<h3><span class="header-section-number">2.16.4</span> Order by a meaningful value</h3>
<p>When one of the axes is used to show categories, as is done in bar plots, the default ggplot behavior is to order the categories alphabetically when they are defined by character strings. If they are defined by factors, they are ordered by the factor levels. We rarely want to use alphabetical order. Instead we should order by a meaningful quantity. In all the cases above, the bar plots where ordered by the values being displayed. The exception was the graph showing bar plots comparing browsers. In this case we kept the order the same across the bar plots to ease the comparison. Specifically instead of ordering the browsers separately in the two years, we ordered both years by the average value of 2000 and 2015.</p>
<p>We previously learned how to use the <code>reorder</code> function, which helps us achieve this goal. To appreciate how the right order can help convey a message, suppose we want to create a plot to compare the murder rate across states. We are particularly interested in the most dangerous and safest states. Note the difference when we order alphabetically (the default) versus when we order by the actual rate:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">data</span>(murders)
p1 &lt;-<span class="st"> </span>murders <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">murder_rate =</span> total <span class="op">/</span><span class="st"> </span>population <span class="op">*</span><span class="st"> </span><span class="dv">100000</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(state, murder_rate)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_bar</span>(<span class="dt">stat=</span><span class="st">&quot;identity&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">coord_flip</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">xlab</span>(<span class="st">&quot;&quot;</span>)

p2 &lt;-<span class="st"> </span>murders <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">murder_rate =</span> total <span class="op">/</span><span class="st"> </span>population <span class="op">*</span><span class="st"> </span><span class="dv">100000</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">state =</span> <span class="kw">reorder</span>(state, murder_rate)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(state, murder_rate)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_bar</span>(<span class="dt">stat=</span><span class="st">&quot;identity&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">coord_flip</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">xlab</span>(<span class="st">&quot;&quot;</span>)
<span class="kw">grid.arrange</span>(p1, p2, <span class="dt">ncol =</span> <span class="dv">2</span>)</code></pre></div>
<p><img src="book_files/figure-html/do-not-order-alphabetically-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>The <code>reorder</code> function lets us reorder groups as well. Earlier we saw an example related to income distributions across regions. Here are the two versions plotted against each other:</p>
<p><img src="book_files/figure-html/reorder-boxplot-example-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>The first orders the regions alphabetically while the second orders them by the group’s median.</p>
</div>
<div id="show-the-data-2" class="section level3">
<h3><span class="header-section-number">2.16.5</span> Show the data</h3>
<p>We have focused on displaying single quantities across categories. We now shift our attention to displaying data, with a focus on comparing groups.</p>
<p>To motivate our first principle, ‘show the data’, we go back to our artificial example of describing heights to ET, an extraterrestrial. This time let’s assume ET is interested in the difference in heights between males and females. A commonly seen plot used for comparisons between groups, popularized by software such as Microsoft Excel, shows the average and standard errors (standard errors are defined in a later chapter, but do not confuse them with the standard deviation of the data). The plot looks like this:</p>
<p><img src="book_files/figure-html/show-data-1-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>The average of each group is represented by the top of each bar and the antennae extend out from the average to the average plus two standard errors. If all ET receives is this plot, he will have little information on what to expect if he meets a group of human males and females. The bars go to 0, does this mean there are tiny humans measuring less than one foot? Are all males taller than the tallest females? Is there a range of heights? ET can’t answer these questions since we have provided almost no information on the height distribution.</p>
<p>This brings us to our first principle: show the data. This simple ggplot2 code already generates a more informative plot than the bar plot by simply showing all the data points:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">heights <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(sex, height)) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">geom_point</span>() </code></pre></div>
<p><img src="book_files/figure-html/show-data-2-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>For example, this plot gives us an idea of the range of the data. However, this plot has limitations as well since we can’t really see all the 238 and 812 points plotted for females and males respectively, and many points are plotted on top of each other. As we have previously described, visualizing the distribution is much more informative. But before doing this, we point out two ways we can improve a plot showing all the points.</p>
<p>The first is to add <em>jitter</em>, which adds a small random shift to each point. In this case adding horizontal jitter does not alter the interpretation, since the height of the points do not change, but we minimize the number of points that fall on top of each other and therefore get a better visual sense of how the data is distributed. A second improvement comes from using <em>alpha blending</em>: making the points somewhat transparent. The more points fall on top of each other, the darker the plot, which also helps us get a sense of how the points are distributed. Here is the same plot with jitter and alpha blending:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">heights <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(sex, height)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_jitter</span>(<span class="dt">width =</span> <span class="fl">0.1</span>, <span class="dt">alpha =</span> <span class="fl">0.2</span>) </code></pre></div>
<p><img src="book_files/figure-html/show-points-with-jitter-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>Now we start getting a sense that, on average, males are taller than females. We also note dark horizontal bands of points, demonstrating that many report values that are rounded to the nearest integer.</p>
</div>
<div id="ease-comparisons-use-common-axes" class="section level3">
<h3><span class="header-section-number">2.16.6</span> Ease comparisons: use common axes</h3>
<p>Since there are so many points, it is more effective to show distributions rather than individual points. We therefore show histograms for each group:</p>
<p><img src="book_files/figure-html/common-axes-histograms-wrong-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>However, from this plot it is not immediately obvious that males are, on average, taller than females. We have to look carefully to notice that the x-axis has a higher range of values in the male histogram. An important principle here is to <strong>keep the axes the same</strong> when comparing data across to plots. Note how the comparison becomes easier:</p>
<p><img src="book_files/figure-html/common-axes-histograms-right-1.png" width="70%" style="display: block; margin: auto;" /></p>
</div>
<div id="ease-comparisons-align-plots-vertically-to-see-horizontal-changes-and-horizontally-to-see-vertical-changes" class="section level3">
<h3><span class="header-section-number">2.16.7</span> Ease comparisons: align plots vertically to see horizontal changes and horizontally to see vertical changes</h3>
<p>In these histograms, the visual cue related to decreases or increases in height are shifts to the left or right respectively: horizontal changes. Aligning the plots vertically helps us see this change when the axis are fixed:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">p2 &lt;-<span class="st"> </span>heights <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(height, ..density..)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_histogram</span>(<span class="dt">binwidth =</span> <span class="dv">1</span>, <span class="dt">color=</span><span class="st">&quot;black&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">facet_grid</span>(sex<span class="op">~</span>.)
p2</code></pre></div>
<p><img src="book_files/figure-html/common-axes-histograms-right-2-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>This plot makes it much easier to notice that men are, on average, taller.</p>
<p>If instead of histograms we want the more compact summary provided by box plots, then we align them horizontally since, by default, box plots move up and down with changes in height. Following our <em>show the data</em> principle we then overlay all the data points:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">p3 &lt;-<span class="st"> </span>heights <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(sex, height)) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">geom_boxplot</span>(<span class="dt">coef=</span><span class="dv">3</span>) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">geom_jitter</span>(<span class="dt">width =</span> <span class="fl">0.1</span>, <span class="dt">alpha =</span> <span class="fl">0.2</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">ylab</span>(<span class="st">&quot;Height in inches&quot;</span>)
p3</code></pre></div>
<p><img src="book_files/figure-html/boxplot-with-points-with-jitter-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>Now contrast and compare these three plots, based on exactly the same data:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">grid.arrange</span>(p1, p2, p3, <span class="dt">ncol =</span> <span class="dv">3</span>)</code></pre></div>
<p><img src="book_files/figure-html/show-the-data-comparison-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>Notice how much more we learn from the two plots on the right. Bar plots are useful for showing one number, but not very useful when we want to describe distributions.</p>
</div>
<div id="consider-transformations" class="section level3">
<h3><span class="header-section-number">2.16.8</span> Consider transformations</h3>
<p>We have motivated the use of the log transformation in cases were the changes are multiplicative. Population size was an example in which we found a log transformation to yield a more informative transformation.</p>
<p>The combination of an incorrectly chosen bar plot and a failure to use a log transformation when one is merited can be particularly distorting. As an example consider this bar plot showing the average population sizes for each continent in 2015:</p>
<p><img src="book_files/figure-html/no-transformations-wrong-use-of-barplot-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>From this plot one would conclude that countries in Asia are much more populous than in other continents. Following the <em>show the data</em> principle we quickly notice that this is due to two very large countries, which we assume are India and China:</p>
<p><img src="book_files/figure-html/no-transformation-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>Here, using a log transformation provides a much more informative plot. We compare the original bar plot to a box plot using the log scale transformation for the y-axis:</p>
<p><img src="book_files/figure-html/correc-transformation-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>With the new plot we realize that countries in Africa actually have a larger median population size than those in Asia.</p>
<p>Other transformations you should consider are the logistic transformation, useful to better see fold changes in odds, and the square root transformation, useful for count data.</p>
</div>
<div id="ease-comparisons-visual-cues-to-be-compared-should-be-adjacent." class="section level3">
<h3><span class="header-section-number">2.16.9</span> Ease comparisons: Visual cues to be compared should be adjacent.</h3>
<p>When comparing income data across regions between 1970 and 2010 we made a figure similar to the one below. A difference is that here we look at continents instead of regions, but this is not relevant to the point we are making.</p>
<p><img src="book_files/figure-html/boxplots-not-adjacent-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>For each continent we want to compare the distributions from 1970 to 2010. The default in ggplot2 is to order labels alphabetically so the labels with 1970 come before the labels with 2010, making the comparisons challenging. But it is much easier to make the comparison when the box plots are next to each other:</p>
<p><img src="book_files/figure-html/boxplot-adjacent-comps-1.png" width="70%" style="display: block; margin: auto;" /></p>
</div>
<div id="ease-comparison-use-color" class="section level3">
<h3><span class="header-section-number">2.16.10</span> Ease comparison: use color</h3>
<p>The comparison becomes even easier to make if we use color to denote the two things we want to compare:</p>
<p><img src="book_files/figure-html/boxplot-adjacent-comps-with-color-1.png" width="70%" style="display: block; margin: auto;" /></p>
</div>
<div id="think-of-the-color-blind" class="section level3">
<h3><span class="header-section-number">2.16.11</span> Think of the color blind</h3>
<p>About 10% of the population is color blind. Unfortunately, the default colors used in ggplot are not optimal for this group. However, ggplot does it make it easy to change the color palette used in the plots. An example of how we can use a color blind friendly palette is described <a href="http://www.cookbook-r.com/Graphs/Colors_(ggplot2)/#a-colorblind-friendly-palette">here</a>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">color_blind_friendly_cols &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;#999999&quot;</span>, <span class="st">&quot;#E69F00&quot;</span>, <span class="st">&quot;#56B4E9&quot;</span>, <span class="st">&quot;#009E73&quot;</span>, <span class="st">&quot;#F0E442&quot;</span>, <span class="st">&quot;#0072B2&quot;</span>, <span class="st">&quot;#D55E00&quot;</span>, <span class="st">&quot;#CC79A7&quot;</span>)
p1 &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">x=</span><span class="dv">1</span><span class="op">:</span><span class="dv">8</span>, <span class="dt">y=</span><span class="dv">1</span><span class="op">:</span><span class="dv">8</span>, <span class="dt">col =</span> <span class="kw">as.character</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">8</span>)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(x, y, <span class="dt">color =</span> col)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>(<span class="dt">size=</span><span class="dv">5</span>)
p1 <span class="op">+</span><span class="st"> </span><span class="kw">scale_color_manual</span>(<span class="dt">values=</span>color_blind_friendly_cols)</code></pre></div>
<p><img src="book_files/figure-html/color-blind-friendly-colors-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>There are several resources that can help you select colors, for example <a href="http://bconnelly.net/2013/10/creating-colorblind-friendly-figures/">this one</a>.</p>
</div>
<div id="use-scatter-plots-to-examine-the-relationship-between-two-variables" class="section level3">
<h3><span class="header-section-number">2.16.12</span> Use scatter plots to examine the relationship between two variables</h3>
<p>In every single instance in which we have examined the relationship between two variables, including total murders versus population size, life expectancy versus fertility rates, and infant mortality versus income, we have used scatter plots. This is the plot we generally recommend.</p>
<div id="slope-charts" class="section level4">
<h4><span class="header-section-number">2.16.12.1</span> Slope charts</h4>
<p>One exception where another type of plot may be more informative is when you are comparing variables of the same type but at different time points and for a relatively small number of comparisons. For example, comparing life expectancy between 2010 and 2015. In this case we might recommend a <em>slope chart</em>.</p>
<p>There is not geometry for slope charts in ggplot2 but we can construct one using <code>geom_lines</code>. We need to do some tinkering to add labels. Here is an example comparing 2010 to 2015 for large western countries:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">west &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Western Europe&quot;</span>,<span class="st">&quot;Northern Europe&quot;</span>,<span class="st">&quot;Southern Europe&quot;</span>,
          <span class="st">&quot;Northern America&quot;</span>,<span class="st">&quot;Australia and New Zealand&quot;</span>)

dat &lt;-<span class="st"> </span>gapminder <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(year<span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="dv">2010</span>, <span class="dv">2015</span>) <span class="op">&amp;</span><span class="st"> </span>region <span class="op">%in%</span><span class="st"> </span>west <span class="op">&amp;</span><span class="st"> </span>
<span class="st">           </span><span class="op">!</span><span class="kw">is.na</span>(life_expectancy) <span class="op">&amp;</span><span class="st"> </span>population <span class="op">&gt;</span><span class="st"> </span><span class="dv">10</span><span class="op">^</span><span class="dv">7</span>) 

dat <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">location =</span> <span class="kw">ifelse</span>(year <span class="op">==</span><span class="st"> </span><span class="dv">2010</span>, <span class="dv">1</span>, <span class="dv">2</span>), 
         <span class="dt">location =</span> <span class="kw">ifelse</span>(year <span class="op">==</span><span class="st"> </span><span class="dv">2015</span> <span class="op">&amp;</span><span class="st"> </span>country <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;United Kingdom&quot;</span>,<span class="st">&quot;Portugal&quot;</span>), location<span class="op">+</span><span class="fl">0.22</span>, location),
         <span class="dt">hjust =</span> <span class="kw">ifelse</span>(year <span class="op">==</span><span class="st"> </span><span class="dv">2010</span>, <span class="dv">1</span>, <span class="dv">0</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">year =</span> <span class="kw">as.factor</span>(year)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(year, life_expectancy, <span class="dt">group =</span> country)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">color =</span> country), <span class="dt">show.legend =</span> <span class="ot">FALSE</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_text</span>(<span class="kw">aes</span>(<span class="dt">x =</span> location, <span class="dt">label =</span> country, <span class="dt">hjust =</span> hjust), 
            <span class="dt">show.legend =</span> <span class="ot">FALSE</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">xlab</span>(<span class="st">&quot;&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">ylab</span>(<span class="st">&quot;Life Expectancy&quot;</span>)</code></pre></div>
<p><img src="book_files/figure-html/slope-plot-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>An advantage of the slope chart is that it permits us to quickly get an idea of changes based on the slope of the lines. Although we are using angle as the visual cue, we also have position to determine the exact values. Comparing the improvements is a bit harder with a scatter plot:</p>
<p><img src="book_files/figure-html/scatter-plot-instead-of-slope-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>In the scatter plot we have followed the principle <em>use common axes</em> since we are comparing these before and after. However, if we have many points, slope charts stop being useful as it becomes hard to see all the lines.</p>
</div>
<div id="bland-altman-plot" class="section level4">
<h4><span class="header-section-number">2.16.12.2</span> Bland-Altman plot</h4>
<p>Since we are primarily interested in the difference, it makes sense to dedicate one of our axes to it. The Bland-Altman plot, also know as the Tukey mean-difference plot and the MA-plot, shows the difference versus the average:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(ggrepel)
dat <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">   </span><span class="kw">mutate</span>(<span class="dt">year =</span> <span class="kw">paste0</span>(<span class="st">&quot;life_expectancy_&quot;</span>, year)) <span class="op">%&gt;%</span>
<span class="st">   </span><span class="kw">select</span>(country, year, life_expectancy) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">spread</span>(year, life_expectancy) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">average =</span> (life_expectancy_<span class="dv">2015</span> <span class="op">+</span><span class="st"> </span>life_expectancy_<span class="dv">2010</span>)<span class="op">/</span><span class="dv">2</span>,
         <span class="dt">difference =</span> life_expectancy_<span class="dv">2015</span> <span class="op">-</span><span class="st"> </span>life_expectancy_<span class="dv">2010</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(average, difference, <span class="dt">label =</span> country)) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_text_repel</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_abline</span>(<span class="dt">lty =</span> <span class="dv">2</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">xlab</span>(<span class="st">&quot;Average of 2010 and 2015&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">ylab</span>(<span class="st">&quot;Difference between 2015 and 2010&quot;</span>)</code></pre></div>
<p><img src="book_files/figure-html/bland-altman-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>Here, by simply looking at the y-axes, we quickly see which countries have shown the most improvement. We also get an idea of the overall value from the x-axis.</p>
</div>
</div>
<div id="encoding-a-third-variable" class="section level3">
<h3><span class="header-section-number">2.16.13</span> Encoding a third variable</h3>
<p>An earlier scatter plot showed the relationship between infant survival and average income. The following is a version of this plot that encodes three variables: OPEC membership, region, and population</p>
<p><img src="book_files/figure-html/encoding-third-variable-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>We encode categorical variables with color hue and shape. These shapes can be controlled with <code>shape</code> argument. Below are the shapes available for use in R. For the last five, the color goes inside.</p>
<p><img src="book_files/figure-html/available-shapes-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>For continuous variables we can use color, intensity or size. We now show an example of how we do this with a case study.</p>
<div id="case-study-vaccines" class="section level4">
<h4><span class="header-section-number">2.16.13.1</span> Case study: vaccines</h4>
<p>Vaccines have helped save millions of lives. In the 19th century, before herd immunization was achieved through vaccination programs, deaths from infectious diseases, such as smallpox and polio, were common. However, today, despite all the scientific evidence for their importance, vaccination programs have become somewhat controversial.</p>
<p>The controversy started with a <a href="http://www.thelancet.com/journals/lancet/article/PIIS0140-6736(97)11096-0/abstract">paper</a> published in 1988 and lead by <a href="https://en.wikipedia.org/wiki/Andrew_Wakefield">Andrew Wakefield</a> claiming there was a link between the administration of the measles, mumps and rubella (MMR) vaccine, and the appearance of autism and bowel disease. Despite much scientific evidence contradicting this finding, sensationalist media reports and fear mongering from conspiracy theorists led parts of the public into believing that vaccines were harmful. As a result, many parents ceased to vaccinate their children. This dangerous practice can be potentially disastrous given that the Center for Disease Control (CDC) estimates that vaccinations will prevent more than 21 million hospitalizations and 732,000 deaths among children born in the last 20 years (see <a href="https://www.cdc.gov/mmwr/preview/mmwrhtml/mm6316a4.htm">Benefits from Immunization during the Vaccines for Children Program Era — United States, 1994-2013, MMWR</a>). The 1988 paper has since been <a href="http://www.thelancet.com/journals/lancet/article/PIIS0140-6736(97)11096-0/abstract">retracted</a> and Andrew Wakefield was eventually “struck off the UK medical register, with a statement identifying deliberate falsification in the research published in The Lancet, and was thereby barred from practicing medicine in the UK.” (<a href="https://en.wikipedia.org/wiki/Andrew_Wakefield">source: Wikipedia</a>). Yet misconceptions persist, in part due to self-proclaimed activists who continue to disseminate misinformation about vaccines.</p>
<p>Effective communication of data is a strong antidote to misinformation and fear mongering. Earlier we showed an example provided by a <a href="http://graphics.wsj.com/infectious-diseases-and-vaccines/">Wall Street Journal article</a> showing data related to the impact of vaccines on battling infectious diseases. Here we reconstruct that example.</p>
<p>The data used for these plots were collected, organized and distributed by the <a href="http://www.tycho.pitt.edu/">Tycho Project</a>. They include weekly reported counts data for seven diseases from 1928 to 2011, from all fifty states. We include the yearly totals in the <code>dslabs</code> package:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">data</span>(us_contagious_diseases)
<span class="kw">str</span>(us_contagious_diseases)
<span class="co">#&gt; &#39;data.frame&#39;:    18870 obs. of  6 variables:</span>
<span class="co">#&gt;  $ disease        : Factor w/ 7 levels &quot;Hepatitis A&quot;,..: 1 1 1 1 1 1 1 1 1 1 ...</span>
<span class="co">#&gt;  $ state          : Factor w/ 51 levels &quot;Alabama&quot;,&quot;Alaska&quot;,..: 1 1 1 1 1 1 1 1 1 1 ...</span>
<span class="co">#&gt;  $ year           : num  1966 1967 1968 1969 1970 ...</span>
<span class="co">#&gt;  $ weeks_reporting: int  50 49 52 49 51 51 45 45 45 46 ...</span>
<span class="co">#&gt;  $ count          : num  321 291 314 380 413 378 342 467 244 286 ...</span>
<span class="co">#&gt;  $ population     : num  3345787 3364130 3386068 3412450 3444165 ...</span></code></pre></div>
<p>We create a temporary object <code>dat</code> that stores only the measles data, includes a per 100,000 rate, orders states by average value of disease and removes Alaska and Hawaii since they only became states in the late 50s. Note that there is a <code>weeks_reporting</code> column that tells us how many weeks reported cases. So we have to adjust for that when computing the rate.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">the_disease &lt;-<span class="st"> &quot;Measles&quot;</span>
dat &lt;-<span class="st"> </span>us_contagious_diseases <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span>state<span class="op">%in%</span><span class="kw">c</span>(<span class="st">&quot;Hawaii&quot;</span>,<span class="st">&quot;Alaska&quot;</span>) <span class="op">&amp;</span><span class="st"> </span>disease <span class="op">==</span><span class="st"> </span>the_disease) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">rate =</span> count <span class="op">/</span><span class="st"> </span>population <span class="op">*</span><span class="st"> </span><span class="dv">10000</span> <span class="op">*</span><span class="st"> </span><span class="dv">52</span> <span class="op">/</span><span class="st"> </span>weeks_reporting) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">state =</span> <span class="kw">reorder</span>(state, rate)) </code></pre></div>
<p>We can now easily plot disease rates per year. Here are the measles data from California:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dat <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(state <span class="op">==</span><span class="st"> &quot;California&quot;</span> <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw">is.na</span>(rate)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(year, rate)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_line</span>() <span class="op">+</span><span class="st"> </span><span class="kw">ylab</span>(<span class="st">&quot;Cases per 10,000&quot;</span>)  <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">geom_vline</span>(<span class="dt">xintercept=</span><span class="dv">1963</span>, <span class="dt">col =</span> <span class="st">&quot;blue&quot;</span>)</code></pre></div>
<p><img src="book_files/figure-html/california-measles-time-series-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>We add a vertical line at 1963 since this is when the vaccine was introduced [Control, Centers for Disease; Prevention (2014). CDC health information for international travel 2014 the yellow book. p. 250. ISBN 9780199948505].</p>
<p>Now, can we show data for all states in one plot? We have three variables to show: year, state and rate. In the WSJ figure, they use the x-axis for year, the y-axis for state and color hue to represent rates. However, the color scale they use, which goes from yellow to blue to green to orange to red can be improved.</p>
<p>When choosing colors to quantify a numeric variable, we chose between two options sequential and diverging.</p>
<p>Sequential colors are suited for data that goes from high to low. High values are clearly distinguished from low values. Here are some examples offered by the package <code>RColorBrewer</code></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(RColorBrewer)
<span class="kw">display.brewer.all</span>(<span class="dt">type=</span><span class="st">&quot;seq&quot;</span>)</code></pre></div>
<p><img src="book_files/figure-html/r-color-brewer-seq-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>Diverging colors are used to represent values that diverge from a center. We put equal emphasis on both ends of the data range: higher than the center and lower than the center. An example of when we would use a divergent pattern would be if we were to show height in standard deviations away from the average. Here are some examples of divergent patterns:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(RColorBrewer)
<span class="kw">display.brewer.all</span>(<span class="dt">type=</span><span class="st">&quot;div&quot;</span>)</code></pre></div>
<p><img src="book_files/figure-html/r-color-brewer-div-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>In our example we want to use a sequential palette since there is no meaningful center, just low and high rates.</p>
<p>We use the geometry <code>geom_tile</code> to tile the region with colors representing disease rates. We use a square root transformation to avoid having the really high counts dominate the plot. Notice that missing values are shown in grey. Once the disease was pretty much erradicated some states stopped reporting cases all together.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dat <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(year, state,  <span class="dt">fill =</span> rate)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_tile</span>(<span class="dt">color =</span> <span class="st">&quot;grey50&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="dt">expand=</span><span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>)) <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_fill_gradientn</span>(<span class="dt">colors =</span> <span class="kw">brewer.pal</span>(<span class="dv">9</span>, <span class="st">&quot;Reds&quot;</span>), <span class="dt">trans =</span> <span class="st">&quot;sqrt&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_vline</span>(<span class="dt">xintercept=</span><span class="dv">1963</span>, <span class="dt">col =</span> <span class="st">&quot;blue&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">theme_minimal</span>() <span class="op">+</span><span class="st">  </span><span class="kw">theme</span>(<span class="dt">panel.grid =</span> <span class="kw">element_blank</span>()) <span class="op">+</span>
<span class="st">  </span><span class="kw">ggtitle</span>(the_disease) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ylab</span>(<span class="st">&quot;&quot;</span>) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">xlab</span>(<span class="st">&quot;&quot;</span>)</code></pre></div>
<p><img src="book_files/figure-html/vaccines-plot-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>This plot makes a very striking argument for the contribution of vaccines. However, one limitation of this plot is that it uses color to represent quantity which we earlier explained makes it harder to know exactly how high it is going. Position and lengths are better cues. If we are willing to lose state information, we can make a version of the plot that shows the values with position. We can also show the average for the US which we compute like this:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">avg &lt;-<span class="st"> </span>us_contagious_diseases <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(disease<span class="op">==</span>the_disease) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(year) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarize</span>(<span class="dt">us_rate =</span> <span class="kw">sum</span>(count, <span class="dt">na.rm=</span><span class="ot">TRUE</span>)<span class="op">/</span><span class="kw">sum</span>(population, <span class="dt">na.rm=</span><span class="ot">TRUE</span>)<span class="op">*</span><span class="dv">10000</span>)</code></pre></div>
<p>Now to make the plot we simply use the <code>geom_line</code> geometry:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dat <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">ggplot</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(year, rate, <span class="dt">group =</span> state),  <span class="dt">color =</span> <span class="st">&quot;grey50&quot;</span>, 
            <span class="dt">show.legend =</span> <span class="ot">FALSE</span>, <span class="dt">alpha =</span> <span class="fl">0.2</span>, <span class="dt">size =</span> <span class="dv">1</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">mapping =</span> <span class="kw">aes</span>(year, us_rate),  <span class="dt">data =</span> avg, <span class="dt">size =</span> <span class="dv">1</span>, <span class="dt">color =</span> <span class="st">&quot;black&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">trans =</span> <span class="st">&quot;sqrt&quot;</span>, <span class="dt">breaks =</span> <span class="kw">c</span>(<span class="dv">5</span>,<span class="dv">25</span>,<span class="dv">125</span>,<span class="dv">300</span>)) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Cases per 10,000 by state&quot;</span>) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">xlab</span>(<span class="st">&quot;&quot;</span>) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ylab</span>(<span class="st">&quot;&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_text</span>(<span class="dt">data =</span> <span class="kw">data.frame</span>(<span class="dt">x=</span><span class="dv">1955</span>, <span class="dt">y=</span><span class="dv">50</span>), <span class="dt">mapping =</span> <span class="kw">aes</span>(x, y, <span class="dt">label=</span><span class="st">&quot;US average&quot;</span>), <span class="dt">color=</span><span class="st">&quot;black&quot;</span>) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">geom_vline</span>(<span class="dt">xintercept=</span><span class="dv">1963</span>, <span class="dt">col =</span> <span class="st">&quot;blue&quot;</span>) 
<span class="co">#&gt; Warning: Removed 180 rows containing missing values (geom_path).</span></code></pre></div>
<p><img src="book_files/figure-html/time-series-vaccines-plot-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>In theory we could use color to represent the categorical value state, but it is hard to pick 50 distinct colors.</p>
</div>
</div>
<div id="avoid-pseudo-three-dimensional-plots" class="section level3">
<h3><span class="header-section-number">2.16.14</span> Avoid pseudo three dimensional plots</h3>
<p>The figure below, taken from <a href="https://projecteuclid.org/download/pdf_1/euclid.ss/1177010488">the scientific literature</a> shows three variables: dose, drug type and survival. Although your screen/book page is flat and two dimensional, the plot tries to imitate three dimensions and assigned a dimension to each variable.</p>
<p><img src="dataviz/img/fig8b.png" width="70%" style="display: block; margin: auto;" /></p>
<p>Humans are not good at seeing in three dimensions (which explains why it is hard to parallel park) and our limitation is even worse with regard to pseudo-three-dimensions. To see this, try to determine the values of the survival variable in the plot above. Can you tell when the purple ribbon intersects the red one? This is an example in which we can easily use color to represent the categorical variable instead of using a pseude-3D:</p>
<div class="figure" style="text-align: center"><span id="fig:colors-for-different-lines"></span>
<img src="book_files/figure-html/colors-for-different-lines-1.png" alt="This plot demonstrates that using color is more than enough to distinguish the three lines." width="70%" />
<p class="caption">
Figure 2.13: This plot demonstrates that using color is more than enough to distinguish the three lines.
</p>
</div>
<p>Note how much easier it is to determine the survival values.</p>
</div>
<div id="avoid-gratuitous-three-dimensional-plots" class="section level3">
<h3><span class="header-section-number">2.16.15</span> Avoid gratuitous three dimensional plots</h3>
<p>Pseudo 3D is sometimes used completely gratuitously: plots are made to look 3D even when the 3rd dimension does not represent a quantity. This only adds confusion and makes it harder to relay your message. Here are two examples:</p>
<p><img src="dataviz/img/fig1e.png" width="70%" style="display: block; margin: auto;" /></p>
<p><img src="dataviz/img/fig2d.png" width="70%" style="display: block; margin: auto;" /></p>
<div id="avoid-too-many-significant-digits" class="section level4">
<h4><span class="header-section-number">2.16.15.1</span> Avoid too many significant digits</h4>
<p>By default, statistical software like R returns many significant digits. The default behavior in R is to show 7 significant digits. That many digits often adds no information, and the added the visual clutter can make it hard for the viewer to understand the message. As an example here are the per 10,000 disease rates for California across the five decades</p>
<table>
<thead>
<tr class="header">
<th align="left">state</th>
<th align="right">year</th>
<th align="right">Measles</th>
<th align="right">Pertussis</th>
<th align="right">Polio</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">California</td>
<td align="right">1940</td>
<td align="right">37.8826320</td>
<td align="right">18.3397861</td>
<td align="right">18.3397861</td>
</tr>
<tr class="even">
<td align="left">California</td>
<td align="right">1950</td>
<td align="right">13.9124205</td>
<td align="right">4.7467350</td>
<td align="right">4.7467350</td>
</tr>
<tr class="odd">
<td align="left">California</td>
<td align="right">1960</td>
<td align="right">14.1386471</td>
<td align="right">0.0000000</td>
<td align="right">0.0000000</td>
</tr>
<tr class="even">
<td align="left">California</td>
<td align="right">1970</td>
<td align="right">0.9767889</td>
<td align="right">0.0000000</td>
<td align="right">0.0000000</td>
</tr>
<tr class="odd">
<td align="left">California</td>
<td align="right">1980</td>
<td align="right">0.3743467</td>
<td align="right">0.0515466</td>
<td align="right">0.0515466</td>
</tr>
</tbody>
</table>
<p>We are reporting precision up to 0.00001 cases per 10,000, a very small value in the context of the changes that are occurring across the dates. In this case 2 significant figures is more than enough and clearly makes the point that rates are decreasing:</p>
<table>
<thead>
<tr class="header">
<th align="left">state</th>
<th align="right">year</th>
<th align="right">Measles</th>
<th align="right">Pertussis</th>
<th align="right">Polio</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">California</td>
<td align="right">1940</td>
<td align="right">37.9</td>
<td align="right">18.3</td>
<td align="right">18.3</td>
</tr>
<tr class="even">
<td align="left">California</td>
<td align="right">1950</td>
<td align="right">13.9</td>
<td align="right">4.7</td>
<td align="right">4.7</td>
</tr>
<tr class="odd">
<td align="left">California</td>
<td align="right">1960</td>
<td align="right">14.1</td>
<td align="right">0.0</td>
<td align="right">0.0</td>
</tr>
<tr class="even">
<td align="left">California</td>
<td align="right">1970</td>
<td align="right">1.0</td>
<td align="right">0.0</td>
<td align="right">0.0</td>
</tr>
<tr class="odd">
<td align="left">California</td>
<td align="right">1980</td>
<td align="right">0.4</td>
<td align="right">0.1</td>
<td align="right">0.1</td>
</tr>
</tbody>
</table>
<p>Useful ways to change the number of significant digits or to round numbers are <code>signif</code> and <code>round</code>. You can define the number of significant digits globally by setting options like this: <code>options(digits = 3)</code>.</p>
<p>Another principle, related to displaying tables, is to place values being compared on columns rather than rows. Note that our table above is easier to read than this one:</p>
<table>
<thead>
<tr class="header">
<th align="left">state</th>
<th align="left">disease</th>
<th align="right">1940</th>
<th align="right">1950</th>
<th align="right">1960</th>
<th align="right">1970</th>
<th align="right">1980</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">California</td>
<td align="left">Measles</td>
<td align="right">37.9</td>
<td align="right">13.9</td>
<td align="right">14.1</td>
<td align="right">1</td>
<td align="right">0.4</td>
</tr>
<tr class="even">
<td align="left">California</td>
<td align="left">Pertussis</td>
<td align="right">18.3</td>
<td align="right">4.7</td>
<td align="right">0.0</td>
<td align="right">0</td>
<td align="right">0.1</td>
</tr>
<tr class="odd">
<td align="left">California</td>
<td align="left">Polio</td>
<td align="right">18.3</td>
<td align="right">4.7</td>
<td align="right">0.0</td>
<td align="right">0</td>
<td align="right">0.1</td>
</tr>
<tr class="even">
<td align="left">### Know your</td>
<td align="left">audience</td>
<td align="right"></td>
<td align="right"></td>
<td align="right"></td>
<td align="right"></td>
<td align="right"></td>
</tr>
</tbody>
</table>
<p>Graphs can be used for our 1) own exploratory data analysis, 2) to convey a message to experts, or 3) to help tell a story to a general audience. Make sure that the intended audience understands each element of the plot.</p>
<p>As a simple example, consider that for your own exploration, it may be more useful to log-transform data and then plot it. However, for a general audience that is unfamiliar with converting logged values back to the original measurements, using a log-scale for the axis will be much easier to digest.</p>
</div>
</div>
<div id="further-reading" class="section level3">
<h3><span class="header-section-number">2.16.16</span> Further reading:</h3>
<ul>
<li>ER Tufte (1983) The visual display of quantitative information. Graphics Press.</li>
<li>ER Tufte (1990) Envisioning information. Graphics Press.</li>
<li>ER Tufte (1997) Visual explanations. Graphics Press.</li>
<li>WS Cleveland (1993) Visualizing data. Hobart Press.</li>
<li>WS Cleveland (1994) The elements of graphing data. CRC Press.</li>
<li>A Gelman, C Pasarica, R Dodhia (2002) Let’s practice what we preach: Turning tables into graphs. The American Statistician 56:121-130.</li>
<li>NB Robbins (2004) Creating more effective graphs. Wiley.</li>
<li><a href="http://bang.clearscience.info/?p=546">Nature Methods columns</a></li>
<li>A Cairo (2013) The Functional Art: An Introduction to Information Graphics and Visualization. New Riders</li>
<li>N Yau (2013) Data Points: Visualization That Means Something. Wiley</li>
</ul>
</div>
<div id="exercises-12" class="section level3 unnumbered">
<h3>Exercises</h3>
<p>For these exercises we will be using the vaccines data in the dslabs package:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(dslabs)
<span class="kw">data</span>(us_contagious_diseases)</code></pre></div>
<ol style="list-style-type: decimal">
<li><p>Pie charts are appropriate:</p>
<p>A. When we want to display percentages. B. When <code>ggplot2</code> is not available. C. When I am in a bakery. D. Never. Barplots and tables are always better.</p></li>
<li><p>What is the problem with the plot below:</p>
<p><img src="book_files/figure-html/baplot-not-from-zero-exercises-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>A. The values are wrong. The final vote was 306 to 232. B. The axis does not start at 0. Judging by the length, it appears Trump received 3 times as many votes when in fact it was about 30% more. C. The colors should be the same. D. Percentages should be shown as a pie chart.</p></li>
<li><p>Take a look at the following two plots. They show the same information: 1928 rates of Measles across the 50 states.</p>
<p><img src="book_files/figure-html/measels-exercise-1.png" width="70%" style="display: block; margin: auto;" /> Which plot is easier to read if you are interested in determining which are the best and worst states in terms of rates and why?</p>
<p>A. They provide the same information so they are both equally as good. B. The plot on the right is better because it orders the states alphabetically. C. The plot on the right is better because alphabetical order has nothing to do with the disease and by ordering according to actual rate, we quickly see the states with most and least rates. D. Both plots should be a pie chart.</p></li>
<li><p>To make the plot on the left, we have to reorder the levels of the states’ variables.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dat &lt;-<span class="st"> </span>us_contagious_diseases <span class="op">%&gt;%</span><span class="st">  </span>
<span class="st">  </span><span class="kw">filter</span>(year <span class="op">==</span><span class="st"> </span><span class="dv">1967</span> <span class="op">&amp;</span><span class="st"> </span>disease<span class="op">==</span><span class="st">&quot;Measles&quot;</span> <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw">is.na</span>(population)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">rate =</span> count <span class="op">/</span><span class="st"> </span>population <span class="op">*</span><span class="st"> </span><span class="dv">10000</span> <span class="op">*</span><span class="st"> </span><span class="dv">52</span> <span class="op">/</span><span class="st"> </span>weeks_reporting)</code></pre></div>
<p>Note what happens when we make a bar plot:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dat <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(state, rate)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_bar</span>(<span class="dt">stat=</span><span class="st">&quot;identity&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">coord_flip</span>() </code></pre></div>
<p><img src="book_files/figure-html/barplot-plot-exercise-example-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>Define these objects:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">state &lt;-<span class="st"> </span>dat<span class="op">$</span>state
rate &lt;-<span class="st"> </span>dat<span class="op">$</span>count<span class="op">/</span>dat<span class="op">$</span>population<span class="op">*</span><span class="dv">10000</span><span class="op">*</span><span class="dv">52</span><span class="op">/</span>dat<span class="op">$</span>weeks_reporting</code></pre></div>
<p>Redefine the <code>state</code> object so that the levels are re-ordered. Print the new object <code>state</code> and its levels so you can see that the vector is not re-ordered by the levels.</p></li>
<li><p>Now with one line of code, define the <code>dat</code> table as done above, but change the use mutate to create a rate variable and reorder state variable so that the levels are reordered by this variable. Then make a bar plot using the code above, but for this new dat.</p></li>
<li><p>Say we are interested in comparing gun homicide rates across regions of the US. We see this plot:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(dslabs)
<span class="kw">data</span>(<span class="st">&quot;murders&quot;</span>)
murders <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">rate =</span> total<span class="op">/</span>population<span class="op">*</span><span class="dv">100000</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(region) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarize</span>(<span class="dt">avg =</span> <span class="kw">mean</span>(rate)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">region =</span> <span class="kw">factor</span>(region)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(region, avg)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_bar</span>(<span class="dt">stat=</span><span class="st">&quot;identity&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">ylab</span>(<span class="st">&quot;Murder Rate Average&quot;</span>)</code></pre></div>
<p><img src="book_files/figure-html/us-murders-barplot-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>and decide to move to a state in the western region. What is the main problem with this interpretaion?</p>
<p>A. The categories are ordered alphabetically. B. The graph does not show standard errors. C. It does not show all the data. We do not see the variability within a region and it’s possible that the safest states are not in the West. D. The Northeast has the lowest average.</p>
<p><strong>Answer</strong> C</p></li>
<li><p>Make a box plot of the murder rates.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">data</span>(<span class="st">&quot;murders&quot;</span>)
murders <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">rate =</span> total<span class="op">/</span>population<span class="op">*</span><span class="dv">100000</span>)
<span class="co">#&gt;                   state abb        region population total   rate</span>
<span class="co">#&gt; 1               Alabama  AL         South    4779736   135  2.824</span>
<span class="co">#&gt; 2                Alaska  AK          West     710231    19  2.675</span>
<span class="co">#&gt; 3               Arizona  AZ          West    6392017   232  3.630</span>
<span class="co">#&gt; 4              Arkansas  AR         South    2915918    93  3.189</span>
<span class="co">#&gt; 5            California  CA          West   37253956  1257  3.374</span>
<span class="co">#&gt; 6              Colorado  CO          West    5029196    65  1.292</span>
<span class="co">#&gt; 7           Connecticut  CT     Northeast    3574097    97  2.714</span>
<span class="co">#&gt; 8              Delaware  DE         South     897934    38  4.232</span>
<span class="co">#&gt; 9  District of Columbia  DC         South     601723    99 16.453</span>
<span class="co">#&gt; 10              Florida  FL         South   19687653   669  3.398</span>
<span class="co">#&gt; 11              Georgia  GA         South    9920000   376  3.790</span>
<span class="co">#&gt; 12               Hawaii  HI          West    1360301     7  0.515</span>
<span class="co">#&gt; 13                Idaho  ID          West    1567582    12  0.766</span>
<span class="co">#&gt; 14             Illinois  IL North Central   12830632   364  2.837</span>
<span class="co">#&gt; 15              Indiana  IN North Central    6483802   142  2.190</span>
<span class="co">#&gt; 16                 Iowa  IA North Central    3046355    21  0.689</span>
<span class="co">#&gt; 17               Kansas  KS North Central    2853118    63  2.208</span>
<span class="co">#&gt; 18             Kentucky  KY         South    4339367   116  2.673</span>
<span class="co">#&gt; 19            Louisiana  LA         South    4533372   351  7.743</span>
<span class="co">#&gt; 20                Maine  ME     Northeast    1328361    11  0.828</span>
<span class="co">#&gt; 21             Maryland  MD         South    5773552   293  5.075</span>
<span class="co">#&gt; 22        Massachusetts  MA     Northeast    6547629   118  1.802</span>
<span class="co">#&gt; 23             Michigan  MI North Central    9883640   413  4.179</span>
<span class="co">#&gt; 24            Minnesota  MN North Central    5303925    53  0.999</span>
<span class="co">#&gt; 25          Mississippi  MS         South    2967297   120  4.044</span>
<span class="co">#&gt; 26             Missouri  MO North Central    5988927   321  5.360</span>
<span class="co">#&gt; 27              Montana  MT          West     989415    12  1.213</span>
<span class="co">#&gt; 28             Nebraska  NE North Central    1826341    32  1.752</span>
<span class="co">#&gt; 29               Nevada  NV          West    2700551    84  3.110</span>
<span class="co">#&gt; 30        New Hampshire  NH     Northeast    1316470     5  0.380</span>
<span class="co">#&gt; 31           New Jersey  NJ     Northeast    8791894   246  2.798</span>
<span class="co">#&gt; 32           New Mexico  NM          West    2059179    67  3.254</span>
<span class="co">#&gt; 33             New York  NY     Northeast   19378102   517  2.668</span>
<span class="co">#&gt; 34       North Carolina  NC         South    9535483   286  2.999</span>
<span class="co">#&gt; 35         North Dakota  ND North Central     672591     4  0.595</span>
<span class="co">#&gt; 36                 Ohio  OH North Central   11536504   310  2.687</span>
<span class="co">#&gt; 37             Oklahoma  OK         South    3751351   111  2.959</span>
<span class="co">#&gt; 38               Oregon  OR          West    3831074    36  0.940</span>
<span class="co">#&gt; 39         Pennsylvania  PA     Northeast   12702379   457  3.598</span>
<span class="co">#&gt; 40         Rhode Island  RI     Northeast    1052567    16  1.520</span>
<span class="co">#&gt; 41       South Carolina  SC         South    4625364   207  4.475</span>
<span class="co">#&gt; 42         South Dakota  SD North Central     814180     8  0.983</span>
<span class="co">#&gt; 43            Tennessee  TN         South    6346105   219  3.451</span>
<span class="co">#&gt; 44                Texas  TX         South   25145561   805  3.201</span>
<span class="co">#&gt; 45                 Utah  UT          West    2763885    22  0.796</span>
<span class="co">#&gt; 46              Vermont  VT     Northeast     625741     2  0.320</span>
<span class="co">#&gt; 47             Virginia  VA         South    8001024   250  3.125</span>
<span class="co">#&gt; 48           Washington  WA          West    6724540    93  1.383</span>
<span class="co">#&gt; 49        West Virginia  WV         South    1852994    27  1.457</span>
<span class="co">#&gt; 50            Wisconsin  WI North Central    5686986    97  1.706</span>
<span class="co">#&gt; 51              Wyoming  WY          West     563626     5  0.887</span></code></pre></div>
<p>by region, showing all the points and ordering the regions by their median rate.</p></li>
<li><p>The plots below shows the for three continuous variables.</p>
<p><img src="book_files/figure-html/pseudo-3d-exercise-1.png" width="70%" style="display: block; margin: auto;" /></p></li>
</ol>
<p>The line <span class="math inline">\(x=2\)</span> appears to separate the points. But it is actually not the case, which we can see by plotting the data in a couple of two dimensinal points.</p>
<p><img src="book_files/figure-html/pseud-3d-exercise-2-1.png" width="70%" style="display: block; margin: auto;" /><img src="book_files/figure-html/pseud-3d-exercise-2-2.png" width="70%" style="display: block; margin: auto;" /></p>
<p>Why is this happening? A. Humans are not good at reading pseudo 3D plots. B. There must be an error in the code C. The colors confuse us. D. Scatter plots should not be used to compare two variables when we have access to 3.</p>
<ol start="8" style="list-style-type: decimal">
<li><p>Reproduce the image plot we previously made but for Smallpox. For this plot do not include years in which cases were not reported in 10 or more weeks</p></li>
<li><p>Now reproduce the time series plot we previously made, but this time following the instructions of the previous question.</p></li>
<li><p>For the state of California, make a time series plots showing rates for all diseases. Include only years with 10 or more weeks reporting. Use a different color for each disease.</p></li>
<li><p>Now do the same for the rates for the US. Hint: compute the US rate by using summarize: the total dividec by total population.</p></li>
</ol>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="r-basics.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page"><i class="fa fa-angle-left"></i></a>

    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"weibo": false,
"instapper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:" && /^https?:/.test(script.src))
      script.src  = script.src.replace(/^https?:/, '');
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
